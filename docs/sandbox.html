<!DOCTYPE html>
<html lang="en" data-page="sandbox">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof — RPO v0.1 | Sandbox</title>

  <meta name="description" content="RPO v0.1 Sandbox — deterministic extraction: draft rpo.json + public sha256. No AI. No storage. Same input → same output." />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://rpo.openproof.net/sandbox.html" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@500;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-deep:#04040e;
      --bg-mid:#0b0f14;

      --gold-soft:#f1e6a3;
      --gold:#d4af37;
      --gold-deep:#8f7633;

      --ivory:#f7f3e8;
      --ink-soft:#b3a48b;
      --ink:#d8cfba;

      --radius:26px;
      --shadow-soft:0 26px 70px rgba(0,0,0,0.55);

      --panel:linear-gradient(145deg, rgba(10,12,27,0.97), rgba(5,7,18,0.98));
      --panel2:linear-gradient(180deg, rgba(10,12,27,0.55), rgba(5,7,18,0.70));
      --line:rgba(212,175,55,0.22);
      --line2:rgba(136,116,72,0.35);

      --cta1:#ffdfb0;
      --cta2:#f48b45;

      --ok:#46ff99;
      --warn:#ffb35a;
      --bad:#ff5a7a;

      --focus: 0 0 0 3px rgba(241,230,163,0.22), 0 0 0 1px rgba(212,175,55,0.35);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    body{
      min-height:100vh;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      color:var(--ivory);
      background:
        radial-gradient(circle at 10% -10%, rgba(241,230,163,0.25), transparent 55%),
        radial-gradient(circle at 90% 110%, rgba(241,230,163,0.18), transparent 55%),
        linear-gradient(180deg, #050712, #020208 60%, #050712 100%);
      overflow-x:hidden;
    }

    a{color:inherit}
    a:focus-visible, button:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible{
      outline:none; box-shadow: var(--focus); border-radius: 12px;
    }

    /* Background field */
    #bg-field{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:-1;
    }

    /* Top bar (same spirit as home) */
    .top-bar{
      position:fixed;
      top:0; left:0; right:0;
      height:68px;
      padding:0 40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:10;
      background:linear-gradient(to bottom, rgba(4,4,14,0.96), rgba(4,4,14,0.88), transparent);
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(212,175,55,0.22);
    }

    .top-left{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 280px;
    }

    .emblem{
      width:34px;
      height:34px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0, #f1e6a3, #d4af37 60%, #8f7633 100%);
      box-shadow:0 0 18px rgba(241,230,163,0.8);
      flex: 0 0 auto;
    }

    .brand{
      font-family:"Orbitron",sans-serif;
      font-size:0.72rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--ink-soft);
      white-space:nowrap;
    }
    .brand span{color:var(--gold-soft)}

    .top-nav{
      display:flex;
      gap:22px;
      font-size:0.86rem;
      color:var(--ink-soft);
      align-items:center;
      justify-content:center;
      flex: 1 1 auto;
    }
    .top-nav a{
      color:inherit;
      text-decoration:none;
      position:relative;
      padding-bottom:3px;
      white-space:nowrap;
    }
    .top-nav a::after{
      content:"";
      position:absolute;
      left:0; bottom:0;
      width:0; height:1px;
      background:linear-gradient(90deg,var(--gold-soft),var(--gold));
      transition:width .2s ease;
    }
    .top-nav a:hover::after{width:100%}
    .top-nav a[aria-current="page"]{
      color: var(--gold-soft);
    }
    .top-nav a[aria-current="page"]::after{width:100%}

    .top-cta{
      padding:8px 18px;
      border-radius:999px;
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, #ffdfb0, #f48b45);
      color:#2a1204;
      font-size:0.8rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-decoration:none;
      white-space:nowrap;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    /* Layout */
    main{
      padding:96px 40px 78px;
      min-height:100vh;
    }

    .shell{
      width:min(1240px, 92vw);
      margin:0 auto;
      position:relative;
    }

    /* One column content */
    .page-title{
      font-family:"Orbitron",sans-serif;
      font-size:.75rem;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:var(--ink-soft);
      margin-bottom:14px;
    }
    .page-title span{color:var(--gold-soft)}

    h1{
      font-family:"Orbitron",sans-serif;
      text-transform:uppercase;
      letter-spacing:.06em;
      line-height:1.08;
      font-size:clamp(2rem,4.2vw,3.05rem);
      margin-bottom:14px;
      max-width: 820px;
    }
    h1 .l2{display:block;color:var(--gold-soft)}
    h1 .l3{display:block;color:var(--gold)}

    .lead{
      max-width: 820px;
      font-size:1.02rem;
      line-height:1.75;
      color:rgba(179,164,139,.95);
      margin-bottom:18px;
    }

    .meta-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:18px;
      max-width: 820px;
    }
    .chip{
      display:inline-flex;
      gap:10px;
      align-items:center;
      font-size:.72rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(241,230,163,.35);
      background: rgba(10,12,27,0.35);
      backdrop-filter: blur(10px);
      color: rgba(241,230,163,.92);
      user-select:none;
    }
    .chip .dot{
      width:7px;height:7px;border-radius:99px;
      background: rgba(241,230,163,.9);
      box-shadow:0 0 12px rgba(241,230,163,.55);
    }

    .note{
      max-width: 820px;
      font-size:.92rem;
      line-height:1.6;
      color:rgba(198,186,150,.88);
      margin-bottom:22px;
    }

    /* Input panel */
    .input-panel{
      max-width: 820px;
      background: var(--panel);
      border-radius: var(--radius);
      border:1px solid rgba(212,175,55,0.45);
      box-shadow: var(--shadow-soft);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .input-panel::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:inherit;
      border:1px solid rgba(241,230,163,0.16);
      pointer-events:none;
    }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex; flex-direction:column; gap:7px;
    }
    .field.full{grid-column:1 / -1}
    label{
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
    }
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(212,175,55,0.25);
      background: rgba(7,8,20,0.55);
      color: rgba(247,243,232,0.92);
      padding:10px 12px;
      font-size:.96rem;
      outline:none;
      backdrop-filter: blur(10px);
    }
    textarea{
      min-height:150px;
      resize:vertical;
      line-height:1.6;
    }
    input::placeholder, textarea::placeholder{color: rgba(179,164,139,.68)}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(241,230,163,0.55);
      box-shadow:0 0 0 4px rgba(212,175,55,0.12);
    }

    .btn-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:14px;
    }
    .btn-primary{
      padding:12px 22px;
      border-radius:999px;
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, var(--cta1), var(--cta2));
      color:#2a1204;
      font-size:.8rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      text-decoration:none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      cursor:pointer;
    }
    .btn-ghost{
      padding:12px 18px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(10,12,27,0.35);
      color: var(--gold-soft);
      font-size:.8rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-decoration:none;
      backdrop-filter: blur(10px);
      cursor:pointer;
    }
    .fineprint{
      margin-top:12px;
      font-size:.86rem;
      line-height:1.6;
      color:rgba(179,164,139,.92);
      border-top:1px solid rgba(212,175,55,0.20);
      padding-top:12px;
    }

    /* Floating card (the star) */
    .float-wrap{
      position:absolute;
      top: 112px;
      right: 0;
      width: min(420px, 36vw);
      transform: translateX(12px);
    }

    .float{
      position: sticky;
      top: 92px;
      background: var(--panel);
      border-radius: var(--radius);
      border:1px solid rgba(212,175,55,0.45);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      isolation:isolate;
    }

    /* “alive” effect: sheen + subtle drift */
    .float::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 30% 10%, rgba(241,230,163,0.16), transparent 45%),
        linear-gradient(90deg, transparent 0%, rgba(241,230,163,0.10) 45%, transparent 60%);
      transform: rotate(18deg);
      animation: sheen 5.8s ease-in-out infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      z-index:0;
    }
    .float::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 0%, rgba(241,230,163,0.10), transparent 55%);
      opacity:.75;
      pointer-events:none;
      z-index:0;
    }
    @keyframes sheen{
      0%{ transform: translateX(-12%) rotate(18deg); opacity:.45 }
      50%{ transform: translateX(10%) rotate(18deg); opacity:.80 }
      100%{ transform: translateX(-12%) rotate(18deg); opacity:.45 }
    }

    .float-inner{
      position:relative;
      z-index:1;
      padding:18px 18px 16px;
    }

    .float-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .float-title{
      font-family:"Orbitron",sans-serif;
      font-size:.85rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(179,164,139,.95);
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid rgba(241,230,163,.30);
      background: rgba(10,12,27,0.35);
      padding:7px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(241,230,163,.92);
      user-select:none;
      white-space:nowrap;
    }
    .pulse{
      width:8px;height:8px;border-radius:99px;
      background: rgba(241,230,163,.85);
      box-shadow:0 0 16px rgba(241,230,163,.65);
      animation: pulse 1.4s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{transform:scale(1); opacity:.7}
      50%{transform:scale(1.35); opacity:1}
    }

    .steps{
      margin-top:10px;
      border-top:1px solid rgba(212,175,55,.22);
      padding-top:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .step{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.18);
      background: rgba(7,8,20,0.35);
      padding:10px 10px;
      min-height:52px;
    }
    .step .k{
      font-family:"Orbitron",sans-serif;
      font-size:.62rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .step .v{
      font-size:.92rem;
      color:rgba(247,243,232,.92);
      line-height:1.35;
      word-break:break-word;
    }

    .progress{
      margin-top:12px;
      border-top:1px solid rgba(212,175,55,.18);
      padding-top:12px;
      display:flex;
      align-items:center;
      gap:10px;
      color:rgba(179,164,139,.92);
      font-size:.78rem;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-family:"Orbitron",sans-serif;
    }
    .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background: rgba(241,230,163,.08);
      border:1px solid rgba(212,175,55,.20);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 14%;
      background: linear-gradient(90deg, rgba(241,230,163,.25), rgba(212,175,55,.65));
      border-radius:999px;
      transform: translateX(0);
      transition: width .45s ease;
    }
    .sync{
      opacity:.82;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(212,175,55,.25);
      background: rgba(10,12,27,0.35);
      color: rgba(241,230,163,.88);
      padding:8px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .tab[aria-selected="true"]{
      border-color: rgba(212,175,55,.55);
      background: rgba(7,8,20,0.70);
      color: var(--gold-soft);
    }

    .pane{
      margin-top:12px;
      border-top:1px solid rgba(212,175,55,.18);
      padding-top:12px;
      display:none;
    }
    .pane.active{display:block}

    .kv{
      display:flex;
      justify-content:space-between;
      gap:14px;
      padding:8px 0;
      color:rgba(179,164,139,.95);
      font-size:.9rem;
    }
    .kv + .kv{border-top:1px dashed var(--line2)}
    .kv .r{color:rgba(241,230,163,.90); text-align:right}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:.84rem;
      line-height:1.55;
      background: rgba(7,8,20,0.82);
      border:1px solid rgba(212,175,55,.22);
      border-radius:16px;
      padding:10px 10px;
      color:rgba(247,243,232,.90);
      max-height: 220px;
      overflow:auto;
      white-space:pre;
    }

    .mini-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn-mini{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(10,12,27,0.35);
      color: var(--gold-soft);
      font-size:.72rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }

    .verify-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .verify-grid label{margin-top:2px}
    .verify-result{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(212,175,55,.18);
      background: rgba(7,8,20,0.35);
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge-result{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.70rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid rgba(241,230,163,.25);
      color: rgba(241,230,163,.92);
      background: rgba(10,12,27,0.35);
      user-select:none;
      white-space:nowrap;
    }
    .badge-result.ok{border-color: rgba(70,255,153,.35); color: rgba(70,255,153,.95)}
    .badge-result.bad{border-color: rgba(255,90,122,.45); color: rgba(255,90,122,.95)}
    .badge-result.muted{opacity:.85}

    /* Keep content readable when float exists */
    .content-pad{
      padding-right: clamp(0px, 40vw, 460px);
    }

    /* Responsive */
    @media(max-width:1040px){
      .float-wrap{
        position:relative;
        width:100%;
        transform:none;
        margin-top:18px;
      }
      .float{position:relative; top:auto}
      .content-pad{padding-right:0}
    }

    @media(max-width:960px){
      .top-nav{display:none}
      .top-bar{padding:0 16px}
      main{padding:96px 20px 72px}
      .form-grid{grid-template-columns:1fr}
      .top-left{min-width:auto}
    }

    @media (prefers-reduced-motion: reduce){
      .float::before, .pulse{animation:none}
      .top-nav a::after{transition:none}
      .bar > i{transition:none}
    }

    /* Utility */
    .sr-only{
      position:absolute;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }
  </style>
</head>

<body>
  <canvas id="bg-field" aria-hidden="true"></canvas>

  <header class="top-bar">
    <div class="top-left">
      <div class="emblem" aria-hidden="true"></div>
      <div class="brand">OPENPROOF<span>.NET — RPO v0.1</span></div>
    </div>

    <nav class="top-nav" aria-label="Primary">
      <a href="./index.html" target="_blank" rel="noopener noreferrer">Home</a>
      <a href="./sandbox.html" aria-current="page">Sandbox</a>
      <a href="./how-it-works.html" target="_blank" rel="noopener noreferrer">How it works</a>
      <a href="./spec.html" target="_blank" rel="noopener noreferrer">Spec</a>
      <a href="./tests.html" target="_blank" rel="noopener noreferrer">Tests</a>
      <a href="./examples.html" target="_blank" rel="noopener noreferrer">Examples</a>
    </nav>

    <a href="#input" class="top-cta">Try the live demo</a>
  </header>

  <main>
    <div class="shell">
      <!-- ONE COLUMN content with right padding to make room for float -->
      <div class="content-pad">
        <div class="page-title">Live demo <span>for deterministic proof format</span></div>

        <h1>
          Sandbox,
          <span class="l2">from narrative to proof bundle.</span>
          <span class="l3">Same input → same output.</span>
        </h1>

        <p class="lead">
          Paste a short narrative (1–3 paragraphs). This sandbox generates a minimal RPO v0.1 draft:
          deterministic extraction, a public SHA256 integrity hash, and an exportable <span style="color:var(--gold-soft)">rpo.json</span>.
          It does not interpret, it does not store, and it does not “decide truth”.
        </p>

        <div class="meta-row" aria-label="Demo guarantees">
          <div class="chip"><span class="dot"></span> No AI</div>
          <div class="chip"><span class="dot"></span> Local only</div>
          <div class="chip"><span class="dot"></span> Deterministic</div>
          <div class="chip"><span class="dot"></span> Auditable output</div>
        </div>

        <p class="note">
          The public hash proves integrity, not truth. Humans remain accountable.
        </p>

        <section id="input" class="input-panel" aria-label="Narrative input">
          <div class="form-grid">
            <div class="field">
              <label for="context">Context</label>
              <select id="context">
                <option value="work" selected>Workplace</option>
                <option value="platform">Platform / moderation</option>
                <option value="institution">Institution / administration</option>
                <option value="family">Family / custody</option>
                <option value="cyber">Cyber / incident</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="field">
              <label for="caseTitle">Case title</label>
              <input id="caseTitle" type="text" placeholder="Example: Incident in Paris office — March 2024" />
            </div>

            <div class="field">
              <label for="issuer">Issuer</label>
              <input id="issuer" type="text" placeholder="Example: Internal audit team, Company X" />
            </div>

            <div class="field">
              <label for="subject">Subject</label>
              <input id="subject" type="text" placeholder="Example: Employee — Sales department" />
            </div>

            <div class="field full">
              <label for="narrative">Narrative</label>
              <textarea id="narrative" placeholder="Paste 1–3 paragraphs here (anonymize names/dates if needed)..."></textarea>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="generateBtn" type="button">Generate RPO bundle</button>
            <button class="btn-ghost" id="loadExampleBtn" type="button">Load example</button>
            <button class="btn-ghost" id="resetBtn" type="button">Reset</button>
          </div>

          <div class="fineprint">
            No account, no storage. Refreshing clears everything.
            Deterministic rules only: same input → same output.
          </div>
        </section>
      </div>

      <!-- FLOATING CARD -->
      <div class="float-wrap" aria-label="Live proof bundle">
        <aside class="float">
          <div class="float-inner">
            <div class="float-head">
              <div class="float-title">Live Proof Bundle</div>
              <div class="status" id="statusPill"><span class="pulse" aria-hidden="true"></span><span id="statusText">READY</span></div>
            </div>

            <div class="steps" aria-label="RPO steps">
              <div class="step" id="step1">
                <div class="k"><span>Input</span><span id="s1">—</span></div>
                <div class="v" id="vInput">Awaiting text</div>
              </div>
              <div class="step" id="step2">
                <div class="k"><span>Extract</span><span id="s2">—</span></div>
                <div class="v" id="vExtract">Signals / anchors</div>
              </div>
              <div class="step" id="step3">
                <div class="k"><span>Seal</span><span id="s3">—</span></div>
                <div class="v" id="vSeal">Public hash</div>
              </div>
            </div>

            <div class="progress" aria-label="Sync status">
              <span id="readyLabel">READY</span>
              <div class="bar" aria-hidden="true"><i id="barFill"></i></div>
              <span class="sync" id="syncLabel">SYNC</span>
            </div>

            <div class="tabs" role="tablist" aria-label="Bundle tabs">
              <button class="tab" role="tab" aria-selected="true" id="tabBundle" aria-controls="paneBundle">Bundle</button>
              <button class="tab" role="tab" aria-selected="false" id="tabJson" aria-controls="paneJson">JSON</button>
              <button class="tab" role="tab" aria-selected="false" id="tabVerify" aria-controls="paneVerify">Verify</button>
            </div>

            <!-- PANE: Bundle -->
            <div class="pane active" id="paneBundle" role="tabpanel" aria-labelledby="tabBundle">
              <div class="kv"><span>Phrases</span><span class="r" id="mPhrases">—</span></div>
              <div class="kv"><span>Signals</span><span class="r" id="mSignals">—</span></div>
              <div class="kv"><span>Dates detected</span><span class="r" id="mDates">—</span></div>
              <div class="kv"><span>Places detected</span><span class="r" id="mPlaces">—</span></div>
              <div class="kv"><span>Structure score</span><span class="r" id="mStructure">—</span></div>

              <div class="kv" style="margin-top:10px; border-top:1px solid rgba(212,175,55,.18); padding-top:10px">
                <span>Public hash (sha256)</span>
                <span class="r" id="mHash" style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">—</span>
              </div>

              <div class="mini-actions">
                <button class="btn-mini" id="copyHashBtn" type="button">Copy hash</button>
                <button class="btn-mini" id="copyJsonBtn" type="button">Copy JSON</button>
                <button class="btn-mini" id="downloadJsonBtn" type="button">Download rpo.json</button>
              </div>

              <div style="margin-top:10px; color:rgba(179,164,139,.92); font-size:.86rem; line-height:1.55">
                RPO = signed JSON + human-readable PDF + public hash.
                This sandbox illustrates the format; it does not sign and does not store.
              </div>
            </div>

            <!-- PANE: JSON -->
            <div class="pane" id="paneJson" role="tabpanel" aria-labelledby="tabJson">
              <div style="color:rgba(179,164,139,.92); font-size:.86rem; line-height:1.55; margin-bottom:10px">
                Draft bundle (deterministic). Exportable and verifiable via hash.
              </div>
              <pre class="mono" id="jsonOut">{}</pre>
            </div>

            <!-- PANE: Verify -->
            <div class="pane" id="paneVerify" role="tabpanel" aria-labelledby="tabVerify">
              <div style="color:rgba(179,164,139,.92); font-size:.86rem; line-height:1.55; margin-bottom:10px">
                Paste a JSON payload and a hash. We recompute SHA256 and compare.
              </div>

              <div class="verify-grid">
                <label for="verifyPayload">Payload (JSON or text)</label>
                <textarea id="verifyPayload" style="min-height:120px" placeholder="Paste the JSON (or a stable payload) here..."></textarea>

                <label for="verifyHash">Expected sha256</label>
                <input id="verifyHash" type="text" placeholder="Paste the expected hash..." />

                <div class="mini-actions">
                  <button class="btn-mini" id="verifyBtn" type="button">Verify</button>
                  <button class="btn-mini" id="useLastBtn" type="button">Use last bundle</button>
                </div>

                <div class="verify-result" aria-label="Verify result">
                  <span class="badge-result muted" id="verifyBadge">NO CHECK YET</span>
                  <span style="color:rgba(179,164,139,.92); font-size:.86rem" id="verifyMsg">—</span>
                </div>
              </div>
            </div>

          </div>
        </aside>
      </div>

    </div>
  </main>

  <script>
    /* =========================================================
       Background field (starfield) — visual only
       ========================================================= */
    (function () {
      const canvas = document.getElementById("bg-field");
      const ctx = canvas.getContext("2d", { alpha: true });

      let width, height, particles = [];
      const COUNT = 220;

      function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        const ratio = window.devicePixelRatio || 1;

        canvas.width = width * ratio;
        canvas.height = height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      }

      function createParticle() {
        return {
          x: (Math.random() * 2 - 1),
          y: (Math.random() * 2 - 1),
          z: Math.random() * 0.9 + 0.1,
          speed: Math.random() * 0.004 + 0.0015
        };
      }

      function init() {
        particles = [];
        for (let i = 0; i < COUNT; i++) particles.push(createParticle());
      }

      function project(p) {
        const f = 400;
        const s = f / (f * p.z);
        return {
          x: p.x * width * 0.5 * s + width / 2,
          y: p.y * height * 0.5 * s + height / 2
        };
      }

      function loop() {
        ctx.clearRect(0, 0, width, height);

        // soft nebula
        const grad = ctx.createRadialGradient(
          width * 0.5, height * 0.18, 0,
          width * 0.5, height * 0.18, width * 0.65
        );
        grad.addColorStop(0, "rgba(241,230,163,0.18)");
        grad.addColorStop(0.42, "rgba(241,230,163,0.04)");
        grad.addColorStop(1, "transparent");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, width, height);

        for (const p of particles) {
          p.z -= p.speed;
          if (p.z < 0.08) {
            Object.assign(p, createParticle());
            p.z = 1;
          }

          const { x, y } = project(p);
          const a = Math.min(1, (1.2 - p.z) * 1.1);

          ctx.fillStyle = `rgba(241,230,163,${0.55 * a})`;
          ctx.beginPath();
          ctx.arc(x, y, 1.6, 0, Math.PI * 2);
          ctx.fill();
        }

        requestAnimationFrame(loop);
      }

      window.addEventListener("resize", resize);
      resize(); init(); loop();
    })();

    /* =========================================================
       Deterministic sandbox logic (no AI)
       ========================================================= */
    const $ = (id) => document.getElementById(id);

    const EXAMPLE = {
      context: "work",
      caseTitle: "Incident in Paris office — March 2024",
      issuer: "Internal audit team, Company X",
      subject: "Employee — Sales department",
      narrative:
`On 14 March 2024, around 10:30 am, an argument broke out in the Paris office between a line manager and a sales employee.
Several colleagues report that the manager raised his voice, threatened to remove key accounts from the employee, and asked him to leave the open space immediately.
Later that day, around 3 pm, the same manager sent an email copying HR, questioning the employee’s “loyalty” and suggesting he should be excluded from client meetings.
No formal warning or prior evaluation had been communicated before this incident.`
    };

    const PLACE_HINTS = [
      "paris","london","berlin","madrid","rome","brussels","tokyo","new york",
      "office","workplace","headquarters","hq","meeting room","open space","home","court","police","school"
    ];

    const ACTION_HINTS = [
      "asked","told","sent","emailed","copied","cc","called","removed","blocked","excluded","reported","threatened","demanded"
    ];

    const SIGNAL_RULES = [
      { words:["threaten","threatened","coerce","coercion","intimidat","ultimatum","blackmail"], tag:"threats" },
      { words:["account","accounts","bonus","salary","pay","budget","expense","resources","remove key"], tag:"economic" },
      { words:["do not contact","stop talking","forbidden to speak","blocked","muted","silenced","email copying","cc hr","copying hr","excluded from meetings"], tag:"comms" },
      { words:["leave the open space","leave immediately","confined","isolated","kept apart","no access"], tag:"isolation" },
      { words:["humiliate","ridicule","shame","insult","raised his voice","yelled","harassed","bully","hostile"], tag:"harassment" },
      { words:["surveillance","recorded","tracked","spy","monitor","cctv","camera","screenshots","keylogger"], tag:"privacy" },
    ];

    function splitSentences(text){
      return text
        .replace(/\r/g,"")
        .split(/(?<=[\.\!\?])\s+(?=[A-Z0-9])/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function detectDates(text){
      const hits = new Set();
      const re = [
        /\b\d{4}-\d{2}-\d{2}\b/g,
        /\b\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\s+\d{4}\b/gi,
        /\b(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},\s+\d{4}\b/gi,
        /\b\d{1,2}\/\d{1,2}\/\d{2,4}\b/g,
        /\b\d{1,2}:\d{2}\b/g,
        /\b(am|pm)\b/gi
      ];
      re.forEach(r=>{
        const m = text.match(r);
        if (m) m.forEach(x => hits.add(x.trim()));
      });
      return Array.from(hits).slice(0, 8);
    }

    function detectPlaces(text){
      const t = text.toLowerCase();
      const hits = new Set();
      PLACE_HINTS.forEach(p=>{
        if (t.includes(p)) hits.add(p);
      });
      return Array.from(hits).slice(0, 8);
    }

    function detectSignals(sentences){
      const found = [];
      const lowerSent = sentences.map(s => s.toLowerCase());

      SIGNAL_RULES.forEach(rule=>{
        for (let i=0;i<lowerSent.length;i++){
          const s = lowerSent[i];
          const hit = rule.words.find(w => s.includes(w));
          if (hit){
            found.push({ tag: rule.tag, sentenceIndex: i, matched: hit });
          }
        }
      });

      // dedupe by tag+sentenceIndex
      const uniq = new Map();
      found.forEach(f=>{
        const k = f.tag + "::" + f.sentenceIndex;
        if (!uniq.has(k)) uniq.set(k, f);
      });
      return Array.from(uniq.values());
    }

    function computeStructureScore(sentences, dates, places, signals, text){
      const t = text.toLowerCase();
      const hasDate = dates.length > 0 ? 1 : 0;
      const hasPlace = places.length > 0 ? 1 : 0;

      let actions = 0;
      ACTION_HINTS.forEach(a=>{
        if (t.includes(a)) actions++;
      });
      const actionScore = Math.min(1, actions / 4);

      const sCount = sentences.length;
      const sScore = sCount >= 3 ? 1 : (sCount === 2 ? 0.7 : 0.4);

      const sigScore = Math.min(1, signals.length / 4);

      const raw = (0.22*hasDate + 0.18*hasPlace + 0.22*actionScore + 0.18*sScore + 0.20*sigScore);
      return Math.round(100 * raw);
    }

    function safeText(v){ return (v || "").toString().trim(); }
    function nowISO(){ return new Date().toISOString(); }

    async function sha256Hex(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function buildHashPayload(input, analysis){
      // stable ordering for deterministic hashing
      return JSON.stringify({
        v: "0.1",
        context: input.context,
        caseTitle: input.caseTitle,
        issuer: input.issuer,
        subject: input.subject,
        narrative: input.narrative,
        signals: analysis.signals
          .map(s=>({tag:s.tag, i:s.sentenceIndex, m:s.matched}))
          .sort((a,b)=> (a.tag+a.i+a.m).localeCompare(b.tag+b.i+b.m)),
        dates: analysis.dates.slice().sort(),
        places: analysis.places.slice().sort(),
        structure_score: analysis.structure_score
      });
    }

    function buildRpoDraft(input, analysis){
      const bundleId = "rpo-" + analysis.public_hash.slice(0, 12);
      return {
        rpo_version: "0.1",
        bundle_id: bundleId,
        created_at: nowISO(),
        issuer: { label: input.issuer || "—" },
        subject: { label: input.subject || "—" },
        case: {
          title: input.caseTitle || "—",
          context: input.context || "other"
        },
        inputs: {
          narrative: input.narrative,
          notes: "Deterministic sandbox extraction. No AI. Not legal advice."
        },
        extraction: {
          phrases: analysis.phrases,
          dates_detected: analysis.dates,
          places_detected: analysis.places,
          signals: analysis.signals.map(s => ({
            tag: s.tag,
            sentence_index: s.sentenceIndex
          }))
        },
        scores: {
          structure_score: analysis.structure_score
        },
        integrity: {
          public_hash_sha256: analysis.public_hash,
          statement: "Hash proves integrity, not truth."
        }
      };
    }

    /* =========================================================
       UI: floating card orchestration
       ========================================================= */
    function setStatus(state){
      const statusText = $("statusText");
      const bar = $("barFill");
      const ready = $("readyLabel");
      const sync = $("syncLabel");

      if (state === "READY"){
        statusText.textContent = "READY";
        bar.style.width = "14%";
        ready.textContent = "READY";
        sync.textContent = "SYNC";
        $("s1").textContent = "—";
        $("s2").textContent = "—";
        $("s3").textContent = "—";
        $("vInput").textContent = "Awaiting text";
        $("vExtract").textContent = "Signals / anchors";
        $("vSeal").textContent = "Public hash";
        return;
      }

      if (state === "EXTRACTING"){
        statusText.textContent = "EXTRACTING";
        bar.style.width = "56%";
        ready.textContent = "READY";
        sync.textContent = "SYNC";
        $("s1").textContent = "OK";
        $("s2").textContent = "RUN";
        $("s3").textContent = "—";
        return;
      }

      if (state === "SEALED"){
        statusText.textContent = "SEALED";
        bar.style.width = "100%";
        ready.textContent = "READY";
        sync.textContent = "SYNC";
        $("s1").textContent = "OK";
        $("s2").textContent = "OK";
        $("s3").textContent = "OK";
        return;
      }
    }

    function setMetrics(m){
      $("mPhrases").textContent = m.phrases ?? "—";
      $("mSignals").textContent = m.signals ?? "—";
      $("mDates").textContent = m.dates ?? "—";
      $("mPlaces").textContent = m.places ?? "—";
      $("mStructure").textContent = (typeof m.structure === "number" ? (m.structure + " %") : "—");
      $("mHash").textContent = m.hash || "—";
    }

    function setJson(obj){
      $("jsonOut").textContent = JSON.stringify(obj || {}, null, 2);
    }

    function setVerifyBadge(type, msg){
      const badge = $("verifyBadge");
      const text = $("verifyMsg");

      badge.className = "badge-result " + (type || "muted");
      if (type === "ok") badge.textContent = "MATCH";
      else if (type === "bad") badge.textContent = "MISMATCH";
      else badge.textContent = "NO CHECK YET";

      text.textContent = msg || "—";
    }

    function selectTab(which){
      const tabs = [
        {btn: $("tabBundle"), pane: $("paneBundle")},
        {btn: $("tabJson"), pane: $("paneJson")},
        {btn: $("tabVerify"), pane: $("paneVerify")}
      ];
      tabs.forEach(t=>{
        const active = (t.btn.id === which);
        t.btn.setAttribute("aria-selected", active ? "true" : "false");
        t.pane.classList.toggle("active", active);
      });
    }

    $("tabBundle").addEventListener("click", ()=>selectTab("tabBundle"));
    $("tabJson").addEventListener("click", ()=>selectTab("tabJson"));
    $("tabVerify").addEventListener("click", ()=>selectTab("tabVerify"));

    /* =========================================================
       Actions
       ========================================================= */
    function resetAll(){
      $("context").value = "work";
      $("caseTitle").value = "";
      $("issuer").value = "";
      $("subject").value = "";
      $("narrative").value = "";

      setStatus("READY");
      setMetrics({phrases:"—",signals:"—",dates:"—",places:"—",structure:null,hash:"—"});
      setJson({});
      window.__LAST__ = null;

      setVerifyBadge("muted","—");
      $("verifyPayload").value = "";
      $("verifyHash").value = "";
    }

    $("resetBtn").addEventListener("click", resetAll);

    $("loadExampleBtn").addEventListener("click", ()=>{
      $("context").value = EXAMPLE.context;
      $("caseTitle").value = EXAMPLE.caseTitle;
      $("issuer").value = EXAMPLE.issuer;
      $("subject").value = EXAMPLE.subject;
      $("narrative").value = EXAMPLE.narrative;
    });

    $("generateBtn").addEventListener("click", async ()=>{
      const input = {
        context: safeText($("context").value),
        caseTitle: safeText($("caseTitle").value),
        issuer: safeText($("issuer").value),
        subject: safeText($("subject").value),
        narrative: safeText($("narrative").value)
      };

      if (!input.narrative || input.narrative.length < 20){
        alert("Please paste a short narrative first (at least a few sentences).");
        return;
      }

      // Step 1: input
      setStatus("EXTRACTING");
      $("vInput").textContent = (input.caseTitle || "Untitled case").slice(0, 42) + ((input.caseTitle || "").length > 42 ? "…" : "");
      await new Promise(r=>setTimeout(r, 220));

      const sentences = splitSentences(input.narrative);
      const dates = detectDates(input.narrative);
      const places = detectPlaces(input.narrative);
      const signals = detectSignals(sentences);
      const structure_score = computeStructureScore(sentences, dates, places, signals, input.narrative);

      $("vExtract").textContent = `${signals.length} signals, ${dates.length} dates, ${places.length} places`;

      const analysis = {
        phrases: sentences.length,
        dates,
        places,
        signals,
        structure_score
      };

      // Stable hash payload (same input -> same hash)
      const payload = buildHashPayload(input, analysis);
      const public_hash = await sha256Hex(payload);

      $("vSeal").textContent = public_hash.slice(0, 12) + "…" + public_hash.slice(-8);

      const draft = buildRpoDraft(input, {
        ...analysis,
        public_hash
      });

      window.__LAST__ = { input, analysis, payload, public_hash, draft };

      setStatus("SEALED");
      setMetrics({
        phrases: analysis.phrases,
        signals: analysis.signals.length,
        dates: analysis.dates.length,
        places: analysis.places.length,
        structure: analysis.structure_score,
        hash: public_hash
      });
      setJson(draft);

      // auto-open bundle tab (feels like "sealed")
      selectTab("tabBundle");
    });

    $("copyHashBtn").addEventListener("click", async ()=>{
      const last = window.__LAST__;
      if (!last) { alert("Nothing yet. Generate a bundle first."); return; }
      try{
        await navigator.clipboard.writeText(last.public_hash);
        alert("Hash copied.");
      }catch(e){
        alert("Clipboard blocked by browser. Copy manually from the card.");
      }
    });

    $("copyJsonBtn").addEventListener("click", async ()=>{
      const last = window.__LAST__;
      if (!last) { alert("Nothing yet. Generate a bundle first."); return; }
      try{
        await navigator.clipboard.writeText(JSON.stringify(last.draft, null, 2));
        alert("JSON copied.");
      }catch(e){
        alert("Clipboard blocked by browser. Copy manually from the JSON tab.");
      }
    });

    $("downloadJsonBtn").addEventListener("click", ()=>{
      const last = window.__LAST__;
      if (!last) { alert("Nothing yet. Generate a bundle first."); return; }
      const blob = new Blob([JSON.stringify(last.draft, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rpo.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    $("useLastBtn").addEventListener("click", ()=>{
      const last = window.__LAST__;
      if (!last){ alert("No bundle yet."); return; }
      $("verifyPayload").value = last.payload;
      $("verifyHash").value = last.public_hash;
      setVerifyBadge("muted","Loaded last bundle payload + hash.");
    });

    $("verifyBtn").addEventListener("click", async ()=>{
      const payload = safeText($("verifyPayload").value);
      const expected = safeText($("verifyHash").value).toLowerCase();

      if (!payload || payload.length < 4){
        setVerifyBadge("bad","Missing payload.");
        return;
      }
      if (!expected || expected.length < 32){
        setVerifyBadge("bad","Missing or invalid expected hash.");
        return;
      }

      const got = await sha256Hex(payload);
      if (got === expected){
        setVerifyBadge("ok","Integrity verified: sha256(payload) matches expected hash.");
      }else{
        setVerifyBadge("bad",`Mismatch. Computed: ${got.slice(0,12)}…${got.slice(-8)}`);
      }
    });

    // init
    resetAll();
  </script>
</body>
</html>
