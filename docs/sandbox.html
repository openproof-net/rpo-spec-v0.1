<!DOCTYPE html>
<html lang="fr" data-page="sandbox">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof — RPO v0.1 | Sandbox Décision RH</title>
  <meta name="description" content="Sandbox RPO : transformer un contexte de décision RH en bundle probatoire déterministe (JSON + hash public). Pas d’IA. Pas de stockage. Vérifiable par audit." />
  <meta name="robots" content="index, follow" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@500;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#04040E;
      --bg1:#0b0f14;
      --ivory:#FBF8F1;
      --ivory2:#F7F3E8;
      --gold0:#f1e6a3;
      --gold1:#d4af37;
      --gold2:#8f7633;
      --line: rgba(241,230,163,0.22);
      --line2: rgba(241,230,163,0.14);
      --glass: rgba(11,15,20,0.55);
      --glass2: rgba(11,15,20,0.40);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius: 22px;
      --radius2: 16px;
      --title: "Orbitron", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --body: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      --ok: rgba(127, 221, 170, 0.85);
      --warn: rgba(241, 230, 163, 0.95);
      --bad: rgba(255, 120, 120, 0.85);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      color: var(--ivory);
      font-family: var(--body);
      overflow-x:hidden;
      background:
        radial-gradient(1400px 700px at 50% 0%, rgba(241,230,163,0.12), transparent 60%),
        radial-gradient(1000px 600px at 20% 40%, rgba(212,175,55,0.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Subtle starfield */
    #bgField{
      position:fixed; inset:0; z-index:0; pointer-events:none; opacity:0.9;
    }

    a{ color: inherit; text-decoration:none; }
    .muted{ opacity:0.78; }
    .small{ font-size: 12px; opacity:0.82; }
    .kicker{
      font-family: var(--title);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 11px;
      opacity:0.78;
    }

    /* Top nav */
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(4,4,14,0.86), rgba(4,4,14,0.38));
      border-bottom: 1px solid var(--line2);
    }
    .topInner{
      max-width: 1560px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-family: var(--title);
      letter-spacing: 0.08em;
      font-size: 12px;
      opacity: 0.92;
      white-space:nowrap;
    }
    .dot{
      width:18px;height:18px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--gold0), var(--gold1));
      box-shadow: 0 0 18px rgba(241,230,163,0.28);
      flex: 0 0 auto;
    }
    .nav{
      display:flex;
      gap: 14px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:center;
    }
    .nav a{
      font-size: 12px;
      opacity: 0.80;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .nav a:hover{ opacity: 0.95; border-color: rgba(241,230,163,0.16); background: rgba(11,15,20,0.25); }
    .nav a.active{ opacity: 1; border-color: rgba(241,230,163,0.26); background: rgba(11,15,20,0.30); }

    .cta{
      display:flex; align-items:center; gap:10px;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.22);
      background: radial-gradient(140px 60px at 30% 30%, rgba(241,230,163,0.20), rgba(11,15,20,0.25));
      box-shadow: 0 10px 30px rgba(0,0,0,0.28);
      font-family: var(--title);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 11px;
      opacity: 0.95;
      white-space:nowrap;
    }
    .cta:hover{ border-color: rgba(241,230,163,0.36); opacity: 1; }

    /* Layout */
    .page{
      position:relative; z-index:1;
      max-width: 1560px;
      margin: 0 auto;
      padding: 28px 18px 70px;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      align-items:start;
      margin: 10px 0 18px;
    }
    .heroLeft{
      padding: 18px 4px;
    }
    .heroTitle{
      font-family: var(--title);
      font-size: clamp(32px, 4.0vw, 56px);
      line-height: 1.02;
      margin: 10px 0 10px;
      letter-spacing: 0.02em;
    }
    .heroTitle .gold{ color: var(--gold0); }
    .heroSub{
      max-width: 72ch;
      font-size: 14px;
      line-height: 1.6;
      opacity: 0.86;
    }
    .chips{
      display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px;
    }
    .chip{
      font-size: 11px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(11,15,20,0.32);
      opacity: 0.90;
      white-space:nowrap;
    }

    .heroRight{
      display:flex;
      justify-content:flex-end;
    }

    /* Panels */
    .panel{
      border-radius: var(--radius);
      border: 1px solid rgba(241,230,163,0.18);
      background: linear-gradient(180deg, rgba(11,15,20,0.60), rgba(11,15,20,0.36));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(800px 260px at 30% 0%, rgba(241,230,163,0.06), transparent 62%);
      pointer-events:none;
    }
    .panelHeader{
      padding: 16px 18px 12px;
      border-bottom: 1px solid rgba(241,230,163,0.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      position:relative; z-index:1;
    }
    .panelHeader h3{
      margin:0;
      font-family: var(--title);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      opacity: 0.9;
    }
    .panelBody{
      padding: 16px 18px 18px;
      position:relative; z-index:1;
    }

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 18px;
      align-items:start;
      margin-top: 10px;
    }

    /* Form */
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .field{
      display:flex; flex-direction:column; gap: 6px;
      min-width: 0;
    }
    label{
      font-size: 11px;
      opacity: 0.78;
      letter-spacing: 0.10em;
      font-family: var(--title);
      text-transform: uppercase;
    }
    input, select, textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(241,230,163,0.16);
      background: rgba(4,4,14,0.45);
      color: var(--ivory);
      padding: 10px 11px;
      outline: none;
      font-family: var(--body);
      font-size: 13px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(241,230,163,0.34);
      box-shadow: 0 0 0 3px rgba(241,230,163,0.07);
    }

    .sourceGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }
    .checkCard{
      border-radius: 16px;
      border: 1px solid rgba(241,230,163,0.14);
      background: rgba(11,15,20,0.26);
      padding: 10px 10px;
      display:flex; gap:10px; align-items:flex-start;
      min-height: 72px;
    }
    .checkCard input{ width:auto; margin-top: 3px; }
    .checkCard .t{
      font-size: 12px;
      font-weight: 600;
      opacity: 0.92;
      margin:0 0 2px;
    }
    .checkCard .d{
      font-size: 11px;
      opacity: 0.70;
      line-height: 1.35;
      margin:0;
    }

    /* Actions */
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(11,15,20,0.28);
      color: var(--ivory);
      font-size: 12px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-family: var(--title);
      cursor:pointer;
      opacity: 0.92;
    }
    .btn:hover{ opacity: 1; border-color: rgba(241,230,163,0.34); }
    .btn.primary{
      background: radial-gradient(180px 80px at 30% 30%, rgba(241,230,163,0.26), rgba(11,15,20,0.24));
      border-color: rgba(241,230,163,0.28);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(241,230,163,0.14);
      opacity: 0.82;
    }

    /* Output */
    .statusPills{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.16);
      background: rgba(11,15,20,0.25);
      font-size: 11px;
      opacity: 0.90;
      white-space:nowrap;
    }
    .pill strong{ font-family: var(--title); letter-spacing:0.08em; font-size: 10px; opacity:0.9; }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(241,230,163,0.14);
    }
    .kv:last-child{ border-bottom: none; }
    .k{ font-size: 12px; opacity: 0.72; }
    .v{ font-size: 12px; opacity: 0.92; text-align:right; }

    .meter{
      margin-top: 10px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.16);
      background: rgba(4,4,14,0.40);
      height: 10px;
      overflow:hidden;
    }
    .meter > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(241,230,163,0.75), rgba(212,175,55,0.75));
      box-shadow: 0 0 20px rgba(241,230,163,0.18);
      transition: width 200ms ease;
    }

    .bundleBox{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(241,230,163,0.14);
      background: rgba(11,15,20,0.22);
      padding: 12px;
    }
    pre{
      margin: 0;
      max-height: 260px;
      overflow:auto;
      font-size: 11px;
      line-height: 1.45;
      opacity: 0.92;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .hashLine{
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      opacity: 0.90;
    }
    .hashLine .tag{
      font-family: var(--title);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 10px;
      opacity: 0.78;
      margin-right: 6px;
    }

    .warnBox{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(241,230,163,0.14);
      background: rgba(4,4,14,0.32);
      font-size: 12px;
      opacity: 0.86;
      line-height: 1.5;
    }

    /* Footer note */
    .footerNote{
      margin-top: 14px;
      font-size: 12px;
      opacity: 0.72;
      line-height: 1.5;
    }
    .footerNote strong{ color: var(--gold0); }

    /* Responsive */
    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
      .heroRight{ justify-content:flex-start; }
      .grid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 1fr; }
      .kv{ grid-template-columns: 1fr; }
      .v{ text-align:left; }
      .statusPills{ justify-content:flex-start; }
      .sourceGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <canvas id="bgField"></canvas>

  <header class="top">
    <div class="topInner">
      <div class="brand" title="OpenProof — RPO v0.1">
        <span class="dot"></span>
        OPENPROOF.NET — RPO v0.1
      </div>

      <nav class="nav" aria-label="Navigation">
        <a href="./index.html">Home</a>
        <a class="active" href="./sandbox.html">Bac à sable</a>
        <a href="./how-it-works.html">Comment ça marche</a>
        <a href="./spec.html">Spéc.</a>
        <a href="./tests.html">Tests</a>
        <a href="./examples.html">Exemples</a>
      </nav>

      <a class="cta" href="./sandbox.html">
        Essayez la démo en direct
      </a>
    </div>
  </header>

  <main class="page">
    <section class="hero">
      <div class="heroLeft">
        <div class="kicker">Démonstration déterministe — décision RH opposable</div>
        <h1 class="heroTitle">
          Sandbox,<br/>
          <span class="gold">des données RH</span> à la<br/>
          décision justifiée.
        </h1>
        <p class="heroSub">
          Ici, on ne “choisit” pas un candidat. On produit un <strong>artefact de gouvernance</strong> :
          périmètre, sources, règles, hypothèses, et un <strong>hash public</strong> pour prouver l’intégrité.
          <strong>Pas d’IA.</strong> <strong>Pas de stockage.</strong> Même entrée ⇒ même bundle.
        </p>

        <div class="chips" role="list" aria-label="Propriétés">
          <span class="chip" role="listitem">Pas d’IA</span>
          <span class="chip" role="listitem">Pas de stockage</span>
          <span class="chip" role="listitem">Déterministe</span>
          <span class="chip" role="listitem">Audit-ready</span>
          <span class="chip" role="listitem">Hash SHA-256 public</span>
        </div>
      </div>

      <div class="heroRight">
        <div class="panel" style="min-width:min(520px, 100%);">
          <div class="panelHeader">
            <h3>Preview bundle (30 secondes)</h3>
            <div class="statusPills">
              <span class="pill"><strong>INTEGRITY</strong> · hash public</span>
              <span class="pill"><strong>READABILITY</strong> · JSON lisible</span>
              <span class="pill"><strong>VERIFIABILITY</strong> · reproductible</span>
            </div>
          </div>
          <div class="panelBody">
            <div class="kv">
              <div class="k">Input</div>
              <div class="v">contexte décisionnel + sources déclarées</div>
            </div>
            <div class="kv">
              <div class="k">Output</div>
              <div class="v">decision_bundle.json + hash sha256</div>
            </div>
            <div class="kv">
              <div class="k">Usage</div>
              <div class="v">audit · litige · gouvernance</div>
            </div>
            <div class="meter" aria-label="Meter demo">
              <div id="heroMeter"></div>
            </div>
            <div class="footerNote">
              <strong>Point clé :</strong> la gouvernance ne consiste pas à “avoir raison”.
              Elle consiste à <strong>rendre des comptes</strong>.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid" aria-label="Sandbox">
      <!-- INPUT -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Ensemble d’entrée</h3>
          <div class="statusPills">
            <span class="pill">Scope · sources · responsabilité</span>
          </div>
        </div>

        <div class="panelBody">
          <div class="row">
            <div class="field">
              <label for="scenario">Type de décision</label>
              <select id="scenario">
                <option value="nomination_dg">Nomination / succession (niveau CODIR)</option>
                <option value="role_sensible">Affectation rôle sensible (sécurité / export-control)</option>
                <option value="mobilite_internationale">Mobilité internationale (pays / conformité)</option>
                <option value="reorga_critique">Réorganisation critique (risque social / continuité)</option>
                <option value="sanction">Sanction / séparation (risque juridique)</option>
              </select>
            </div>

            <div class="field">
              <label for="decisionDate">Date de décision (moment T)</label>
              <input id="decisionDate" type="date" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="orgScope">Organisation / périmètre</label>
              <input id="orgScope" type="text" placeholder="Ex : MBDA — France / multi-sites / multi-entités" />
            </div>
            <div class="field">
              <label for="decisionOwner">Responsable de la décision</label>
              <input id="decisionOwner" type="text" placeholder="Ex : DG / Comité exécutif / DRH Groupe" />
            </div>
          </div>

          <div class="field" style="margin-top:4px;">
            <label>Sources déclarées (ce qui était réellement disponible)</label>
            <div class="sourceGrid">
              <div class="checkCard">
                <input id="src_lms" type="checkbox" checked />
                <div>
                  <p class="t">LMS / Dossiers formation</p>
                  <p class="d">Formations, certifications, attestations documentées.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_hris" type="checkbox" checked />
                <div>
                  <p class="t">SIRH / Historique professionnel</p>
                  <p class="d">Rôles, ancienneté, mobilités, changements de grade.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_perf" type="checkbox" checked />
                <div>
                  <p class="t">Évaluations de performance</p>
                  <p class="d">Objectifs, revues annuelles, éléments formels.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_ops" type="checkbox" checked />
                <div>
                  <p class="t">Résultats opérationnels</p>
                  <p class="d">Indicateurs attestés, éléments traçables.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_mob" type="checkbox" />
                <div>
                  <p class="t">Mobilité & exposition</p>
                  <p class="d">Portée internationale, exposition au P&L, preuves.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_360" type="checkbox" />
                <div>
                  <p class="t">360 / retours d’information</p>
                  <p class="d">Uniquement si documenté et attribuable.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_security" type="checkbox" />
                <div>
                  <p class="t">Sécurité / habilitations</p>
                  <p class="d">Habilitation, export-control, restrictions d’accès.</p>
                </div>
              </div>

              <div class="checkCard">
                <input id="src_legal" type="checkbox" />
                <div>
                  <p class="t">Juridique / conformité</p>
                  <p class="d">Avertissements, contentieux, éléments opposables.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="field">
              <label for="knownMissing">Données manquantes connues (absence = donnée)</label>
              <textarea id="knownMissing" placeholder="Ex : leadership en crise non documenté ; 360 non comparable ; KPI ops non attestés pour tous."></textarea>
            </div>
            <div class="field">
              <label for="constraints">Contraintes (facultatif)</label>
              <textarea id="constraints" placeholder="Ex : urgence continuité ; climat social sensible ; exigences export-control ; calendrier audit."></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnGenerate">Générer le bundle</button>
            <button class="btn" id="btnExample">Exemple MBDA-like</button>
            <button class="btn ghost" id="btnReset">Réinitialiser</button>
          </div>

          <div class="footerNote">
            <strong>Rappel :</strong> aucune donnée n’est envoyée. Aucun stockage local.
            Le bundle est calculé <strong>dans ton navigateur</strong>.
          </div>
        </div>
      </div>

      <!-- OUTPUT -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Rapport de préparation à la décision</h3>
          <div class="statusPills">
            <span class="pill" id="pillDef">DEFENSIBILITY · —</span>
            <span class="pill" id="pillCov">COVERAGE · —</span>
            <span class="pill" id="pillMiss">MISSING · —</span>
          </div>
        </div>

        <div class="panelBody">
          <div class="kv">
            <div class="k">Capture (moment T)</div>
            <div class="v" id="outCapture">—</div>
          </div>
          <div class="kv">
            <div class="k">Évaluation (déterministe)</div>
            <div class="v" id="outEval">—</div>
          </div>
          <div class="kv">
            <div class="k">Scellement</div>
            <div class="v" id="outSeal">—</div>
          </div>

          <div class="meter" aria-label="Coverage meter">
            <div id="covMeter"></div>
          </div>

          <div class="warnBox" id="outSummary">
            Génère un bundle pour obtenir : couverture, données manquantes, niveau de défendabilité, hash public.
          </div>

          <div class="actions">
            <button class="btn" id="btnCopyHash" disabled>Copier le hachage</button>
            <button class="btn" id="btnCopyJson" disabled>Copier le JSON</button>
            <button class="btn primary" id="btnDownload" disabled>Télécharger decision_bundle.json</button>
          </div>

          <div class="hashLine">
            <span class="tag">hash (sha-256)</span>
            <span id="hashText">—</span>
          </div>

          <div class="bundleBox">
            <pre id="jsonPreview">{}</pre>
          </div>

          <div class="footerNote">
            Ce rapport porte sur la <strong>justification</strong> (périmètre/sources/règles), pas sur “le vrai”.
            L’intégrité est vérifiable via le hash.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Background starfield (subtle) ----------
    (function starfield(){
      const c = document.getElementById("bgField");
      const ctx = c.getContext("2d", { alpha: true });
      let w=0,h=0,pts=[];
      function resize(){
        w = c.width = Math.floor(window.innerWidth * devicePixelRatio);
        h = c.height = Math.floor(window.innerHeight * devicePixelRatio);
        c.style.width = window.innerWidth+"px";
        c.style.height = window.innerHeight+"px";
        pts = [];
        const n = Math.floor((window.innerWidth * window.innerHeight) / 18000);
        for(let i=0;i<n;i++){
          pts.push({
            x: Math.random()*w,
            y: Math.random()*h,
            r: (Math.random()*1.2 + 0.3) * devicePixelRatio,
            a: Math.random()*0.5 + 0.15
          });
        }
      }
      function draw(){
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = "rgba(241,230,163,0.55)";
        for(const p of pts){
          ctx.globalAlpha = p.a;
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(draw);
      }
      window.addEventListener("resize", resize);
      resize(); draw();
    })();

    // Hero meter animation
    (function(){
      const el = document.getElementById("heroMeter");
      let t = 0;
      setInterval(()=> {
        t = (t + 1) % 120;
        const v = 52 + Math.round(35 * Math.sin(t/18));
        el.style.width = v + "%";
      }, 120);
    })();

    // ---------- Deterministic helpers ----------
    function nowISO(){
      // "moment T" should be the provided decisionDate; generation timestamp is still included
      return new Date().toISOString();
    }

    function normalizeText(s){
      return (s || "").trim().replace(/\s+/g, " ");
    }

    // stable stringify with sorted keys (deterministic)
    function stableStringify(obj){
      const seen = new WeakSet();
      const sorter = (value) => {
        if(value && typeof value === "object"){
          if(seen.has(value)) return value; // avoid cycles (shouldn't happen)
          seen.add(value);

          if(Array.isArray(value)) return value.map(sorter);

          const keys = Object.keys(value).sort();
          const out = {};
          for(const k of keys) out[k] = sorter(value[k]);
          return out;
        }
        return value;
      };
      return JSON.stringify(sorter(obj), null, 2);
    }

    async function sha256Hex(text){
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const hash = await crypto.subtle.digest("SHA-256", data);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // ---------- Scoring (simple, explainable, deterministic) ----------
    function computeCoverage(sources){
      const keys = Object.keys(sources);
      const total = keys.length;
      const selected = keys.filter(k => sources[k]).length;
      // weight: security/legal matter more in regulated contexts
      const weights = {
        src_lms: 1.0,
        src_hris: 1.0,
        src_perf: 1.0,
        src_ops: 1.0,
        src_mob: 1.1,
        src_360: 0.9,
        src_security: 1.4,
        src_legal: 1.2
      };
      let wTotal = 0, wSel = 0;
      for(const k of keys){
        const w = weights[k] ?? 1.0;
        wTotal += w;
        if(sources[k]) wSel += w;
      }
      const pct = Math.round((wSel / wTotal) * 100);
      return { pct, selected, total, wSel: +wSel.toFixed(2), wTotal: +wTotal.toFixed(2) };
    }

    function computeMissingCount(knownMissingText){
      const t = normalizeText(knownMissingText);
      if(!t) return 0;
      // naive split on separators: ; or line breaks
      const parts = t.split(/[\n;]+/).map(s => normalizeText(s)).filter(Boolean);
      return parts.length;
    }

    function scenarioRiskMultiplier(scenario){
      switch(scenario){
        case "role_sensible": return 1.25;
        case "nomination_dg": return 1.20;
        case "mobilite_internationale": return 1.15;
        case "reorga_critique": return 1.10;
        case "sanction": return 1.20;
        default: return 1.0;
      }
    }

    function computeDefensibility({coveragePct, missingCount, sources, scenario}){
      // Base score from coverage; penalties for missing, bonuses for security/legal presence
      let score = coveragePct;

      // Missing data penalty (bigger for high-stakes scenario)
      const mult = scenarioRiskMultiplier(scenario);
      score -= Math.round(missingCount * 6 * mult);

      // Bonuses for regulated artefacts
      if(sources.src_security) score += 6;
      if(sources.src_legal) score += 4;

      // 360 is weak if alone; small bonus if present
      if(sources.src_360) score += 1;

      score = clamp(score, 0, 100);

      // Bucket
      let level = "LOW";
      if(score >= 82) level = "HIGH";
      else if(score >= 62) level = "MEDIUM";

      // Risk tag for executives
      let risk = "HIGH";
      if(level === "HIGH") risk = "LOW";
      else if(level === "MEDIUM") risk = "MEDIUM";

      return { score, level, risk };
    }

    function buildDeterministicBundle(input){
      const coverage = computeCoverage(input.sources);
      const missingCount = computeMissingCount(input.knownMissing);

      const def = computeDefensibility({
        coveragePct: coverage.pct,
        missingCount,
        sources: input.sources,
        scenario: input.scenario
      });

      // Deterministic explanations (human-readable, audit-friendly)
      const rationale = [];
      rationale.push(`Coverage computed from declared sources (weighted).`);
      if(missingCount > 0) rationale.push(`Known missing data items reduce defensibility (absence = data).`);
      if(input.sources.src_security) rationale.push(`Security/clearance artefacts increase audit strength in regulated contexts.`);
      if(input.sources.src_legal) rationale.push(`Legal/compliance artefacts increase opposability and boundary clarity.`);
      rationale.push(`No AI. No storage. Same input => same output.`);

      return {
        standard: "OpenProof RPO v0.1",
        bundle_type: "HR_DECISION_DEFENSIBILITY",
        deterministic: true,
        no_ai: true,
        no_storage: true,
        generated_at: nowISO(),
        decision_moment_t: input.decisionDate || null,
        decision: {
          scenario: input.scenario,
          org_scope: input.orgScope,
          decision_owner: input.decisionOwner
        },
        declared_sources: input.sources,
        known_missing_data: normalizeText(input.knownMissing),
        constraints: normalizeText(input.constraints),
        metrics: {
          coverage_pct: coverage.pct,
          sources_selected: coverage.selected,
          sources_total: coverage.total,
          missing_items_count: missingCount,
          defensibility_score: def.score,
          defensibility_level: def.level,
          executive_risk: def.risk
        },
        rationale
      };
    }

    // ---------- UI wiring ----------
    const el = (id) => document.getElementById(id);

    const scenario = el("scenario");
    const decisionDate = el("decisionDate");
    const orgScope = el("orgScope");
    const decisionOwner = el("decisionOwner");

    const srcIds = ["src_lms","src_hris","src_perf","src_ops","src_mob","src_360","src_security","src_legal"];
    const knownMissing = el("knownMissing");
    const constraints = el("constraints");

    const btnGenerate = el("btnGenerate");
    const btnExample = el("btnExample");
    const btnReset = el("btnReset");

    const pillDef = el("pillDef");
    const pillCov = el("pillCov");
    const pillMiss = el("pillMiss");

    const outCapture = el("outCapture");
    const outEval = el("outEval");
    const outSeal = el("outSeal");
    const outSummary = el("outSummary");

    const covMeter = el("covMeter");
    const hashText = el("hashText");
    const jsonPreview = el("jsonPreview");

    const btnCopyHash = el("btnCopyHash");
    const btnCopyJson = el("btnCopyJson");
    const btnDownload = el("btnDownload");

    let lastBundle = null;
    let lastBundleString = "";
    let lastHash = "";

    function collectInput(){
      const sources = {};
      for(const id of srcIds) sources[id] = !!el(id).checked;

      return {
        scenario: scenario.value,
        decisionDate: decisionDate.value || "",
        orgScope: normalizeText(orgScope.value),
        decisionOwner: normalizeText(decisionOwner.value),
        sources,
        knownMissing: knownMissing.value || "",
        constraints: constraints.value || ""
      };
    }

    function setDefPill(level){
      pillDef.textContent = `DEFENSIBILITY · ${level}`;
      let col = "rgba(241,230,163,0.16)";
      if(level === "HIGH") col = "rgba(127,221,170,0.22)";
      if(level === "MEDIUM") col = "rgba(241,230,163,0.18)";
      if(level === "LOW") col = "rgba(255,120,120,0.18)";
      pillDef.style.borderColor = col;
      pillDef.style.background = "rgba(11,15,20,0.25)";
    }

    function enableOutputs(enabled){
      btnCopyHash.disabled = !enabled;
      btnCopyJson.disabled = !enabled;
      btnDownload.disabled = !enabled;
    }

    async function generate(){
      const input = collectInput();

      // Minimal required fields for credibility
      if(!input.orgScope || !input.decisionOwner || !input.decisionDate){
        outSummary.innerHTML = `⚠️ Renseigne au minimum <strong>périmètre</strong>, <strong>responsable</strong> et <strong>date (moment T)</strong>.`;
        enableOutputs(false);
        return;
      }

      const bundle = buildDeterministicBundle(input);
      const bundleStr = stableStringify(bundle);
      const hash = await sha256Hex(bundleStr);

      // Seal
      bundle.integrity = {
        hash_alg: "SHA-256",
        public_hash: hash
      };

      // Re-stringify after adding integrity (still deterministic)
      const finalStr = stableStringify(bundle);
      const finalHash = await sha256Hex(finalStr); // should match the same "final" structure
      bundle.integrity.public_hash = finalHash;
      const finalFinalStr = stableStringify(bundle);

      lastBundle = bundle;
      lastBundleString = finalFinalStr;
      lastHash = finalHash;

      // UI
      const cov = bundle.metrics.coverage_pct;
      const miss = bundle.metrics.missing_items_count;
      const lvl = bundle.metrics.defensibility_level;

      setDefPill(lvl);
      pillCov.textContent = `COVERAGE · ${cov}%`;
      pillMiss.textContent = `MISSING · ${miss}`;

      outCapture.textContent = input.decisionDate;
      outEval.textContent = `Score ${bundle.metrics.defensibility_score}/100 · Risk ${bundle.metrics.executive_risk}`;
      outSeal.textContent = `SHA-256 sealed`;

      covMeter.style.width = cov + "%";
      hashText.textContent = finalHash;
      jsonPreview.textContent = finalFinalStr;

      outSummary.innerHTML = [
        `<strong>Décision :</strong> ${scenario.options[scenario.selectedIndex].text}`,
        `<strong>Couverture :</strong> ${cov}% · <strong>Manquants connus :</strong> ${miss}`,
        `<strong>Défendabilité :</strong> ${lvl} · <strong>Risque DG :</strong> ${bundle.metrics.executive_risk}`,
        `<span class="muted">Lecture probatoire : périmètre + sources + règles implicites ⇒ audit & contestation.</span>`
      ].join("<br/>");

      enableOutputs(true);
    }

    function loadExample(){
      // “MBDA-like” scenario: sensitive / regulated
      scenario.value = "role_sensible";
      decisionDate.value = "2026-01-28";
      orgScope.value = "MBDA — France scope (multi-sites, multi-entités)";
      decisionOwner.value = "CEO / Executive committee";

      el("src_lms").checked = true;
      el("src_hris").checked = true;
      el("src_perf").checked = true;
      el("src_ops").checked = true;
      el("src_mob").checked = true;
      el("src_360").checked = false;
      el("src_security").checked = true;
      el("src_legal").checked = true;

      knownMissing.value = "Comparable ops KPIs not attested for all candidates; documented crisis leadership evidence missing; 360 feedback not attributable.";
      constraints.value = "Urgency: business continuity. Export-control constraints. Audit trail required. Decision may be contested.";

      // Generate immediately for “demo impact”
      generate();
    }

    function resetAll(){
      scenario.value = "nomination_dg";
      decisionDate.value = "";
      orgScope.value = "";
      decisionOwner.value = "";
      for(const id of srcIds) el(id).checked = (id !== "src_mob" && id !== "src_360" && id !== "src_security" && id !== "src_legal");
      knownMissing.value = "";
      constraints.value = "";

      lastBundle = null;
      lastBundleString = "";
      lastHash = "";

      pillDef.textContent = "DEFENSIBILITY · —";
      pillCov.textContent = "COVERAGE · —";
      pillMiss.textContent = "MISSING · —";

      outCapture.textContent = "—";
      outEval.textContent = "—";
      outSeal.textContent = "—";

      covMeter.style.width = "0%";
      hashText.textContent = "—";
      jsonPreview.textContent = "{}";

      outSummary.textContent = "Génère un bundle pour obtenir : couverture, données manquantes, niveau de défendabilité, hash public.";
      enableOutputs(false);
    }

    async function copyText(txt){
      await navigator.clipboard.writeText(txt);
    }

    function downloadJson(filename, content){
      const blob = new Blob([content], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Events
    btnGenerate.addEventListener("click", generate);
    btnExample.addEventListener("click", loadExample);
    btnReset.addEventListener("click", resetAll);

    btnCopyHash.addEventListener("click", async ()=>{
      if(!lastHash) return;
      await copyText(lastHash);
      btnCopyHash.textContent = "Copié ✓";
      setTimeout(()=> btnCopyHash.textContent = "Copier le hachage", 900);
    });

    btnCopyJson.addEventListener("click", async ()=>{
      if(!lastBundleString) return;
      await copyText(lastBundleString);
      btnCopyJson.textContent = "Copié ✓";
      setTimeout(()=> btnCopyJson.textContent = "Copier le JSON", 900);
    });

    btnDownload.addEventListener("click", ()=>{
      if(!lastBundleString) return;
      downloadJson("decision_bundle.json", lastBundleString);
    });

    // Init
    resetAll();
  </script>
</body>
</html>

