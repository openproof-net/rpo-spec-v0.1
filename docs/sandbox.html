<!DOCTYPE html>
<html lang="en" data-page="sandbox">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof — RPO v0.1 | HR Decision Sandbox</title>

  <meta name="description" content="HR Decision Sandbox — deterministic decision defensibility bundle: coverage, missing data, risks, hypotheses, public sha256, exportable decision_bundle.json. No AI. No storage." />
  <meta name="robots" content="index, follow" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@500;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#04040E;
      --bg1:#0b0f14;
      --ivory:#FBF8F1;
      --ivory2:#F7F3E8;
      --gold0:#f1e6a3;
      --gold1:#d4af37;
      --gold2:#8f7633;
      --line: rgba(241,230,163,0.22);
      --glass: rgba(11,15,20,0.55);
      --glass2: rgba(11,15,20,0.42);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius: 22px;
      --radius2: 16px;
      --font-title: "Orbitron", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --font-body: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1400px 700px at 50% 0%, rgba(241,230,163,0.12), transparent 60%),
                  radial-gradient(1000px 600px at 25% 45%, rgba(212,175,55,0.08), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--ivory);
      font-family: var(--font-body);
      overflow-x:hidden;
    }

    /* canvas bg */
    #bg-field{
      position:fixed;
      inset:0;
      z-index:0;
      opacity:0.9;
      pointer-events:none;
    }

    /* top nav (minimal) */
    .top{
      position:sticky;
      top:0;
      z-index:5;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(4,4,14,0.86), rgba(4,4,14,0.38));
      border-bottom: 1px solid rgba(241,230,163,0.14);
    }
    .top-inner{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-family: var(--font-title);
      letter-spacing: 0.08em;
      font-size: 12px;
      opacity: 0.9;
    }
    .dot{
      width:18px;height:18px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--gold0), var(--gold1));
      box-shadow: 0 0 18px rgba(241,230,163,0.28);
    }
    .nav{
      display:flex; gap:18px; align-items:center;
      font-size: 12px; opacity:0.85;
    }
    .nav a{
      color: var(--ivory2);
      text-decoration:none;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .nav a[aria-current="page"]{
      border-color: rgba(241,230,163,0.24);
      background: rgba(241,230,163,0.06);
    }
    .cta{
      font-family: var(--font-title);
      font-size: 12px;
      letter-spacing: 0.08em;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.26);
      background: linear-gradient(180deg, rgba(241,230,163,0.20), rgba(241,230,163,0.08));
      color: var(--ivory);
      text-decoration:none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      white-space:nowrap;
    }

    /* main layout */
    .wrap{
      position:relative;
      z-index:1;
      max-width: 1280px;
      margin: 0 auto;
      padding: 26px 18px 44px;
    }

    .hero{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }

    .kicker{
      font-family: var(--font-title);
      font-size: 12px;
      letter-spacing: 0.16em;
      opacity: 0.75;
      text-transform: uppercase;
    }

    .h1{
      font-family: var(--font-title);
      font-size: clamp(34px, 4.2vw, 54px);
      line-height: 1.05;
      letter-spacing: 0.02em;
      margin: 0;
    }
    .h1 .gold{ color: var(--gold0); }
    .subline{
      margin-top: 8px;
      max-width: 78ch;
      color: rgba(251,248,241,0.78);
      font-size: 14px;
      line-height: 1.55;
    }

    .chips{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(11,15,20,0.35);
      font-family: var(--font-title);
      font-size: 11px;
      letter-spacing: 0.10em;
      opacity: 0.9;
    }
    .chip i{
      width:8px;height:8px;border-radius:50%;
      background: rgba(241,230,163,0.70);
      box-shadow: 0 0 10px rgba(241,230,163,0.25);
    }

    /* ✅ 50/50 panels */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      align-items: start;
      margin-top: 18px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(11,15,20,0.62), rgba(11,15,20,0.38));
      border: 1px solid rgba(241,230,163,0.18);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 720px; /* gives both sides same “weight” */
    }
    .panel-inner{ padding: 16px; }

    .panel-title{
      font-family: var(--font-title);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 12px;
      opacity: 0.85;
      margin: 2px 0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-family: var(--font-title);
      font-size: 11px;
      letter-spacing: 0.14em;
      opacity: 0.75;
      margin: 8px 0 6px;
      text-transform: uppercase;
    }

    input[type="text"], textarea, select{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(4,4,14,0.35);
      color: var(--ivory);
      padding: 12px 12px;
      outline: none;
      font-family: var(--font-body);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.14);
    }
    textarea{ min-height: 94px; resize: vertical; }
    select{ padding: 12px; }

    .sources{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 6px;
    }
    @media (max-width: 560px){ .sources{ grid-template-columns: 1fr; } }

    .src{
      border-radius: 16px;
      border: 1px solid rgba(241,230,163,0.16);
      background: rgba(11,15,20,0.26);
      padding: 12px 12px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .src input{ margin-top: 3px; }
    .src strong{
      display:block;
      font-family: var(--font-title);
      letter-spacing: 0.10em;
      font-size: 12px;
    }
    .src span{
      display:block;
      color: rgba(251,248,241,0.70);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.35;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 14px;
      font-family: var(--font-title);
      letter-spacing: 0.12em;
      font-size: 12px;
      text-transform: uppercase;
      border: 1px solid rgba(241,230,163,0.26);
      background: rgba(11,15,20,0.22);
      color: var(--ivory);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(241,230,163,0.22), rgba(241,230,163,0.08));
    }

    .note{
      margin-top: 10px;
      color: rgba(251,248,241,0.65);
      font-size: 12px;
      line-height: 1.4;
    }

    /* Right panel: report */
    .pill{
      border-radius: 999px;
      padding: 6px 10px;
      font-family: var(--font-title);
      font-size: 11px;
      letter-spacing: 0.12em;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(11,15,20,0.26);
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(160,255,190,0.45); }
    .pill.warn{ border-color: rgba(255,220,140,0.45); }
    .pill.bad{ border-color: rgba(255,120,120,0.45); }
    .pill.muted{ opacity:0.8; }

    .steps{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .step{
      border-radius: 16px;
      border: 1px solid rgba(241,230,163,0.16);
      background: rgba(11,15,20,0.22);
      padding: 10px;
    }
    .step small{
      display:block;
      font-family: var(--font-title);
      font-size: 10px;
      letter-spacing: 0.14em;
      opacity: 0.7;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .step b{
      display:block;
      font-size: 12px;
      color: rgba(251,248,241,0.80);
      font-weight: 500;
    }

    .bar{
      margin-top: 10px;
      height: 8px;
      border-radius: 999px;
      background: rgba(241,230,163,0.10);
      border: 1px solid rgba(241,230,163,0.14);
      overflow:hidden;
    }
    #barFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(241,230,163,0.32), rgba(212,175,55,0.22));
    }

    .tabs{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .tab{
      cursor:pointer;
      border-radius: 999px;
      padding: 8px 12px;
      font-family: var(--font-title);
      letter-spacing: 0.12em;
      font-size: 11px;
      text-transform: uppercase;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(11,15,20,0.20);
      color: var(--ivory);
    }
    .tab[aria-selected="true"]{
      border-color: rgba(241,230,163,0.34);
      background: rgba(241,230,163,0.10);
    }

    .pane{ display:none; margin-top: 12px; }
    .pane.active{ display:block; }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(241,230,163,0.12);
      font-size: 12px;
    }
    .kv .k{ color: rgba(251,248,241,0.72); }
    .kv .v{ color: rgba(241,230,163,0.82); font-family: var(--font-title); letter-spacing:0.08em; }

    .mini-actions{
      display:flex; gap: 10px; flex-wrap:wrap;
      margin-top: 10px;
    }

    textarea.code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.4;
      min-height: 260px;
      background: rgba(4,4,14,0.40);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(11,15,20,0.22);
      font-family: var(--font-title);
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .badge.ok{ border-color: rgba(160,255,190,0.45); }
    .badge.warn{ border-color: rgba(255,220,140,0.45); }
    .badge.bad{ border-color: rgba(255,120,120,0.45); }
    .badge.muted{ opacity:0.8; }
    
    .subline{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 100%;
  </style>
</head>

<body>
  <canvas id="bg-field" aria-hidden="true"></canvas>

  <header class="top">
    <div class="top-inner">
      <div class="brand"><span class="dot"></span> OPENPROOF.NET — HR DECISION SANDBOX</div>
      <nav class="nav" aria-label="Primary">
        <a href="index.html" target="_blank" rel="noopener noreferrer">Home</a>
        <a href="sandbox.html" aria-current="page">Sandbox</a>
        <a href="how-it-works.html" target="_blank" rel="noopener noreferrer">How it works</a>
        <a href="spec.html" target="_blank" rel="noopener noreferrer">Spec</a>
        <a href="tests.html" target="_blank" rel="noopener noreferrer">Tests</a>
        <a href="examples.html" target="_blank" rel="noopener noreferrer">Examples</a>
      </nav>
      <a class="cta" href="sandbox.html">TRY THE LIVE DEMO</a>
    </div>
  </header>

  <div class="wrap">
    <section class="hero">
      <div class="kicker">Live demo for governed HR decisions</div>

      <h1 class="h1">
        SANDBOX,<br/>
        <span class="gold">FROM HR DATA TO DEFENSIBLE DECISION.</span><br/>
        <span style="font-size:0.72em; opacity:0.9;">Same inputs → same accountability bundle.</span>
      </h1>

      <div class="subline">
        This demo does not “pick the best candidate”. It produces a deterministic Decision Readiness Report: coverage, missing data,
        explicit hypotheses, and a defensibility level. No AI. No storage. Humans remain accountable.
      </div>

      <div class="chips" role="list" aria-label="Principles">
        <div class="chip" role="listitem"><i></i> NO AI</div>
        <div class="chip" role="listitem"><i></i> LOCAL ONLY</div>
        <div class="chip" role="listitem"><i></i> DETERMINISTIC</div>
        <div class="chip" role="listitem"><i></i> OPPOSABLE STRUCTURE</div>
      </div>

      <div class="note">Bad decisions are not the problem. Undocumented decisions are.</div>
    </section>

    <section class="grid" aria-label="Sandbox layout">
      <!-- LEFT: inputs -->
      <article class="panel" aria-label="Inputs">
        <div class="panel-inner">
          <div class="panel-title">Input bundle</div>

          <div class="row">
            <div>
              <label for="decisionType">Decision type</label>
              <select id="decisionType">
                <option value="">Select…</option>
                <option value="internal_dg">Internal DG appointment</option>
                <option value="promotion">Promotion / role change</option>
                <option value="termination">Termination</option>
                <option value="remuneration">Remuneration decision</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label for="decisionDate">Decision date (moment T)</label>
              <input id="decisionDate" type="text" placeholder="Example: 2026-01-28" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="orgLabel">Organisation / perimeter</label>
              <input id="orgLabel" type="text" placeholder="Example: Company X — France scope" />
            </div>
            <div>
              <label for="issuer">Decision owner</label>
              <input id="issuer" type="text" placeholder="Example: CEO / Executive committee" />
            </div>
          </div>

          <label>Selected data sources (what was really available)</label>
          <div class="sources">
            <div class="src">
              <input id="srcLMS" type="checkbox" checked />
              <div>
                <strong>LMS / TRAINING RECORDS</strong>
                <span>Documented trainings, certifications, completions</span>
              </div>
            </div>

            <div class="src">
              <input id="srcHRIS" type="checkbox" checked />
              <div>
                <strong>HRIS / JOB HISTORY</strong>
                <span>Roles, seniority, mobility, grade changes</span>
              </div>
            </div>

            <div class="src">
              <input id="srcPerf" type="checkbox" checked />
              <div>
                <strong>PERFORMANCE REVIEWS</strong>
                <span>Official annual reviews, objectives, ratings</span>
              </div>
            </div>

            <div class="src">
              <input id="srcMobility" type="checkbox" />
              <div>
                <strong>MOBILITY & EXPOSURE</strong>
                <span>International, transversal scope, P&amp;L exposure</span>
              </div>
            </div>

            <div class="src">
              <input id="srcOps" type="checkbox" checked />
              <div>
                <strong>OPERATIONAL OUTCOMES</strong>
                <span>Turnover, engagement, delivery KPIs (attested)</span>
              </div>
            </div>

            <div class="src">
              <input id="src360" type="checkbox" />
              <div>
                <strong>360 / FEEDBACK</strong>
                <span>If documented and attributable</span>
              </div>
            </div>
          </div>

          <label for="candA">Candidate A — notes (official elements only)</label>
          <textarea id="candA" placeholder="Example: 20y tenure, 3 roles, 2 leadership roles, last rating: exceeds..."></textarea>

          <label for="candB">Candidate B — notes (official elements only)</label>
          <textarea id="candB" placeholder="Example: 12y tenure, mobility abroad, mixed ratings, 1 crisis situation..."></textarea>

          <label for="candC">Candidate C — notes (official elements only)</label>
          <textarea id="candC" placeholder="Example: 8y tenure, strong ops KPIs, no 360, no international..."></textarea>

          <label for="missingData">Known missing data (absence = data)</label>
          <textarea id="missingData" placeholder="Example: leadership in crisis, international exposure, documented 360 feedback..."></textarea>

          <label for="constraints">Decision constraints (optional)</label>
          <textarea id="constraints" placeholder="Example: urgency, regulatory timeline, union sensitivity, business continuity requirements..."></textarea>

          <div class="actions">
            <button class="btn primary" id="generateBtn">Generate decision bundle</button>
            <button class="btn" id="loadExampleBtn">Load example</button>
            <button class="btn" id="resetBtn">Reset</button>
          </div>

          <div class="note">No account, no storage. Refresh clears everything. Deterministic rules only: same inputs → same outputs.</div>
        </div>
      </article>

      <!-- RIGHT: report -->
      <aside class="panel" aria-label="Decision readiness report">
        <div class="panel-inner">
          <div class="panel-title">
            Decision readiness report
            <span class="pill muted" id="statusPill"><span id="statusText">NO BUNDLE YET</span></span>
          </div>

          <div class="steps">
            <div class="step"><small>Input</small><b id="vInput">Awaiting snapshots</b><span class="badge muted" id="s1">—</span></div>
            <div class="step"><small>Assess</small><b id="vExtract">Coverage / risks</b><span class="badge muted" id="s2">—</span></div>
            <div class="step"><small>Seal</small><b id="vSeal">Public hash</b><span class="badge muted" id="s3">—</span></div>
          </div>

          <div class="bar" aria-label="Progress"><div id="barFill"></div></div>
          <div class="kv"><div class="k">READY</div><div class="v" id="readyLabel">READY</div></div>
          <div class="kv" style="border-bottom:none;"><div class="k">SYNC</div><div class="v" id="syncLabel">SYNC</div></div>

          <div class="tabs" role="tablist" aria-label="Report tabs">
            <button class="tab" role="tab" id="tabBundle" aria-selected="true">Bundle</button>
            <button class="tab" role="tab" id="tabJson" aria-selected="false">JSON</button>
            <button class="tab" role="tab" id="tabVerify" aria-selected="false">Verify</button>
          </div>

          <!-- Bundle pane -->
          <div class="pane active" id="paneBundle" role="tabpanel" aria-labelledby="tabBundle">
            <div class="kv"><div class="k">Coverage (global)</div><div class="v" id="mCoverage">—</div></div>
            <div class="kv"><div class="k">Missing data</div><div class="v" id="mMissing">—</div></div>
            <div class="kv"><div class="k">Defensibility</div><div class="v" id="mDef">—</div></div>

            <div class="kv"><div class="k">Candidate A</div><div class="v" id="mA">—</div></div>
            <div class="kv"><div class="k">Candidate B</div><div class="v" id="mB">—</div></div>
            <div class="kv"><div class="k">Candidate C</div><div class="v" id="mC">—</div></div>

            <div class="kv"><div class="k">Public hash (sha256)</div><div class="v" id="mHash">—</div></div>

            <div class="mini-actions">
              <button class="btn" id="copyHashBtn">Copy hash</button>
              <button class="btn" id="copyJsonBtn">Copy JSON</button>
              <button class="btn primary" id="downloadJsonBtn">Download decision_bundle.json</button>
            </div>

            <div class="note">
              This report is about defensibility, not “truth” and not “recommendation”. Governance is not about being right. It’s about being accountable.
            </div>
          </div>

          <!-- JSON pane -->
          <div class="pane" id="paneJson" role="tabpanel" aria-labelledby="tabJson">
            <label for="jsonOut" style="margin-top:0;">Decision bundle JSON</label>
            <textarea id="jsonOut" class="code" spellcheck="false" placeholder="Generate a bundle to see JSON here…"></textarea>
          </div>

          <!-- Verify pane -->
          <div class="pane" id="paneVerify" role="tabpanel" aria-labelledby="tabVerify">
            <div class="mini-actions">
              <button class="btn" id="useLastBtn">Use last payload</button>
              <span class="badge muted" id="verifyBadge">NO CHECK YET</span>
            </div>

            <label for="verifyPayload">Payload (stable JSON used for hashing)</label>
            <textarea id="verifyPayload" class="code" spellcheck="false" placeholder="Paste payload JSON here…"></textarea>

            <label for="verifyHash">Expected sha256 (hex)</label>
            <input id="verifyHash" type="text" placeholder="Paste expected sha256 here…" />

            <div class="actions">
              <button class="btn primary" id="verifyBtn">Verify</button>
            </div>

            <div class="note" id="verifyMsg">—</div>
          </div>

        </div>
      </aside>
    </section>
  </div>

  <!-- ✅ PARTIE 2: JS juste après -->
<script>
/* =========================================================
Background field (starfield) — visual only
========================================================= */
(function () {
  const canvas = document.getElementById("bg-field");
  if (!canvas) return;
  const ctx = canvas.getContext("2d", { alpha: true });
  let width, height, particles = [];
  const COUNT = 220;

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    const ratio = window.devicePixelRatio || 1;
    canvas.width = width * ratio;
    canvas.height = height * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  }

  function createParticle() {
    return {
      x: (Math.random() * 2 - 1),
      y: (Math.random() * 2 - 1),
      z: Math.random() * 0.9 + 0.1,
      speed: Math.random() * 0.004 + 0.0015
    };
  }

  function init() {
    particles = [];
    for (let i = 0; i < COUNT; i++) particles.push(createParticle());
  }

  function project(p) {
    const f = 400;
    const s = f / (f * p.z);
    return {
      x: p.x * width * 0.5 * s + width / 2,
      y: p.y * height * 0.5 * s + height / 2
    };
  }

  function loop() {
    ctx.clearRect(0, 0, width, height);

    const grad = ctx.createRadialGradient(
      width * 0.5, height * 0.18, 0,
      width * 0.5, height * 0.18, width * 0.65
    );
    grad.addColorStop(0, "rgba(241,230,163,0.18)");
    grad.addColorStop(0.42, "rgba(241,230,163,0.04)");
    grad.addColorStop(1, "transparent");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, width, height);

    for (const p of particles) {
      p.z -= p.speed;
      if (p.z < 0.08) {
        Object.assign(p, createParticle());
        p.z = 1;
      }
      const { x, y } = project(p);
      const a = Math.min(1, (1.2 - p.z) * 1.1);
      ctx.fillStyle = `rgba(241,230,163,${0.55 * a})`;
      ctx.beginPath();
      ctx.arc(x, y, 1.6, 0, Math.PI * 2);
      ctx.fill();
    }
    requestAnimationFrame(loop);
  }

  window.addEventListener("resize", resize);
  resize(); init(); loop();
})();

/* =========================================================
Deterministic HR decision logic (no AI)
========================================================= */
const $ = (id) => document.getElementById(id);

function must(id){
  const el = $(id);
  if (!el) throw new Error(`Missing element #${id} (ID mismatch between HTML and JS).`);
  return el;
}

const EXAMPLE = {
  decisionType: "internal_dg",
  decisionDate: "2026-01-28",
  orgLabel: "Company X — France scope",
  issuer: "CEO / Executive committee",
  sources: { lms:true, hris:true, perf:true, mobility:false, ops:true, s360:false },
  candA: "20y tenure. 3 roles incl. 2 leadership roles. Last 2 reviews: exceeds objectives. Documented team retention stable.",
  candB: "12y tenure. 1 leadership role. Mobility abroad not documented in HRIS. Last review: meets objectives. No attested ops KPIs available.",
  candC: "8y tenure. Strong ops delivery KPIs (attested). 1 leadership role. No documented 360 feedback.",
  missingData: "Leadership under crisis; international exposure; documented 360 feedback; comparable ops KPIs for all candidates.",
  constraints: "Urgency: business continuity. Sensitive social climate. Need quick appointment within 30 days."
};

const SOURCE_WEIGHTS = [
  { key: "lms",      w: 14 },
  { key: "hris",     w: 18 },
  { key: "perf",     w: 22 },
  { key: "mobility", w: 16 },
  { key: "ops",      w: 20 },
  { key: "s360",     w: 10 }
];

const COVERAGE_KEYWORDS = {
  lms:      ["training","certif","certification","course","lms"],
  hris:     ["role","tenure","job","mobility","grade","promotion"],
  perf:     ["review","rating","objectives","meets","exceeds","performance"],
  mobility: ["international","abroad","cross","transversal","global","p&l","exposure"],
  ops:      ["kpi","results","delivery","turnover","retention","engagement","ops"],
  s360:     ["360","feedback","peer","manager feedback"]
};

function safeText(v){ return (v || "").toString().trim(); }
function nowISO(){ return new Date().toISOString(); }
function normalizeLower(s){ return safeText(s).toLowerCase(); }
function bool(id){ return !!must(id).checked; }

function selectedSources(){
  return {
    lms: bool("srcLMS"),
    hris: bool("srcHRIS"),
    perf: bool("srcPerf"),
    mobility: bool("srcMobility"),
    ops: bool("srcOps"),
    s360: bool("src360")
  };
}

function computeGlobalCoverage(sources){
  const total = SOURCE_WEIGHTS.reduce((a,x)=>a+x.w,0);
  const on = SOURCE_WEIGHTS.reduce((a,x)=> a + (sources[x.key] ? x.w : 0), 0);
  return Math.round(100 * (on / total));
}

function computeCandidateCoverage(candidateText, sources){
  const t = normalizeLower(candidateText);
  const totalOn = SOURCE_WEIGHTS.reduce((a,x)=> a + (sources[x.key] ? x.w : 0), 0);
  let covered = 0;

  for (const src of SOURCE_WEIGHTS){
    if (!sources[src.key]) continue;
    const kws = COVERAGE_KEYWORDS[src.key] || [];
    const hit = kws.some(k => t.includes(k));
    covered += hit ? src.w : Math.round(src.w * 0.55);
  }

  const pct = totalOn > 0 ? Math.round(100 * (covered / totalOn)) : 0;
  return Math.max(0, Math.min(100, pct));
}

function countMissingItems(missingText){
  const t = safeText(missingText);
  if (!t) return 0;
  const parts = t.split(/[\n,;]+/g).map(x=>x.trim()).filter(Boolean);
  return Math.min(12, parts.length);
}

function defensibilityLevel(globalCoverage, missingCount, sources){
  const hasCore = sources.perf && sources.hris;
  if (globalCoverage >= 75 && missingCount <= 2 && hasCore) return "HIGH";
  if (globalCoverage >= 55 && missingCount <= 6) return "MEDIUM";
  return "LOW";
}

function risksFrom(missingText, globalCoverage){
  const risks = [];
  if (globalCoverage < 55) risks.push("Low evidential coverage at moment T");

  const m = normalizeLower(missingText);
  if (m.includes("crisis") || m.includes("crise")) risks.push("Crisis leadership not documented");
  if (m.includes("international") || m.includes("abroad") || m.includes("exposure")) risks.push("International exposure unclear");
  if (m.includes("360") || m.includes("feedback")) risks.push("Feedback/360 not attributable");
  if (m.includes("kpi") || m.includes("ops") || m.includes("turnover") || m.includes("engagement")) risks.push("Operational comparability incomplete");

  if (!risks.length) risks.push("Known gaps explicitly stated; residual uncertainty remains");
  return risks.slice(0, 6);
}

function hypothesesFrom(input, analysis){
  const h = [];
  const m = normalizeLower(input.missingData || "");
  const c = normalizeLower(input.constraints || "");

  const covs = analysis.candidates.map(x => x.coverage).slice().sort((a,b)=>b-a);
  const gapTop = covs.length >= 2 ? (covs[0] - covs[1]) : 100;

  if (gapTop <= 5) h.push("Candidates are within a narrow coverage band; decision likely depends on qualitative criteria.");
  if (m.includes("crisis") || m.includes("crise")) h.push("If crisis leadership is decisive, require at least 1 documented crisis episode per candidate.");
  if (m.includes("international") || m.includes("abroad")) h.push("If international exposure is required, validate assignments via HRIS + references.");
  if (m.includes("360") || m.includes("feedback")) h.push("If leadership style matters, collect attributable 360 feedback with date + author role.");
  if (m.includes("kpi") || m.includes("ops")) h.push("If ops performance is central, align candidates on comparable KPIs, same period, same scope.");

  if (c.includes("30") || c.includes("urgent") || c.includes("urgence")) h.push("Under urgency, document why a lighter evidential bundle is acceptable (risk acceptance note).");
  if (c.includes("social") || c.includes("climate") || c.includes("climat")) h.push("If social climate is sensitive, add an impact note: stakeholder map + mitigation actions.");

  if (!h.length) h.push("Decision hinges on explicit criteria; document the weighting before appointment.");
  return h.slice(0, 6);
}

async function sha256Hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
}

function stablePayload(input, analysis){
  const srcKeys = Object.keys(input.sources).sort();
  const sources = {};
  srcKeys.forEach(k => sources[k] = !!input.sources[k]);

  const candidates = [...analysis.candidates]
    .map(c => ({ id: c.id, coverage: c.coverage }))
    .sort((a,b)=> a.id.localeCompare(b.id));

  const risks = [...analysis.risks].slice().sort();

  return JSON.stringify({
    v: "0.1",
    decision_type: input.decisionType,
    decision_date: input.decisionDate,
    organisation: input.orgLabel,
    decision_owner: input.issuer,
    sources,
    candidates,
    global_coverage: analysis.globalCoverage,
    missing_count: analysis.missingCount,
    defensibility: analysis.defensibility,
    risks
  });
}

function buildDecisionBundle(input, analysis){
  const bundleId = "decision-" + analysis.public_hash.slice(0, 12);

  return {
    rpo_version: "0.1",
    bundle_id: bundleId,
    created_at: nowISO(),
    decision: {
      type: input.decisionType || "other",
      moment_t: input.decisionDate || "—",
      organisation: input.orgLabel || "—",
      owner: input.issuer || "—"
    },
    input_state: {
      sources_available: input.sources,
      candidates_snapshots: { A: input.candA || "", B: input.candB || "", C: input.candC || "" },
      known_missing_data: input.missingData || "",
      constraints: input.constraints || ""
    },
    assessment: {
      global_coverage_pct: analysis.globalCoverage,
      missing_items_count: analysis.missingCount,
      candidates: analysis.candidates.map(c => ({ id: c.id, coverage_pct: c.coverage, risk_level: c.risk })),
      defensibility: analysis.defensibility,
      explicit_hypotheses: analysis.hypotheses,
      known_risks: analysis.risks
    },
    integrity: {
      public_hash_sha256: analysis.public_hash,
      statement: "Hash proves integrity of the payload, not correctness of the decision."
    },
    disclaimer: "Deterministic sandbox. No AI. No storage. Not legal advice."
  };
}

function riskLevelFromCoverage(cov){
  if (cov >= 85) return "LOW";
  if (cov >= 65) return "MEDIUM";
  return "UNKNOWN";
}

/* =========================================================
UI + Orchestration
========================================================= */
let LAST = { input:null, analysis:null, payload:null, hash:null, bundle:null };

function readInput(){
  const sources = selectedSources();
  return {
    decisionType: safeText(must("decisionType").value),
    decisionDate: safeText(must("decisionDate").value),
    orgLabel: safeText(must("orgLabel").value),
    issuer: safeText(must("issuer").value),
    candA: safeText(must("candA").value),
    candB: safeText(must("candB").value),
    candC: safeText(must("candC").value),
    missingData: safeText(must("missingData").value),
    constraints: safeText(must("constraints").value),
    sources
  };
}

function setBadge(el, label, kind){
  el.classList.remove("ok","warn","bad","muted");
  if (kind) el.classList.add(kind);
  el.textContent = label;
}

function setPill(level){
  const pill = must("statusPill");
  pill.classList.remove("ok","warn","bad","muted");
  const txt = must("statusText");

  if (level === "HIGH"){ pill.classList.add("ok"); txt.textContent = "DEFENSIBILITY: HIGH"; return; }
  if (level === "MEDIUM"){ pill.classList.add("warn"); txt.textContent = "DEFENSIBILITY: MEDIUM"; return; }
  pill.classList.add("bad"); txt.textContent = "DEFENSIBILITY: LOW";
}

function setProgress(globalCoverage){
  must("barFill").style.width = `${Math.max(2, Math.min(100, globalCoverage))}%`;
  must("readyLabel").textContent = "READY";
  must("syncLabel").textContent = "SYNC";
}

function renderBundle(bundle, analysis){
  must("mCoverage").textContent = `${analysis.globalCoverage}%`;
  must("mMissing").textContent = `${analysis.missingCount}`;
  must("mDef").textContent = analysis.defensibility;

  const cA = analysis.candidates.find(x=>x.id==="A");
  const cB = analysis.candidates.find(x=>x.id==="B");
  const cC = analysis.candidates.find(x=>x.id==="C");

  must("mA").textContent = `A: Coverage ${cA.coverage}% — Risk ${cA.risk}`;
  must("mB").textContent = `B: Coverage ${cB.coverage}% — Risk ${cB.risk}`;
  must("mC").textContent = `C: Coverage ${cC.coverage}% — Risk ${cC.risk}`;

  must("mHash").textContent = analysis.public_hash;

  setBadge(must("s1"), "OK", "ok");
  setBadge(must("s2"), "OK", "ok");
  setBadge(must("s3"), "SEALED", "ok");

  must("vInput").textContent = "Input captured";
  must("vExtract").textContent = "Deterministic assessment";
  must("vSeal").textContent = "Public hash sealed";

  setPill(analysis.defensibility);
  setProgress(analysis.globalCoverage);

  must("jsonOut").value = JSON.stringify(bundle, null, 2);
}

function downloadJson(filename, text){
  const blob = new Blob([text], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function generate(){
  const input = readInput();
  const sources = input.sources;

  const globalCoverage = computeGlobalCoverage(sources);
  const missingCount = countMissingItems(input.missingData);

  const cA = computeCandidateCoverage(input.candA, sources);
  const cB = computeCandidateCoverage(input.candB, sources);
  const cC = computeCandidateCoverage(input.candC, sources);

  const analysis = {
    globalCoverage,
    missingCount,
    candidates: [
      { id:"A", coverage: cA, risk: riskLevelFromCoverage(cA) },
      { id:"B", coverage: cB, risk: riskLevelFromCoverage(cB) },
      { id:"C", coverage: cC, risk: riskLevelFromCoverage(cC) }
    ],
    defensibility: defensibilityLevel(globalCoverage, missingCount, sources),
    risks: risksFrom(input.missingData, globalCoverage),
    hypotheses: [] // set below
  };

  analysis.hypotheses = hypothesesFrom(input, analysis);

  // Stable payload + public hash
  const payload = stablePayload(input, analysis);
  const hash = await sha256Hex(payload);

  analysis.public_hash = hash;

  const bundle = buildDecisionBundle(input, analysis);

  // Persist last state for Verify tab + buttons
  LAST = { input, analysis, payload, hash, bundle };

  renderBundle(bundle, analysis);

  // Status pill / progress already set by renderBundle()
  return LAST;
}

/* =========================================================
UI helpers (Reset, Load example, Tabs, Copy, Verify)
========================================================= */

function setActiveTab(tabId){
  const tabs = ["tabBundle","tabJson","tabVerify"];
  const panes = ["paneBundle","paneJson","paneVerify"];

  tabs.forEach(id => must(id).setAttribute("aria-selected", id === tabId ? "true" : "false"));
  panes.forEach(pid => must(pid).classList.toggle("active", pid === ("pane" + tabId.replace("tab",""))));
}

function resetUI(){
  // Right panel: neutral state
  must("statusPill").classList.remove("ok","warn","bad");
  must("statusPill").classList.add("muted");
  must("statusText").textContent = "NO BUNDLE YET";

  setBadge(must("s1"), "—", "muted");
  setBadge(must("s2"), "—", "muted");
  setBadge(must("s3"), "—", "muted");

  must("vInput").textContent = "Awaiting snapshots";
  must("vExtract").textContent = "Coverage / risks";
  must("vSeal").textContent = "Public hash";

  must("barFill").style.width = "0%";
  must("readyLabel").textContent = "READY";
  must("syncLabel").textContent = "SYNC";

  // Bundle metrics
  ["mCoverage","mMissing","mDef","mA","mB","mC","mHash"].forEach(id => must(id).textContent = "—");

  // JSON/Verify panes
  must("jsonOut").value = "";
  must("verifyPayload").value = "";
  must("verifyHash").value = "";
  must("verifyMsg").textContent = "—";
  must("verifyBadge").classList.remove("ok","warn","bad","muted");
  must("verifyBadge").classList.add("muted");
  must("verifyBadge").textContent = "NO CHECK YET";

  // Tab back to bundle
  setActiveTab("tabBundle");

  LAST = { input:null, analysis:null, payload:null, hash:null, bundle:null };
}

function loadExample(){
  must("decisionType").value = EXAMPLE.decisionType;
  must("decisionDate").value = EXAMPLE.decisionDate;
  must("orgLabel").value = EXAMPLE.orgLabel;
  must("issuer").value = EXAMPLE.issuer;

  must("srcLMS").checked = !!EXAMPLE.sources.lms;
  must("srcHRIS").checked = !!EXAMPLE.sources.hris;
  must("srcPerf").checked = !!EXAMPLE.sources.perf;
  must("srcMobility").checked = !!EXAMPLE.sources.mobility;
  must("srcOps").checked = !!EXAMPLE.sources.ops;
  must("src360").checked = !!EXAMPLE.sources.s360;

  must("candA").value = EXAMPLE.candA;
  must("candB").value = EXAMPLE.candB;
  must("candC").value = EXAMPLE.candC;
  must("missingData").value = EXAMPLE.missingData;
  must("constraints").value = EXAMPLE.constraints;

  // Optionnel mais utile : auto-génère après load
  generate().catch(console.error);
}

function resetAll(){
  // Clear left inputs
  must("decisionType").value = "";
  must("decisionDate").value = "";
  must("orgLabel").value = "";
  must("issuer").value = "";

  // Default checks as in HTML initial state
  must("srcLMS").checked = true;
  must("srcHRIS").checked = true;
  must("srcPerf").checked = true;
  must("srcMobility").checked = false;
  must("srcOps").checked = true;
  must("src360").checked = false;

  must("candA").value = "";
  must("candB").value = "";
  must("candC").value = "";
  must("missingData").value = "";
  must("constraints").value = "";

  resetUI();
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    // Fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }
}

async function verifyHash(){
  const payload = safeText(must("verifyPayload").value);
  const expected = normalizeLower(must("verifyHash").value);
  if (!payload || !expected){
    must("verifyMsg").textContent = "Provide both payload and expected hash.";
    must("verifyBadge").classList.remove("ok","warn","bad","muted");
    must("verifyBadge").classList.add("warn");
    must("verifyBadge").textContent = "MISSING INPUT";
    return;
  }

  const computed = await sha256Hex(payload);
  const ok = computed === expected;

  must("verifyBadge").classList.remove("ok","warn","bad","muted");
  must("verifyBadge").classList.add(ok ? "ok" : "bad");
  must("verifyBadge").textContent = ok ? "MATCH" : "MISMATCH";

  must("verifyMsg").textContent = ok
    ? "Match. Payload integrity is consistent with the expected hash."
    : `Mismatch. Computed: ${computed}`;
}

/* =========================================================
Wire events (IMPORTANT: after DOM exists)
========================================================= */
function wire(){
  // Buttons
  must("generateBtn").addEventListener("click", () => generate().catch(console.error));
  must("loadExampleBtn").addEventListener("click", loadExample);
  must("resetBtn").addEventListener("click", resetAll);

  // Tabs
  must("tabBundle").addEventListener("click", () => setActiveTab("tabBundle"));
  must("tabJson").addEventListener("click", () => setActiveTab("tabJson"));
  must("tabVerify").addEventListener("click", () => setActiveTab("tabVerify"));

  // Copy / download
  must("copyHashBtn").addEventListener("click", async () => {
    if (!LAST?.analysis?.public_hash) return;
    await copyToClipboard(LAST.analysis.public_hash);
  });

  must("copyJsonBtn").addEventListener("click", async () => {
    const v = safeText(must("jsonOut").value);
    if (!v) return;
    await copyToClipboard(v);
  });

  must("downloadJsonBtn").addEventListener("click", () => {
    const v = safeText(must("jsonOut").value);
    if (!v) return;
    downloadJson("decision_bundle.json", v);
  });

  // Verify pane
  must("useLastBtn").addEventListener("click", () => {
    if (!LAST?.payload || !LAST?.hash) return;
    must("verifyPayload").value = LAST.payload;
    must("verifyHash").value = LAST.hash;
    must("verifyMsg").textContent = "Loaded last payload + hash.";
    must("verifyBadge").classList.remove("ok","warn","bad","muted");
    must("verifyBadge").classList.add("muted");
    must("verifyBadge").textContent = "NO CHECK YET";
  });

  must("verifyBtn").addEventListener("click", () => verifyHash().catch(console.error));

  // Optional: live update (comment out if you want “manual only”)
  const liveIds = [
    "decisionType","decisionDate","orgLabel","issuer",
    "srcLMS","srcHRIS","srcPerf","srcMobility","srcOps","src360",
    "candA","candB","candC","missingData","constraints"
  ];
  liveIds.forEach(id => {
    const el = must(id);
    el.addEventListener(el.tagName === "INPUT" || el.tagName === "SELECT" ? "change" : "input", () => {
      // Generate only if we already generated once OR if user starts typing a meaningful bundle
      const anyText = safeText(must("candA").value) || safeText(must("candB").value) || safeText(must("candC").value);
      if (!anyText && !LAST?.bundle) return;
      generate().catch(console.error);
    });
  });

  // Start in clean state
  resetUI();
}

// Ensure wiring happens after the DOM is ready
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", wire);
} else {
  wire();
}
</script>
