<!DOCTYPE html>
<html lang="fr" data-page="sandbox">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Sandbox — Faisceau de preuves déterministes (RPO v0.1) | OpenProof</title>
  <meta name="description" content="Sandbox OpenProof RPO v0.1 : figer le périmètre décisionnel, déclarer les sources, générer un bundle déterministe (JSON + aperçu imprimable + hash SHA-256). Local-only. Sans IA." />
  <meta name="robots" content="index, follow" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@500;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-deep:#04040e;
      --bg-mid:#0b0f14;

      --gold-soft:#f1e6a3;
      --gold:#d4af37;
      --gold-deep:#8f7633;

      --ivory:#f7f3e8;
      --ink-soft:#b3a48b;

      --radius:24px;
      --shadow-soft:0 26px 70px rgba(0,0,0,0.55);
      --panel:linear-gradient(145deg, rgba(10,12,27,0.97), rgba(5,7,18,0.98));
      --line:rgba(212,175,55,0.16);
      --line2:rgba(136,116,72,0.35);

      --focus: 0 0 0 3px rgba(241,230,163,0.22), 0 0 0 1px rgba(212,175,55,0.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      color:var(--ivory);
      background:
        radial-gradient(circle at 10% -10%, rgba(241,230,163,0.22), transparent 55%),
        radial-gradient(circle at 90% 110%, rgba(241,230,163,0.16), transparent 55%),
        linear-gradient(180deg, #050712, #020208 60%, #050712 100%);
      overflow-x:hidden;
    }
    a{color:inherit}
    a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
      outline:none; box-shadow:var(--focus); border-radius:10px;
    }
    ::selection{background: rgba(212,175,55,.25);}

    /* BACKGROUND FIELD */
    #bg-field{position:fixed; inset:0; width:100%; height:100%; z-index:-1;}

    /* TOP BAR */
    .top-bar{
      position:fixed;
      top:0; left:0; right:0;
      height:68px;
      padding:0 40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:10;
      background:linear-gradient(to bottom, rgba(4,4,14,0.96), rgba(4,4,14,0.88), transparent);
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(212,175,55,0.22);
    }
    .top-left{display:flex; align-items:center; gap:14px; min-width:280px;}
    .emblem{
      width:34px;height:34px;border-radius:999px;
      background:radial-gradient(circle at 30% 0, #f1e6a3, #d4af37 60%, #8f7633 100%);
      box-shadow:0 0 18px rgba(241,230,163,0.8);
      flex:0 0 auto;
    }
    .brand{
      font-family:"Orbitron",sans-serif;
      font-size:0.72rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--ink-soft);
      white-space:nowrap;
    }
    .brand span{color:var(--gold-soft)}
    .top-nav{
      display:flex; gap:22px; font-size:0.86rem; color:var(--ink-soft);
      align-items:center; justify-content:center; flex:1 1 auto;
    }
    .top-nav a{
      color:inherit; text-decoration:none; position:relative; padding-bottom:3px; white-space:nowrap;
    }
    .top-nav a::after{
      content:""; position:absolute; left:0; bottom:0; width:0; height:1px;
      background:linear-gradient(90deg,var(--gold-soft),var(--gold));
      transition:width .2s ease;
    }
    .top-nav a:hover::after{width:100%}
    .top-nav a[aria-current="page"]{color:var(--gold-soft)}
    .top-nav a[aria-current="page"]::after{width:100%}

    .top-cta{
      padding:8px 18px;
      border-radius:999px;
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, #ffdfb0, #f48b45);
      color:#2a1204;
      font-size:0.8rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-decoration:none;
      white-space:nowrap;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
    }
    .top-cta:hover{filter:brightness(1.03)}
    .top-cta:active{transform:translateY(1px)}

    /* WRAP */
    .wrap{
      max-width: 1440px;
      margin:0 auto;
      padding:96px 56px 72px;
    }

    /* HERO (compact) */
    .hero{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:24px;
      align-items:start;
      margin-bottom:18px;
      padding-top:8px;
    }
    .eyebrow{
      font-family:"Orbitron",sans-serif;
      font-size:.72rem;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:var(--ink-soft);
      margin-bottom:12px;
    }
    .eyebrow span{color:var(--gold-soft)}
    .h1{
      font-family:"Orbitron",sans-serif;
      text-transform:uppercase;
      letter-spacing:.06em;
      line-height:1.06;
      font-size:clamp(1.8rem,3.1vw,2.4rem);
      margin-bottom:10px;
    }
    .h1 .gold{display:block;color:var(--gold-soft)}
    .lead{
      font-size:0.98rem;
      color:rgba(198,186,150,.90);
      line-height:1.75;
      max-width:72ch;
      text-align: justify;
    }
    .chips{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;
    }
    .chip{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(212,175,55,.18);
      background: rgba(0,0,0,.22);
      font-size:12px;
      color:rgba(241,230,163,.90);
      white-space:nowrap;
    }

    /* COCKPIT (hero-right) */
    .cockpit{
      background:var(--panel);
      border-radius:var(--radius);
      border:1px solid rgba(212,175,55,0.38);
      padding:18px;
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
      min-height: 168px;
    }
    .cockpit::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 380px at 20% 0%, rgba(241,230,163,0.10), transparent 55%),
        radial-gradient(700px 360px at 110% 70%, rgba(212,175,55,0.09), transparent 55%),
        linear-gradient(120deg, rgba(241,230,163,0.06), transparent 40%, rgba(241,230,163,0.05));
      opacity:.9; filter: blur(10px);
      pointer-events:none;
    }
    .cockpit-inner{position:relative; z-index:2}
    .cockpit-title{
      font-family:"Orbitron",sans-serif;
      font-size:.74rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      font-size:.70rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(241,230,163,.45);
      margin-bottom:10px;
      color: rgba(241,230,163,.90);
      background: rgba(10,12,27,0.20);
      backdrop-filter: blur(10px);
    }
    .pill .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(241,230,163,.95);
      box-shadow: 0 0 14px rgba(241,230,163,.55);
      animation: dotPulse 1.45s ease-in-out infinite;
    }
    @keyframes dotPulse{0%,100%{transform:scale(1);opacity:.85}50%{transform:scale(1.35);opacity:1}}

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      font-size:0.9rem;
      color: rgba(198,186,150,.86);
      border-top:1px solid rgba(212,175,55,.18);
      padding-top:10px;
      margin-top:8px;
    }
    .kv .k{color: rgba(179,164,139,.92)}
    .kv .v{color: rgba(241,230,163,.90); text-align:right}

    /* MAIN GRID (50/50 strict) */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr; /* 50/50 */
      gap:18px;
      align-items:start;
      margin-top:18px;
    }

    .panel{
      background:var(--panel);
      border-radius:var(--radius);
      border:1px solid rgba(212,175,55,0.30);
      padding:18px;
      box-shadow: 0 16px 50px rgba(0,0,0,0.45);
      position:relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 380px at 20% 0%, rgba(241,230,163,0.08), transparent 55%),
        radial-gradient(700px 360px at 110% 70%, rgba(212,175,55,0.07), transparent 55%);
      opacity:.9; filter: blur(10px);
      pointer-events:none;
    }
    .panel > *{position:relative; z-index:2}

    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(212,175,55,0.16);
    }
    .panel-title{
      font-family:"Orbitron",sans-serif;
      font-size:.78rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:.70rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(241,230,163,.28);
      color: rgba(241,230,163,.88);
      background: rgba(10,12,27,0.18);
      white-space:nowrap;
    }

    /* Form */
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    label{
      font-family:"Orbitron",sans-serif;
      font-size:.64rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
    }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(212,175,55,0.20);
      background: rgba(0,0,0,0.18);
      color: rgba(241,230,163,.92);
      font-size:0.95rem;
      outline:none;
    }
    textarea{min-height:110px; resize:vertical; font-family: var(--mono); font-size:.9rem; line-height:1.55; color: rgba(241,230,163,.82);}
    .full{grid-column: 1 / -1;}

    /* Sources grid (compact, inside left panel) */
    .sources{
      margin-top:12px;
      border-top:1px solid rgba(212,175,55,0.14);
      padding-top:12px;
    }
    .sources-head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .sources-head .hint{
      font-size:.86rem;
      color: rgba(179,164,139,.88);
      line-height:1.45;
    }
    .sources-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .src{
      display:flex;
      gap:10px;
      border:1px solid rgba(212,175,55,.18);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      padding:12px;
      min-height:72px;
      align-items:flex-start;
    }
    .src input{width:auto; padding:0; border:none; background:transparent; box-shadow:none}
    .src strong{display:block; font-size:.92rem; color: rgba(241,230,163,.92); margin-bottom:4px; font-weight:600}
    .src span{display:block; font-size:.86rem; color: rgba(198,186,150,.84); line-height:1.45}

    /* Output metrics */
    .metrics{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .metric{
      border:1px solid rgba(212,175,55,.18);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      padding:12px;
      min-height:64px;
    }
    .metric .k{
      font-family:"Orbitron",sans-serif;
      font-size:.64rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(179,164,139,.92);
      margin-bottom:6px;
    }
    .metric .v{
      font-family: var(--mono);
      font-size:1rem;
      color: rgba(241,230,163,.92);
    }

    /* Tabs */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 10px;
    }
    .tab{
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.30);
      background: rgba(10,12,27,0.18);
      color: rgba(241,230,163,.90);
      padding:8px 12px;
      font-size:.78rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .tab[aria-selected="true"]{
      border-color: rgba(241,230,163,.55);
      box-shadow: 0 0 0 1px rgba(241,230,163,.12) inset;
    }

    .outputBox{
      border:1px solid rgba(212,175,55,.18);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      padding:12px;
      min-height:210px;
      font-family: var(--mono);
      font-size:.90rem;
      color: rgba(241,230,163,.82);
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* Action row */
    .actions{
      margin-top:14px;
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      border-top:1px solid rgba(212,175,55,0.14);
      padding-top:14px;
    }
    .btn{
      min-height:52px;
      border-radius:999px;
      padding:12px 18px;
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:13px;
      cursor:pointer;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(10,12,27,0.25);
      color: var(--gold-soft);
      backdrop-filter: blur(10px);
      min-width: 220px;
    }
    .btn:hover{border-color: rgba(212,175,55,0.55)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, #ffdfb0, #f48b45);
      color:#2a1204;
      min-width: 260px;
    }

    /* Utility buttons inside output */
    .mini-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .mini{
      min-height:44px;
      border-radius:999px;
      padding:10px 14px;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
      border:1px solid rgba(212,175,55,0.30);
      background: rgba(10,12,27,0.18);
      color: rgba(241,230,163,.90);
    }
    .mini:hover{border-color: rgba(241,230,163,.55)}
    .mini-primary{
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, #ffdfb0, #f48b45);
      color:#2a1204;
    }

    /* Footer + accordion */
    .bottom{
      margin-top:18px;
      border-top:1px solid rgba(212,175,55,0.14);
      padding-top:14px;
      color: rgba(179,164,139,.86);
      font-size:0.9rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    details.tech{
      margin-top:18px;
      border:1px solid rgba(212,175,55,0.18);
      border-radius:18px;
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    details.tech summary{
      list-style:none;
      cursor:pointer;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      user-select:none;
    }
    details.tech summary::-webkit-details-marker{display:none}
    .sum-left{
      display:flex; flex-direction:column; gap:4px;
    }
    .sum-title{
      font-family:"Orbitron",sans-serif;
      font-size:.74rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(179,164,139,.92);
    }
    .sum-sub{
      font-size:.92rem;
      color: rgba(198,186,150,.82);
      line-height:1.5;
    }
    .chev{
      font-family: var(--mono);
      color: rgba(241,230,163,.75);
      opacity:.85;
    }
    details[open] .chev{transform: rotate(180deg)}
    .tech-body{
      padding:16px;
      border-top:1px solid rgba(212,175,55,0.12);
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    .tcard{
      border:1px solid rgba(212,175,55,.16);
      border-radius:16px;
      background: rgba(0,0,0,.14);
      padding:14px;
      min-height: 110px;
    }
    .tcard h4{
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(179,164,139,.92);
      margin-bottom:8px;
    }
    .tcard p{
      color: rgba(198,186,150,.84);
      line-height:1.6;
      font-size:.92rem;
      text-align: justify;
    }

    /* Responsive */
    @media(max-width:1060px){
      .wrap{padding:96px 28px 56px}
      .hero{grid-template-columns: 1fr; gap:14px}
      .grid{grid-template-columns:1fr}
      .tech-body{grid-template-columns:1fr}
      .sources-grid{grid-template-columns:1fr}
      .form{grid-template-columns:1fr}
      .metrics{grid-template-columns:1fr}
      .top-nav{display:none}
      .top-bar{padding:0 16px}
    }
    @media (prefers-reduced-motion: reduce){
      #bg-field{display:none}
      .pill .dot{animation:none}
    }
  </style>
</head>

<body>
  <canvas id="bg-field" aria-hidden="true"></canvas>

  <header class="top-bar">
    <div class="top-left">
      <div class="emblem" aria-hidden="true"></div>
      <div class="brand">OPENPROOF<span>.NET — RPO v0.1</span></div>
    </div>

    <nav class="top-nav" aria-label="Primary">
      <a href="./index.html" target="_blank" rel="noopener noreferrer">Maison</a>
      <a href="./sandbox.html" aria-current="page" target="_blank" rel="noopener noreferrer">Bac à sable</a>
      <a href="./how-it-works.html" target="_blank" rel="noopener noreferrer">Comment ça marche</a>
      <a href="./spec.html" target="_blank" rel="noopener noreferrer">Spéc.</a>
      <a href="./tests.html" target="_blank" rel="noopener noreferrer">Tests</a>
      <a href="./examples.html" target="_blank" rel="noopener noreferrer">Exemples</a>
    </nav>

    <a href="./sandbox.html" class="top-cta" target="_blank" rel="noopener noreferrer">Essayez la démo en direct</a>
  </header>

  <main class="wrap" role="main">
    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-title">
      <div>
        <div class="eyebrow">Simulateur de <span>faisceaux de preuves déterministes</span></div>

        <h1 class="h1" id="hero-title">
          Figez le contexte.
          <span class="gold">Générez un dossier de décision auditable.</span>
        </h1>

        <p class="lead">
          Ce bac à sable ne “choisit” rien. Il capture un périmètre décisionnel (moment T), les sources déclarées et des règles
          déterministes — puis génère un bundle local : JSON + aperçu imprimable + hash SHA-256.
          Pas d’IA. Pas de stockage. Même entrée → même sortie.
        </p>

        <div class="chips" aria-label="Concepts">
          <span class="chip">Moment T</span>
          <span class="chip">Sources déclarées</span>
          <span class="chip">Règles déterministes</span>
          <span class="chip">Audit-ready</span>
          <span class="chip">Hash public</span>
        </div>
      </div>

      <aside class="cockpit" aria-label="Cockpit simulateur">
        <div class="cockpit-inner">
          <div class="cockpit-title">Cockpit (live)</div>
          <div class="pill"><span class="dot" aria-hidden="true"></span>Intégrité • Lisibilité • Vérifiabilité</div>

          <div class="kv" role="list">
            <div class="k">Portée</div><div class="v" id="cScope">—</div>
            <div class="k">Moment T</div><div class="v" id="cMoment">—</div>
            <div class="k">Couverture</div><div class="v" id="cCoverage">—</div>
            <div class="k">Défendabilité</div><div class="v" id="cDef">—</div>
          </div>
        </div>
      </aside>
    </section>

    <!-- MAIN 50/50 -->
    <section class="grid" aria-label="Simulateur">
      <!-- LEFT: INPUT -->
      <div class="panel" aria-label="Entrée — périmètre décisionnel">
        <div class="panel-head">
          <div class="panel-title">Entrée — périmètre de décision</div>
          <div class="tag">Portée • Sources • Responsabilité</div>
        </div>

        <div class="form">
          <div class="field">
            <label for="decisionType">Type de décision</label>
            <select id="decisionType">
              <option>Nomination / rôle sensible</option>
              <option>Mobilité interne (poste critique)</option>
              <option>Rémunération (ajustement significatif)</option>
              <option>Rupture / séparation</option>
              <option>Sanction / mesure disciplinaire</option>
              <option>Organisation (restructuration)</option>
            </select>
          </div>

          <div class="field">
            <label for="momentT">Date de décision (moment T)</label>
            <input id="momentT" type="date" />
          </div>

          <div class="field">
            <label for="scope">Organisation / étendue</label>
            <input id="scope" type="text" value="Company X — multi-sites, multi-entités" />
          </div>

          <div class="field">
            <label for="owner">Responsable de la décision</label>
            <input id="owner" type="text" value="CEO / Executive committee" />
          </div>

          <div class="field full">
            <label for="context">Contexte de la décision (1 à 3 paragraphes)</label>
            <textarea id="context">Environnement régulé. Exposition audit. Décision potentiellement contestable. Traçabilité des sources déclarées et stabilité des définitions requises.</textarea>
          </div>
        </div>

        <div class="sources" aria-label="Sources déclarées">
          <div class="sources-head">
            <div class="panel-title">Sources déclarées (ce qui était réellement disponible)</div>
            <div class="hint">Coche uniquement ce qui existe, est attribuable et re-vérifiable.</div>
          </div>

          <div class="sources-grid" role="list">
            <label class="src" role="listitem">
              <input type="checkbox" class="srcChk" data-key="lms" checked />
              <div>
                <strong>LMS / fichiers de formation</strong>
                <span>Certifications, habilitations, attestations documentées.</span>
              </div>
            </label>

            <label class="src" role="listitem">
              <input type="checkbox" class="srcChk" data-key="hris" checked />
              <div>
                <strong>SIRH / parcours professionnel</strong>
                <span>Rôles, titularisation, changements de grade, traces officielles.</span>
              </div>
            </label>

            <label class="src" role="listitem">
              <input type="checkbox" class="srcChk" data-key="perf" checked />
              <div>
                <strong>Évaluations de performance</strong>
                <span>Objectifs, revues annuelles, procédure formelle d’évaluation.</span>
              </div>
            </label>

            <label class="src" role="listitem">
              <input type="checkbox" class="srcChk" data-key="ops" checked />
              <div>
                <strong>Résultats opérationnels</strong>
                <span>KPI attestés, livrables certifiés, mesures traçables.</span>
              </div>
            </label>

            <label class="src" role="listitem">
              <input type="checkbox" class="srcChk" data-key="fb360" />
              <div>
                <strong>Commentaires à 360 degrés</strong>
                <span>Uniquement si documenté et attribuable (sinon exclu).</span>
              </div>
            </label>

            <label class="src" role="listitem">
              <input type="checkbox" class="srcChk" data-key="legal" checked />
              <div>
                <strong>Juridique / conformité</strong>
                <span>Contraintes, litiges, considérations réglementaires, éléments opposables.</span>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="panel" aria-label="Résultat — rapport">
        <div class="panel-head">
          <div class="panel-title">Résultat — rapport de préparation à la décision</div>
          <div class="tag" id="sealedTag">Bundle scellé (local-only)</div>
        </div>

        <div class="metrics" aria-label="Indicateurs">
          <div class="metric">
            <div class="k">Couverture probatoire</div>
            <div class="v" id="mCoverage">—</div>
          </div>
          <div class="metric">
            <div class="k">Manquant</div>
            <div class="v" id="mMissing">—</div>
          </div>
          <div class="metric">
            <div class="k">Défendabilité</div>
            <div class="v" id="mDef">—</div>
          </div>
          <div class="metric">
            <div class="k">Joint</div>
            <div class="v" id="mSeal">—</div>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Vues">
          <button class="tab" role="tab" aria-selected="true" id="tabSummary">Résumé</button>
          <button class="tab" role="tab" aria-selected="false" id="tabJson">JSON</button>
          <button class="tab" role="tab" aria-selected="false" id="tabPdf">PDF (impression)</button>
        </div>

        <div class="outputBox" id="outputBox" aria-label="Sortie">
Clique sur “GÉNÉRER”.

Tu peux aussi modifier les champs à gauche : le bundle est calculé à partir de tes entrées, sans “Load example”.
        </div>

        <div class="mini-actions" aria-label="Actions sortie">
          <button class="mini" id="copyHash">Copier le hachage</button>
          <button class="mini" id="copyJson">Copier le JSON</button>
          <button class="mini mini-primary" id="downloadJson">Télécharger JSON</button>
        </div>

        <div style="margin-top:12px; border-top:1px solid rgba(212,175,55,0.12); padding-top:10px; color:rgba(179,164,139,.88); line-height:1.6; text-align:justify;">
          RPO = JSON signé (logique) + vue prête à imprimer + hash public. Le hash garantit l’intégrité (pas la “vérité”).
          Vérification publique. Responsabilité humaine.
          <div style="margin-top:10px; font-family:var(--mono); color:rgba(241,230,163,.78); word-break:break-word;">
            hash : <span id="hashLine">—</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS (clean, centered) -->
    <div class="actions" aria-label="Actions globales">
      <button class="btn btn-primary" id="generateBtn">Générer</button>
      <button class="btn" id="loadExampleBtn">Exemple de chargement</button>
      <button class="btn" id="resetBtn">Réinitialiser</button>
    </div>

    <!-- TECH / HYPOTHESES (moved DOWN + collapsible) -->
    <details class="tech">
      <summary>
        <div class="sum-left">
          <div class="sum-title">Informations techniques & hypothèses</div>
          <div class="sum-sub">Ce qui est utile pour l’audit — mais inutile à la première lecture.</div>
        </div>
        <div class="chev">⌄</div>
      </summary>

      <div class="tech-body">
        <div class="tcard">
          <h4>Données manquantes connues</h4>
          <p id="techMissingText">
            À compléter : preuves non attribuables, KPI non attestés, historique non scellé, etc.
          </p>
        </div>
        <div class="tcard">
          <h4>Contraintes (facultatives)</h4>
          <p id="techConstraintsText">
            Ex : urgence, fenêtre d’audit, sensibilité sociale, continuité d’activité.
          </p>
        </div>
        <div class="tcard">
          <h4>Local uniquement</h4>
          <p>
            Aucune donnée n’est envoyée. Le bundle est généré dans ton navigateur.
            Règles déterministes uniquement.
          </p>
        </div>
      </div>
    </details>

    <div class="bottom">
      <div>© OpenProof — RPO v0.1. Bac à sable déterministe (local-only).</div>
      <div>
        <a href="./spec.html" target="_blank" rel="noopener noreferrer">Spécifications</a> ·
        <a href="./index.html" target="_blank" rel="noopener noreferrer">Accueil</a> ·
        <a href="./examples.html" target="_blank" rel="noopener noreferrer">Exemples</a>
      </div>
    </div>
  </main>

  <script>
    /**********************
     * Background starfield
     **********************/
    (function () {
      const canvas = document.getElementById("bg-field");
      const ctx = canvas.getContext("2d", { alpha: true });

      let width, height, particles = [];
      const COUNT = 200;

      function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        const ratio = window.devicePixelRatio || 1;
        canvas.width = width * ratio;
        canvas.height = height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      }

      function createParticle() {
        return {
          x: (Math.random() * 2 - 1),
          y: (Math.random() * 2 - 1),
          z: Math.random() * 0.9 + 0.1,
          speed: Math.random() * 0.004 + 0.0015
        };
      }

      function init() {
        particles = [];
        for (let i = 0; i < COUNT; i++) particles.push(createParticle());
      }

      function project(p) {
        const f = 420;
        const s = f / (f * p.z);
        return {
          x: p.x * width * 0.5 * s + width / 2,
          y: p.y * height * 0.5 * s + height / 2
        };
      }

      function loop() {
        ctx.clearRect(0, 0, width, height);
        for (const p of particles) {
          p.z -= p.speed;
          if (p.z < 0.08) {
            Object.assign(p, createParticle());
            p.z = 1;
          }
          const { x, y } = project(p);
          const a = Math.min(1, (1.2 - p.z) * 1.1);
          ctx.fillStyle = `rgba(241,230,163,${0.50 * a})`;
          ctx.beginPath();
          ctx.arc(x, y, 1.4, 0, Math.PI * 2);
          ctx.fill();
        }
        requestAnimationFrame(loop);
      }

      window.addEventListener("resize", resize);
      resize(); init(); loop();
    })();

    /**********************
     * Deterministic bundle simulator
     **********************/
    const $ = (id) => document.getElementById(id);

    const els = {
      decisionType: $("decisionType"),
      momentT: $("momentT"),
      scope: $("scope"),
      owner: $("owner"),
      context: $("context"),
      srcChecks: Array.from(document.querySelectorAll(".srcChk")),

      // cockpit
      cScope: $("cScope"),
      cMoment: $("cMoment"),
      cCoverage: $("cCoverage"),
      cDef: $("cDef"),

      // metrics
      mCoverage: $("mCoverage"),
      mMissing: $("mMissing"),
      mDef: $("mDef"),
      mSeal: $("mSeal"),

      // output
      outputBox: $("outputBox"),
      hashLine: $("hashLine"),

      // tabs
      tabSummary: $("tabSummary"),
      tabJson: $("tabJson"),
      tabPdf: $("tabPdf"),

      // buttons
      generateBtn: $("generateBtn"),
      loadExampleBtn: $("loadExampleBtn"),
      resetBtn: $("resetBtn"),
      copyHash: $("copyHash"),
      copyJson: $("copyJson"),
      downloadJson: $("downloadJson"),

      // tech
      techMissingText: $("techMissingText"),
      techConstraintsText: $("techConstraintsText"),
    };

    const TOTAL_SOURCES = () => els.srcChecks.length;

    function todayISO(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Ensure momentT has a default (so it "works" without example)
    if (!els.momentT.value) els.momentT.value = todayISO();

    function getCheckedSources(){
      return els.srcChecks.filter(c => c.checked).map(c => c.dataset.key);
    }

    function coveragePercent(checkedCount){
      const total = TOTAL_SOURCES();
      if (total === 0) return 0;
      return Math.round((checkedCount / total) * 100);
    }

    // Simple deterministic heuristics (no AI) for "missing" and "defensibility"
    function computeMissing(coverage, ctx){
      let missing = 0;

      // If coverage is weak, count missing
      if (coverage < 60) missing += 2;
      else if (coverage < 80) missing += 1;

      // If context is too short, count missing
      const len = (ctx || "").trim().length;
      if (len < 60) missing += 1;

      return missing;
    }

    function computeDefensibility(coverage, missing){
      // Rule-of-thumb (deterministic)
      if (coverage >= 85 && missing === 0) return "HIGH";
      if (coverage >= 75 && missing <= 1) return "MEDIUM";
      return "LOW";
    }

    function stableStringify(obj){
      // Deterministic JSON stringify (sorted keys)
      const allKeys = [];
      JSON.stringify(obj, (k, v) => { allKeys.push(k); return v; });
      allKeys.sort();
      return JSON.stringify(obj, allKeys, 2);
    }

    async function sha256Hex(str){
      const enc = new TextEncoder();
      const buf = enc.encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function setTab(selected){
      const map = [
        { el: els.tabSummary, key: "summary" },
        { el: els.tabJson, key: "json" },
        { el: els.tabPdf, key: "pdf" }
      ];
      map.forEach(x => x.el.setAttribute("aria-selected", String(x.key === selected)));
      state.view = selected;
      renderOutput();
    }

    function formatSummary(bundle){
      return [
        `Decision: ${bundle.decision.type}`,
        `Portée:  ${bundle.decision.scope}`,
        `Owner:   ${bundle.decision.owner}`,
        `Moment T:${bundle.decision.momentT}`,
        ``,
        `Sources déclarées: ${bundle.sources.declared.join(", ") || "—"}`,
        `Règles: déterministes (local-only)`,
        ``,
        `Synthèse exécutive:`,
        `- Ce bundle fige périmètre + sources déclarées + règles déterministes.`,
        `- Il permet une reconstruction audit / litige sans improvisation a posteriori.`,
        `- Le hash prouve l’intégrité dans le temps (pas la “vérité”).`,
        ``,
        `hash (sha256): ${bundle.hash.sha256}`,
      ].join("\n");
    }

    function formatPdfText(bundle){
      // We render a "print view" in a new window (pseudo-PDF via browser print)
      return `
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RPO — Aperçu imprimable</title>
<style>
  body{font-family: Inter, system-ui, -apple-system, sans-serif; padding:32px; color:#111}
  h1{font-family: Orbitron, sans-serif; letter-spacing:.06em; text-transform:uppercase; font-size:18px; margin:0 0 10px}
  .meta{margin:12px 0 18px; font-size:13px; line-height:1.6}
  .box{border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0}
  .k{color:#555; font-weight:600}
  pre{white-space:pre-wrap; word-break:break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}
  .small{font-size:12px; color:#666}
</style>
</head>
<body>
  <h1>RPO v0.1 — Dossier de préparation à la décision</h1>
  <div class="meta">
    <div><span class="k">Décision</span> : ${escapeHtml(bundle.decision.type)}</div>
    <div><span class="k">Portée</span> : ${escapeHtml(bundle.decision.scope)}</div>
    <div><span class="k">Owner</span> : ${escapeHtml(bundle.decision.owner)}</div>
    <div><span class="k">Moment T</span> : ${escapeHtml(bundle.decision.momentT)}</div>
  </div>

  <div class="box">
    <div class="k">Sources déclarées</div>
    <div class="small">${escapeHtml(bundle.sources.declared.join(", ") || "—")}</div>
  </div>

  <div class="box">
    <div class="k">Contexte (moment T)</div>
    <pre>${escapeHtml(bundle.decision.context || "—")}</pre>
  </div>

  <div class="box">
    <div class="k">Indicateurs</div>
    <div class="small">Couverture probatoire : ${bundle.metrics.coveragePct}%</div>
    <div class="small">Manquant : ${bundle.metrics.missing}</div>
    <div class="small">Défendabilité : ${bundle.metrics.defensibility}</div>
  </div>

  <div class="box">
    <div class="k">Hash public (SHA-256)</div>
    <pre>${escapeHtml(bundle.hash.sha256)}</pre>
  </div>

  <div class="small">
    Ce document prouve l’intégrité (stabilité) du bundle, pas la “vérité”.
    Généré localement, règles déterministes uniquement.
  </div>

<script>
  window.onload = () => window.print();
</script>
</body>
</html>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const state = {
      view: "summary",
      lastBundle: null,
      lastJson: "",
      lastHash: ""
    };

    function updateCockpit(bundle){
      els.cScope.textContent = (bundle?.decision?.scope || "—");
      els.cMoment.textContent = (bundle?.decision?.momentT || "—");
      els.cCoverage.textContent = bundle ? `${bundle.metrics.coveragePct}%` : "—";
      els.cDef.textContent = bundle ? bundle.metrics.defensibility : "—";
    }

    function updateMetrics(bundle){
      els.mCoverage.textContent = bundle ? `${bundle.metrics.coveragePct}%` : "—";
      els.mMissing.textContent = bundle ? String(bundle.metrics.missing) : "—";
      els.mDef.textContent = bundle ? bundle.metrics.defensibility : "—";
      els.mSeal.textContent = bundle ? "SHA-256 scellé" : "—";
      els.hashLine.textContent = bundle ? bundle.hash.sha256 : "—";
    }

    function renderOutput(){
      const b = state.lastBundle;
      if (!b){
        els.outputBox.textContent = `Clique sur “GÉNÉRER”.\n\nTu peux aussi modifier les champs à gauche : le bundle est calculé à partir de tes entrées, sans “Load example”.`;
        return;
      }

      if (state.view === "summary"){
        els.outputBox.textContent = formatSummary(b);
      } else if (state.view === "json"){
        els.outputBox.textContent = state.lastJson;
      } else if (state.view === "pdf"){
        els.outputBox.textContent =
          `PDF (impression)\n\nClique ici : “Télécharger JSON” ne fait pas le PDF.\nPour l’aperçu imprimable : on ouvre une fenêtre et ton navigateur génère le PDF via “Imprimer”.\n\n→ Clique sur l’onglet PDF puis sur “Ouvrir l’aperçu imprimable”.`;
        // Add a one-off helper button inside output area (without ruining layout)
        // We keep it simple: open print view immediately when selecting tab PDF.
      }
    }

    async function buildBundle(){
      const type = els.decisionType.value.trim();
      const momentT = (els.momentT.value || todayISO());
      const scope = els.scope.value.trim() || "—";
      const owner = els.owner.value.trim() || "—";
      const context = els.context.value.trim();

      const declared = getCheckedSources();
      const cov = coveragePercent(declared.length);
      const missing = computeMissing(cov, context);
      const def = computeDefensibility(cov, missing);

      // Deterministic payload
      const bundle = {
        spec: { name: "OpenProof RPO", version: "v0.1", mode: "local-only", ai: "none" },
        decision: { type, momentT, scope, owner, context },
        sources: { declared },
        rules: {
          deterministic: true,
          notes: "Same input → same output. Hash proves integrity, not truth."
        },
        metrics: {
          coveragePct: cov,
          missing,
          defensibility: def
        },
        hash: { sha256: "" }
      };

      // Stable stringify → sha
      const jsonStable = stableStringify(bundle);
      const hash = await sha256Hex(jsonStable);

      bundle.hash.sha256 = hash;

      // Re-stringify with hash filled (still deterministic because we fill it deterministically)
      const jsonFinal = stableStringify(bundle);

      state.lastBundle = bundle;
      state.lastJson = jsonFinal;
      state.lastHash = hash;

      updateCockpit(bundle);
      updateMetrics(bundle);

      // Tech panel texts (kept minimal and not ugly)
      els.techMissingText.textContent =
        missing === 0
          ? "Aucun manque détecté par règles déterministes (couverture + contexte)."
          : `Manques probables (heuristiques déterministes) : ${missing}. Ex : preuve non attribuable, KPI non attesté, contexte trop court, etc.`;

      els.techConstraintsText.textContent =
        "Si besoin, documente ici : urgence, fenêtre d’audit, sensibilité sociale, continuité d’activité. (À implémenter en v0.1.1 si tu veux.)";

      renderOutput();
    }

    // Buttons
    els.generateBtn.addEventListener("click", async () => {
      await buildBundle();
    });

    els.loadExampleBtn.addEventListener("click", () => {
      els.decisionType.value = "Nomination / rôle sensible";
      els.momentT.value = "2026-01-28";
      els.scope.value = "Company X — France scope (multi-sites, multi-entités)";
      els.owner.value = "CEO / Executive committee";
      els.context.value =
`Décision sensible en environnement régulé. Exigence de traçabilité des sources et stabilité des définitions.
La décision peut être contestée et doit rester vérifiable dans le temps.`;

      // Example checks (deterministic)
      els.srcChecks.forEach(c => c.checked = false);
      const on = new Set(["lms","hris","perf","ops","legal"]);
      els.srcChecks.forEach(c => { if (on.has(c.dataset.key)) c.checked = true; });

      // Immediately build (so user sees it “work”)
      buildBundle();
    });

    els.resetBtn.addEventListener("click", () => {
      els.decisionType.value = "Nomination / rôle sensible";
      els.momentT.value = todayISO();
      els.scope.value = "Company X — multi-sites, multi-entités";
      els.owner.value = "CEO / Executive committee";
      els.context.value = "Environnement régulé. Exposition audit. Décision potentiellement contestable. Traçabilité des sources déclarées et stabilité des définitions requises.";
      els.srcChecks.forEach(c => c.checked = false);
      // default sensible baseline
      ["lms","hris","perf","ops","legal"].forEach(k => {
        const el = els.srcChecks.find(x => x.dataset.key === k);
        if (el) el.checked = true;
      });

      state.lastBundle = null;
      state.lastJson = "";
      state.lastHash = "";
      updateCockpit(null);
      updateMetrics(null);
      setTab("summary");
      renderOutput();
    });

    // Tabs
    els.tabSummary.addEventListener("click", () => setTab("summary"));
    els.tabJson.addEventListener("click", () => setTab("json"));
    els.tabPdf.addEventListener("click", () => {
      setTab("pdf");
      // open print view if bundle exists
      if (state.lastBundle){
        const w = window.open("", "_blank", "noopener,noreferrer");
        w.document.open();
        w.document.write(formatPdfText(state.lastBundle));
        w.document.close();
      }
    });

    // Copy / download
    els.copyHash.addEventListener("click", async () => {
      if (!state.lastHash) return;
      await navigator.clipboard.writeText(state.lastHash);
      els.copyHash.textContent = "Hachage copié";
      setTimeout(()=>els.copyHash.textContent="Copier le hachage", 1200);
    });

    els.copyJson.addEventListener("click", async () => {
      if (!state.lastJson) return;
      await navigator.clipboard.writeText(state.lastJson);
      els.copyJson.textContent = "JSON copié";
      setTimeout(()=>els.copyJson.textContent="Copier le JSON", 1200);
    });

    els.downloadJson.addEventListener("click", () => {
      if (!state.lastJson) return;
      const blob = new Blob([state.lastJson], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "decision_bundle.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Cockpit updates when user edits inputs (lightweight, not rebuilding hash)
    function updateCockpitPreview(){
      els.cScope.textContent = els.scope.value.trim() || "—";
      els.cMoment.textContent = els.momentT.value || todayISO();
      const declared = getCheckedSources();
      const cov = coveragePercent(declared.length);
      const miss = computeMissing(cov, els.context.value || "");
      const def = computeDefensibility(cov, miss);
      els.cCoverage.textContent = `${cov}%`;
      els.cDef.textContent = def;
    }
    ["input","change"].forEach(ev => {
      [els.scope, els.momentT, els.context, ...els.srcChecks].forEach(el => el.addEventListener(ev, updateCockpitPreview));
    });
    updateCockpitPreview();
  </script>
</body>
</html>


