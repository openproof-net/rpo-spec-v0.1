<!DOCTYPE html>
<html lang="en" data-page="sandbox">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof — RPO v0.1 | HR Decision Sandbox</title>

  <meta name="description" content="HR Decision Sandbox — deterministic decision defensibility bundle: coverage, missing data, risks, hypotheses, public sha256, exportable decision_bundle.json. No AI. No storage." />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://rpo.openproof.net/sandbox.html" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@500;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-deep:#04040e;
      --bg-mid:#0b0f14;

      --gold-soft:#f1e6a3;
      --gold:#d4af37;
      --gold-deep:#8f7633;

      --ivory:#f7f3e8;
      --ink-soft:#b3a48b;
      --ink:#d8cfba;

      --radius:26px;
      --shadow-soft:0 26px 70px rgba(0,0,0,0.55);

      --panel:linear-gradient(145deg, rgba(10,12,27,0.97), rgba(5,7,18,0.98));
      --panel2:linear-gradient(180deg, rgba(10,12,27,0.55), rgba(5,7,18,0.70));
      --line:rgba(212,175,55,0.22);
      --line2:rgba(136,116,72,0.35);

      --cta1:#ffdfb0;
      --cta2:#f48b45;

      --ok:#46ff99;
      --warn:#ffb35a;
      --bad:#ff5a7a;

      --focus: 0 0 0 3px rgba(241,230,163,0.22), 0 0 0 1px rgba(212,175,55,0.35);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    body{
      min-height:100vh;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      color:var(--ivory);
      background:
        radial-gradient(circle at 10% -10%, rgba(241,230,163,0.25), transparent 55%),
        radial-gradient(circle at 90% 110%, rgba(241,230,163,0.18), transparent 55%),
        linear-gradient(180deg, #050712, #020208 60%, #050712 100%);
      overflow-x:hidden;
    }

    a{color:inherit}
    a:focus-visible, button:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible{
      outline:none; box-shadow: var(--focus); border-radius: 12px;
    }

    #bg-field{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:-1;
    }

    .top-bar{
      position:fixed;
      top:0; left:0; right:0;
      height:68px;
      padding:0 40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:10;
      background:linear-gradient(to bottom, rgba(4,4,14,0.96), rgba(4,4,14,0.88), transparent);
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(212,175,55,0.22);
    }

    .top-left{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 280px;
    }

    .emblem{
      width:34px;
      height:34px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0, #f1e6a3, #d4af37 60%, #8f7633 100%);
      box-shadow:0 0 18px rgba(241,230,163,0.8);
      flex: 0 0 auto;
    }

    .brand{
      font-family:"Orbitron",sans-serif;
      font-size:0.72rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--ink-soft);
      white-space:nowrap;
    }
    .brand span{color:var(--gold-soft)}

    .top-nav{
      display:flex;
      gap:22px;
      font-size:0.86rem;
      color:var(--ink-soft);
      align-items:center;
      justify-content:center;
      flex: 1 1 auto;
    }
    .top-nav a{
      color:inherit;
      text-decoration:none;
      position:relative;
      padding-bottom:3px;
      white-space:nowrap;
    }
    .top-nav a::after{
      content:"";
      position:absolute;
      left:0; bottom:0;
      width:0; height:1px;
      background:linear-gradient(90deg,var(--gold-soft),var(--gold));
      transition:width .2s ease;
    }
    .top-nav a:hover::after{width:100%}
    .top-nav a[aria-current="page"]{
      color: var(--gold-soft);
    }
    .top-nav a[aria-current="page"]::after{width:100%}

    .top-cta{
      padding:8px 18px;
      border-radius:999px;
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, #ffdfb0, #f48b45);
      color:#2a1204;
      font-size:0.8rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-decoration:none;
      white-space:nowrap;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    main{
      padding:96px 40px 78px;
      min-height:100vh;
    }

    .shell{
      width:min(1240px, 92vw);
      margin:0 auto;
      position:relative;
    }

    .page-title{
      font-family:"Orbitron",sans-serif;
      font-size:.75rem;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:var(--ink-soft);
      margin-bottom:14px;
    }
    .page-title span{color:var(--gold-soft)}

    h1{
      font-family:"Orbitron",sans-serif;
      text-transform:uppercase;
      letter-spacing:.06em;
      line-height:1.08;
      font-size:clamp(2rem,4.2vw,3.05rem);
      margin-bottom:14px;
      max-width: 900px;
    }
    h1 .l2{display:block;color:var(--gold-soft)}
    h1 .l3{display:block;color:var(--gold)}

    .lead{
      max-width: 900px;
      font-size:1.02rem;
      line-height:1.75;
      color:rgba(179,164,139,.95);
      margin-bottom:18px;
    }

    .meta-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:18px;
      max-width: 900px;
    }
    .chip{
      display:inline-flex;
      gap:10px;
      align-items:center;
      font-size:.72rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(241,230,163,.35);
      background: rgba(10,12,27,0.35);
      backdrop-filter: blur(10px);
      color: rgba(241,230,163,.92);
      user-select:none;
    }
    .chip .dot{
      width:7px;height:7px;border-radius:99px;
      background: rgba(241,230,163,.9);
      box-shadow:0 0 12px rgba(241,230,163,.55);
    }

    .note{
      max-width: 900px;
      font-size:.92rem;
      line-height:1.6;
      color:rgba(198,186,150,.88);
      margin-bottom:22px;
    }

    .input-panel{
      max-width: 900px;
      background: var(--panel);
      border-radius: var(--radius);
      border:1px solid rgba(212,175,55,0.45);
      box-shadow: var(--shadow-soft);
      padding:22px;
      position:relative;
      overflow:hidden;
    }
    .input-panel::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      border:1px solid rgba(241,230,163,0.16);
      pointer-events:none;
    }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex; flex-direction:column; gap:7px;
    }
    .field.full{grid-column:1 / -1}

    label{
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
    }
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(212,175,55,0.25);
      background: rgba(7,8,20,0.55);
      color: rgba(247,243,232,0.92);
      padding:10px 12px;
      font-size:.96rem;
      outline:none;
      backdrop-filter: blur(10px);
    }
    textarea{
      min-height:130px;
      resize:vertical;
      line-height:1.6;
    }
    input::placeholder, textarea::placeholder{color: rgba(179,164,139,.68)}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(241,230,163,0.55);
      box-shadow:0 0 0 4px rgba(212,175,55,0.12);
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .card-mini{
      border:1px solid rgba(212,175,55,.18);
      background: rgba(7,8,20,0.35);
      border-radius:16px;
      padding:12px;
    }

    .checkgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      margin-top:6px;
    }
    .check{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.18);
      background: rgba(10,12,27,0.30);
    }
    .check input{
      width:auto;
      margin-top:2px;
      accent-color: var(--gold);
    }
    .check .t{
      font-size:.92rem;
      line-height:1.35;
      color:rgba(247,243,232,.92);
    }
    .check .s{
      display:block;
      font-size:.78rem;
      color:rgba(179,164,139,.88);
      margin-top:2px;
    }

    .btn-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:14px;
    }
    .btn-primary{
      padding:12px 22px;
      border-radius:999px;
      border:1px solid rgba(244,186,120,0.9);
      background:radial-gradient(circle at 20% 0, var(--cta1), var(--cta2));
      color:#2a1204;
      font-size:.8rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      text-decoration:none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      cursor:pointer;
    }
    .btn-ghost{
      padding:12px 18px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(10,12,27,0.35);
      color: var(--gold-soft);
      font-size:.8rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-decoration:none;
      backdrop-filter: blur(10px);
      cursor:pointer;
    }
    .fineprint{
      margin-top:12px;
      font-size:.86rem;
      line-height:1.6;
      color:rgba(179,164,139,.92);
      border-top:1px solid rgba(212,175,55,0.20);
      padding-top:12px;
    }

    .float-wrap{
      position:absolute;
      top: 112px;
      right: 0;
      width: min(420px, 36vw);
      transform: translateX(12px);
    }

    .float{
      position: sticky;
      top: 92px;
      background: var(--panel);
      border-radius: var(--radius);
      border:1px solid rgba(212,175,55,0.45);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      isolation:isolate;
    }
    .float::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 30% 10%, rgba(241,230,163,0.16), transparent 45%),
        linear-gradient(90deg, transparent 0%, rgba(241,230,163,0.10) 45%, transparent 60%);
      transform: rotate(18deg);
      animation: sheen 5.8s ease-in-out infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      z-index:0;
    }
    .float::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 0%, rgba(241,230,163,0.10), transparent 55%);
      opacity:.75;
      pointer-events:none;
      z-index:0;
    }
    @keyframes sheen{
      0%{ transform: translateX(-12%) rotate(18deg); opacity:.45 }
      50%{ transform: translateX(10%) rotate(18deg); opacity:.80 }
      100%{ transform: translateX(-12%) rotate(18deg); opacity:.45 }
    }

    .float-inner{
      position:relative;
      z-index:1;
      padding:18px 18px 16px;
    }

    .float-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .float-title{
      font-family:"Orbitron",sans-serif;
      font-size:.85rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(179,164,139,.95);
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid rgba(241,230,163,.30);
      background: rgba(10,12,27,0.35);
      padding:7px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(241,230,163,.92);
      user-select:none;
      white-space:nowrap;
    }
    .pulse{
      width:8px;height:8px;border-radius:99px;
      background: rgba(241,230,163,.85);
      box-shadow:0 0 16px rgba(241,230,163,.65);
      animation: pulse 1.4s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{transform:scale(1); opacity:.7}
      50%{transform:scale(1.35); opacity:1}
    }

    .steps{
      margin-top:10px;
      border-top:1px solid rgba(212,175,55,.22);
      padding-top:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .step{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.18);
      background: rgba(7,8,20,0.35);
      padding:10px 10px;
      min-height:52px;
    }
    .step .k{
      font-family:"Orbitron",sans-serif;
      font-size:.62rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(179,164,139,.92);
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .step .v{
      font-size:.92rem;
      color:rgba(247,243,232,.92);
      line-height:1.35;
      word-break:break-word;
    }

    .progress{
      margin-top:12px;
      border-top:1px solid rgba(212,175,55,.18);
      padding-top:12px;
      display:flex;
      align-items:center;
      gap:10px;
      color:rgba(179,164,139,.92);
      font-size:.78rem;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-family:"Orbitron",sans-serif;
    }
    .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background: rgba(241,230,163,.08);
      border:1px solid rgba(212,175,55,.20);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 14%;
      background: linear-gradient(90deg, rgba(241,230,163,.25), rgba(212,175,55,.65));
      border-radius:999px;
      transform: translateX(0);
      transition: width .45s ease;
    }
    .sync{opacity:.82;}

    .tabs{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(212,175,55,.25);
      background: rgba(10,12,27,0.35);
      color: rgba(241,230,163,.88);
      padding:8px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
    }
    .tab[aria-selected="true"]{
      border-color: rgba(212,175,55,.55);
      background: rgba(7,8,20,0.70);
      color: var(--gold-soft);
    }

    .pane{
      margin-top:12px;
      border-top:1px solid rgba(212,175,55,.18);
      padding-top:12px;
      display:none;
    }
    .pane.active{display:block}

    .kv{
      display:flex;
      justify-content:space-between;
      gap:14px;
      padding:8px 0;
      color:rgba(179,164,139,.95);
      font-size:.9rem;
    }
    .kv + .kv{border-top:1px dashed var(--line2)}
    .kv .r{color:rgba(241,230,163,.90); text-align:right}
    .kv .r small{opacity:.85}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.68rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid rgba(241,230,163,.25);
      background: rgba(10,12,27,0.35);
      color: rgba(241,230,163,.92);
      user-select:none;
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(70,255,153,.35); color: rgba(70,255,153,.95)}
    .badge.warn{border-color: rgba(255,179,90,.35); color: rgba(255,179,90,.95)}
    .badge.bad{border-color: rgba(255,90,122,.45); color: rgba(255,90,122,.95)}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:.84rem;
      line-height:1.55;
      background: rgba(7,8,20,0.82);
      border:1px solid rgba(212,175,55,.22);
      border-radius:16px;
      padding:10px 10px;
      color:rgba(247,243,232,.90);
      max-height: 220px;
      overflow:auto;
      white-space:pre;
    }

    .mini-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn-mini{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(10,12,27,0.35);
      color: var(--gold-soft);
      font-size:.72rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }

    .verify-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .verify-grid label{margin-top:2px}
    .verify-result{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(212,175,55,.18);
      background: rgba(7,8,20,0.35);
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge-result{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-family:"Orbitron",sans-serif;
      font-size:.70rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid rgba(241,230,163,.25);
      color: rgba(241,230,163,.92);
      background: rgba(10,12,27,0.35);
      user-select:none;
      white-space:nowrap;
    }
    .badge-result.ok{border-color: rgba(70,255,153,.35); color: rgba(70,255,153,.95)}
    .badge-result.bad{border-color: rgba(255,90,122,.45); color: rgba(255,90,122,.95)}
    .badge-result.muted{opacity:.85}

    .content-pad{ padding-right: clamp(0px, 40vw, 460px); }

    @media(max-width:1040px){
      .float-wrap{ position:relative; width:100%; transform:none; margin-top:18px; }
      .float{position:relative; top:auto}
      .content-pad{padding-right:0}
    }
    @media(max-width:960px){
      .top-nav{display:none}
      .top-bar{padding:0 16px}
      main{padding:96px 20px 72px}
      .form-grid{grid-template-columns:1fr}
      .split{grid-template-columns:1fr}
      .checkgrid{grid-template-columns:1fr}
      .top-left{min-width:auto}
    }
    @media (prefers-reduced-motion: reduce){
      .float::before, .pulse{animation:none}
      .top-nav a::after{transition:none}
      .bar > i{transition:none}
    }

    .sr-only{
      position:absolute;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }
  </style>
</head>

<body>
  <canvas id="bg-field" aria-hidden="true"></canvas>

  <header class="top-bar">
    <div class="top-left">
      <div class="emblem" aria-hidden="true"></div>
      <div class="brand">OPENPROOF<span>.NET — HR DECISION SANDBOX</span></div>
    </div>

    <nav class="top-nav" aria-label="Primary">
      <a href="./index.html" target="_blank" rel="noopener noreferrer">Home</a>
      <a href="./sandbox.html" aria-current="page">Sandbox</a>
      <a href="./how-it-works.html" target="_blank" rel="noopener noreferrer">How it works</a>
      <a href="./spec.html" target="_blank" rel="noopener noreferrer">Spec</a>
      <a href="./tests.html" target="_blank" rel="noopener noreferrer">Tests</a>
      <a href="./examples.html" target="_blank" rel="noopener noreferrer">Examples</a>
    </nav>

    <a href="#input" class="top-cta">Try the live demo</a>
  </header>

  <main>
    <div class="shell">
      <div class="content-pad">
        <div class="page-title">Live demo <span>for governed HR decisions</span></div>

        <h1>
          Sandbox,
          <span class="l2">from HR data to defensible decision.</span>
          <span class="l3">Same inputs → same accountability bundle.</span>
        </h1>

        <p class="lead">
          This demo does not “pick the best candidate”.
          It produces a deterministic <span style="color:var(--gold-soft)">Decision Readiness Report</span>:
          coverage, missing data, explicit hypotheses, and a <span style="color:var(--gold)">defensibility level</span>.
          No AI. No storage. Humans remain accountable.
        </p>

        <div class="meta-row" aria-label="Demo guarantees">
          <div class="chip"><span class="dot"></span> No AI</div>
          <div class="chip"><span class="dot"></span> Local only</div>
          <div class="chip"><span class="dot"></span> Deterministic</div>
          <div class="chip"><span class="dot"></span> Opposable structure</div>
        </div>

        <p class="note">
          Bad decisions are not the problem. Undocumented decisions are.
        </p>

        <section id="input" class="input-panel" aria-label="Decision input">
          <div class="form-grid">
            <div class="field">
              <label for="decisionType">Decision type</label>
              <select id="decisionType">
                <option value="internal_dg" selected>Internal DG appointment</option>
                <option value="succession">Succession planning decision</option>
                <option value="promotion">Promotion to leadership</option>
                <option value="reorg_role">Reorg role allocation</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="field">
              <label for="decisionDate">Decision date (moment T)</label>
              <input id="decisionDate" type="text" placeholder="Example: 2026-01-28" />
            </div>

            <div class="field">
              <label for="orgLabel">Organisation / perimeter</label>
              <input id="orgLabel" type="text" placeholder="Example: Company X — France scope" />
            </div>

            <div class="field">
              <label for="issuer">Decision owner</label>
              <input id="issuer" type="text" placeholder="Example: CEO / Executive committee" />
            </div>

            <div class="field full">
              <label>Selected data sources (what was реально disponible)</label>
              <div class="card-mini">
                <div class="checkgrid" role="group" aria-label="Sources">
                  <label class="check">
                    <input type="checkbox" id="srcLMS" checked />
                    <div>
                      <span class="t">LMS / training records</span>
                      <span class="s">Documented trainings, certifications, completions</span>
                    </div>
                  </label>

                  <label class="check">
                    <input type="checkbox" id="srcHRIS" checked />
                    <div>
                      <span class="t">HRIS / job history</span>
                      <span class="s">Roles, seniority, mobility, grade changes</span>
                    </div>
                  </label>

                  <label class="check">
                    <input type="checkbox" id="srcPerf" checked />
                    <div>
                      <span class="t">Performance reviews</span>
                      <span class="s">Official annual reviews, objectives, ratings</span>
                    </div>
                  </label>

                  <label class="check">
                    <input type="checkbox" id="srcMobility" />
                    <div>
                      <span class="t">Mobility & exposure</span>
                      <span class="s">International, transversal scope, P&L exposure</span>
                    </div>
                  </label>

                  <label class="check">
                    <input type="checkbox" id="srcOps" />
                    <div>
                      <span class="t">Operational outcomes</span>
                      <span class="s">Turnover, engagement, delivery KPIs (attested)</span>
                    </div>
                  </label>

                  <label class="check">
                    <input type="checkbox" id="src360" />
                    <div>
                      <span class="t">360 / feedback</span>
                      <span class="s">If documented and attributable</span>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <div class="field full">
              <label>Candidate snapshots (deterministic coverage)</label>
              <div class="split">
                <div class="card-mini">
                  <label for="candA">Candidate A — notes (official elements only)</label>
                  <textarea id="candA" placeholder="Example: 20y tenure, 3 roles, 2 leadership roles, last rating: exceeds..."></textarea>
                </div>
                <div class="card-mini">
                  <label for="candB">Candidate B — notes (official elements only)</label>
                  <textarea id="candB" placeholder="Example: 12y tenure, mobility abroad, mixed ratings, 1 crisis situation..."></textarea>
                </div>
              </div>
              <div class="split" style="margin-top:12px">
                <div class="card-mini">
                  <label for="candC">Candidate C — notes (official elements only)</label>
                  <textarea id="candC" placeholder="Example: 8y tenure, strong ops KPIs, no 360, no international..."></textarea>
                </div>
                <div class="card-mini">
                  <label for="missingData">Known missing data (absence = data)</label>
                  <textarea id="missingData" placeholder="Example: leadership in crisis, international exposure, documented 360 feedback..."></textarea>
                </div>
              </div>
            </div>

            <div class="field full">
              <label for="constraints">Decision constraints (optional)</label>
              <textarea id="constraints" placeholder="Example: urgency, regulatory timeline, union sensitivity, business continuity requirements..."></textarea>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="generateBtn" type="button">Generate decision bundle</button>
            <button class="btn-ghost" id="loadExampleBtn" type="button">Load example</button>
            <button class="btn-ghost" id="resetBtn" type="button">Reset</button>
          </div>

          <div class="fineprint">
            No account, no storage. Refresh clears everything.
            Deterministic rules only: same inputs → same outputs.
          </div>
        </section>
      </div>

      <div class="float-wrap" aria-label="Live decision bundle">
        <aside class="float">
          <div class="float-inner">
            <div class="float-head">
              <div class="float-title">Decision Readiness Report</div>
              <div class="status" id="statusPill"><span class="pulse" aria-hidden="true"></span><span id="statusText">READY</span></div>
            </div>

            <div class="steps" aria-label="Decision steps">
              <div class="step" id="step1">
                <div class="k"><span>Input</span><span id="s1">—</span></div>
                <div class="v" id="vInput">Awaiting snapshots</div>
              </div>
              <div class="step" id="step2">
                <div class="k"><span>Assess</span><span id="s2">—</span></div>
                <div class="v" id="vExtract">Coverage / risks</div>
              </div>
              <div class="step" id="step3">
                <div class="k"><span>Seal</span><span id="s3">—</span></div>
                <div class="v" id="vSeal">Public hash</div>
              </div>
            </div>

            <div class="progress" aria-label="Sync status">
              <span id="readyLabel">READY</span>
              <div class="bar" aria-hidden="true"><i id="barFill"></i></div>
              <span class="sync" id="syncLabel">SYNC</span>
            </div>

            <div class="tabs" role="tablist" aria-label="Bundle tabs">
              <button class="tab" role="tab" aria-selected="true" id="tabBundle" aria-controls="paneBundle">Bundle</button>
              <button class="tab" role="tab" aria-selected="false" id="tabJson" aria-controls="paneJson">JSON</button>
              <button class="tab" role="tab" aria-selected="false" id="tabVerify" aria-controls="paneVerify">Verify</button>
            </div>

            <div class="pane active" id="paneBundle" role="tabpanel" aria-labelledby="tabBundle">
              <div class="kv">
                <span>Coverage (global)</span>
                <span class="r" id="mCoverage">—</span>
              </div>
              <div class="kv">
                <span>Missing data</span>
                <span class="r" id="mMissing">—</span>
              </div>
              <div class="kv">
                <span>Defensibility</span>
                <span class="r" id="mDef"><span class="badge warn">—</span></span>
              </div>

              <div class="kv" style="margin-top:10px; border-top:1px solid rgba(212,175,55,.18); padding-top:10px">
                <span>Candidate A</span>
                <span class="r" id="mA">—</span>
              </div>
              <div class="kv"><span>Candidate B</span><span class="r" id="mB">—</span></div>
              <div class="kv"><span>Candidate C</span><span class="r" id="mC">—</span></div>

              <div class="kv" style="margin-top:10px; border-top:1px solid rgba(212,175,55,.18); padding-top:10px">
                <span>Public hash (sha256)</span>
                <span class="r" id="mHash" style="max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">—</span>
              </div>

              <div class="mini-actions">
                <button class="btn-mini" id="copyHashBtn" type="button">Copy hash</button>
                <button class="btn-mini" id="copyJsonBtn" type="button">Copy JSON</button>
                <button class="btn-mini" id="downloadJsonBtn" type="button">Download decision_bundle.json</button>
              </div>

              <div style="margin-top:10px; color:rgba(179,164,139,.92); font-size:.86rem; line-height:1.55">
                This report is about defensibility, not “truth” and not “recommendation”.
                Governance is not about being right. It’s about being accountable.
              </div>
            </div>

            <div class="pane" id="paneJson" role="tabpanel" aria-labelledby="tabJson">
              <div style="color:rgba(179,164,139,.92); font-size:.86rem; line-height:1.55; margin-bottom:10px">
                Deterministic decision bundle (exportable). Hash verifies integrity of the payload.
              </div>
              <pre class="mono" id="jsonOut">{}</pre>
            </div>

            <div class="pane" id="paneVerify" role="tabpanel" aria-labelledby="tabVerify">
              <div style="color:rgba(179,164,139,.92); font-size:.86rem; line-height:1.55; margin-bottom:10px">
                Paste a payload and a hash. We recompute SHA256 and compare.
              </div>

              <div class="verify-grid">
                <label for="verifyPayload">Payload (JSON or text)</label>
                <textarea id="verifyPayload" style="min-height:120px" placeholder="Paste the payload here..."></textarea>

                <label for="verifyHash">Expected sha256</label>
                <input id="verifyHash" type="text" placeholder="Paste the expected hash..." />

                <div class="mini-actions">
                  <button class="btn-mini" id="verifyBtn" type="button">Verify</button>
                  <button class="btn-mini" id="useLastBtn" type="button">Use last bundle</button>
                </div>

                <div class="verify-result" aria-label="Verify result">
                  <span class="badge-result muted" id="verifyBadge">NO CHECK YET</span>
                  <span style="color:rgba(179,164,139,.92); font-size:.86rem" id="verifyMsg">—</span>
                </div>
              </div>
            </div>

          </div>
        </aside>
      </div>

    </div>
  </main>

  <script>
    /* =========================================================
       Background field (starfield) — visual only
       ========================================================= */
    (function () {
      const canvas = document.getElementById("bg-field");
      const ctx = canvas.getContext("2d", { alpha: true });

      let width, height, particles = [];
      const COUNT = 220;

      function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        const ratio = window.devicePixelRatio || 1;

        canvas.width = width * ratio;
        canvas.height = height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      }

      function createParticle() {
        return {
          x: (Math.random() * 2 - 1),
          y: (Math.random() * 2 - 1),
          z: Math.random() * 0.9 + 0.1,
          speed: Math.random() * 0.004 + 0.0015
        };
      }

      function init() {
        particles = [];
        for (let i = 0; i < COUNT; i++) particles.push(createParticle());
      }

      function project(p) {
        const f = 400;
        const s = f / (f * p.z);
        return {
          x: p.x * width * 0.5 * s + width / 2,
          y: p.y * height * 0.5 * s + height / 2
        };
      }

      function loop() {
        ctx.clearRect(0, 0, width, height);

        const grad = ctx.createRadialGradient(
          width * 0.5, height * 0.18, 0,
          width * 0.5, height * 0.18, width * 0.65
        );
        grad.addColorStop(0, "rgba(241,230,163,0.18)");
        grad.addColorStop(0.42, "rgba(241,230,163,0.04)");
        grad.addColorStop(1, "transparent");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, width, height);

        for (const p of particles) {
          p.z -= p.speed;
          if (p.z < 0.08) {
            Object.assign(p, createParticle());
            p.z = 1;
          }

          const { x, y } = project(p);
          const a = Math.min(1, (1.2 - p.z) * 1.1);

          ctx.fillStyle = `rgba(241,230,163,${0.55 * a})`;
          ctx.beginPath();
          ctx.arc(x, y, 1.6, 0, Math.PI * 2);
          ctx.fill();
        }

        requestAnimationFrame(loop);
      }

      window.addEventListener("resize", resize);
      resize(); init(); loop();
    })();

    /* =========================================================
       Deterministic HR decision logic (no AI)
       ========================================================= */
    const $ = (id) => document.getElementById(id);

    const EXAMPLE = {
      decisionType: "internal_dg",
      decisionDate: "2026-01-28",
      orgLabel: "Company X — France scope",
      issuer: "CEO / Executive committee",
      sources: {
        lms: true,
        hris: true,
        perf: true,
        mobility: false,
        ops: true,
        s360: false
      },
      candA: "20y tenure. 3 roles including 2 leadership roles. Last 2 reviews: exceeds objectives. Documented team retention stable.",
      candB: "12y tenure. 1 leadership role. Mobility abroad not documented in HRIS. Last review: meets objectives. No attested ops KPIs available.",
      candC: "8y tenure. Strong ops delivery KPIs (attested). 1 leadership role. No documented 360 feedback.",
      missingData: "Leadership under crisis; international exposure; documented 360 feedback; comparable ops KPIs for all candidates.",
      constraints: "Urgency: business continuity. Sensitive social climate. Need quick appointment within 30 days."
    };

    const SOURCE_WEIGHTS = [
      { key: "lms",      label: "LMS",       w: 14 },
      { key: "hris",     label: "HRIS",      w: 18 },
      { key: "perf",     label: "PERF",      w: 22 },
      { key: "mobility", label: "MOBILITY",  w: 16 },
      { key: "ops",      label: "OPS",       w: 20 },
      { key: "s360",     label: "360",       w: 10 }
    ];

    const COVERAGE_KEYWORDS = {
      // cheap deterministic proxy: if candidate notes contain these, we treat it as “covered”
      lms:      ["training","certif","certification","course","lms"],
      hris:     ["role","tenure","job","mobility","grade","promotion"],
      perf:     ["review","rating","objectives","meets","exceeds","performance"],
      mobility: ["international","abroad","cross","transversal","global","p&l"],
      ops:      ["kpi","results","delivery","turnover","retention","engagement","ops"],
      s360:     ["360","feedback","peer","manager feedback"]
    };

    function safeText(v){ return (v || "").toString().trim(); }
    function nowISO(){ return new Date().toISOString(); }

    function bool(id){ return !!$(id).checked; }

    function normalizeLower(s){ return safeText(s).toLowerCase(); }

    function selectedSources(){
      return {
        lms: bool("srcLMS"),
        hris: bool("srcHRIS"),
        perf: bool("srcPerf"),
        mobility: bool("srcMobility"),
        ops: bool("srcOps"),
        s360: bool("src360")
      };
    }

    function computeGlobalCoverage(sources){
      const total = SOURCE_WEIGHTS.reduce((a,x)=>a+x.w,0);
      const on = SOURCE_WEIGHTS.reduce((a,x)=> a + (sources[x.key] ? x.w : 0), 0);
      return Math.round(100 * (on / total));
    }

    function computeCandidateCoverage(candidateText, sources){
      const t = normalizeLower(candidateText);
      const totalOn = SOURCE_WEIGHTS.reduce((a,x)=> a + (sources[x.key] ? x.w : 0), 0);

      let covered = 0;
      for (const src of SOURCE_WEIGHTS){
        if (!sources[src.key]) continue; // not available at moment T
        const kws = COVERAGE_KEYWORDS[src.key] || [];
        const hit = kws.some(k => t.includes(k));
        // deterministic: if not mentioned, treat as not evidenced in the snapshot
        covered += hit ? src.w : Math.round(src.w * 0.55); // partial: source exists but candidate snapshot doesn't reference it
      }
      const pct = totalOn > 0 ? Math.round(100 * (covered / totalOn)) : 0;
      return Math.max(0, Math.min(100, pct));
    }

    function countMissingItems(missingText){
      const t = safeText(missingText);
      if (!t) return 0;
      // split by newline, comma, semicolon
      const parts = t
        .split(/[\n,;]+/g)
        .map(x=>x.trim())
        .filter(Boolean);
      return Math.min(12, parts.length);
    }

    function defensibilityLevel(globalCoverage, missingCount, sources){
      // deterministic rule-set:
      // - HIGH: coverage >= 75 and missingCount <= 2 and at least PERF + HRIS are present
      // - MEDIUM: coverage >= 55 and missingCount <= 6
      // - LOW: otherwise
      const hasCore = sources.perf && sources.hris;
      if (globalCoverage >= 75 && missingCount <= 2 && hasCore) return "HIGH";
      if (globalCoverage >= 55 && missingCount <= 6) return "MEDIUM";
      return "LOW";
    }

    function risksFrom(missingText, globalCoverage){
      const risks = [];
      if (globalCoverage < 55) risks.push("Low evidential coverage at moment T");
      const m = normalizeLower(missingText);
      if (m.includes("crisis") || m.includes("crise")) risks.push("Crisis leadership not documented");
      if (m.includes("international") || m.includes("abroad") || m.includes("exposure")) risks.push("International exposure unclear");
      if (m.includes("360") || m.includes("feedback")) risks.push("Feedback/360 not attributable");
      if (m.includes("kpi") || m.includes("ops") || m.includes("turnover") || m.includes("engagement")) risks.push("Operational comparability incomplete");
      if (!risks.length) risks.push("Known gaps explicitly stated; residual uncertainty remains");
      return risks.slice(0, 6);
    }

    async function sha256Hex(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function stablePayload(input, analysis){
      // stable ordering for deterministic hashing
      const srcKeys = Object.keys(input.sources).sort();
      const sources = {};
      srcKeys.forEach(k => sources[k] = !!input.sources[k]);

      const candidates = [...analysis.candidates]
        .map(c => ({ id: c.id, coverage: c.coverage }))
        .sort((a,b)=> a.id.localeCompare(b.id));

      const risks = [...analysis.risks].slice().sort();

      return JSON.stringify({
        v: "0.1",
        decision_type: input.decisionType,
        decision_date: input.decisionDate,
        organisation: input.orgLabel,
        decision_owner: input.issuer,
        sources,
        candidates,
        global_coverage: analysis.globalCoverage,
        missing_count: analysis.missingCount,
        defensibility: analysis.defensibility,
        risks
      });
    }

    function buildDecisionBundle(input, analysis){
      const bundleId = "decision-" + analysis.public_hash.slice(0, 12);

      return {
        rpo_version: "0.1",
        bundle_id: bundleId,
        created_at: nowISO(),

        decision: {
          type: input.decisionType || "other",
          moment_t: input.decisionDate || "—",
          organisation: input.orgLabel || "—",
          owner: input.issuer || "—"
        },

        input_state: {
          sources_available: input.sources,
          candidates_snapshots: {
            A: input.candA || "",
            B: input.candB || "",
            C: input.candC || ""
          },
          known_missing_data: input.missingData || "",
          constraints: input.constraints || ""
        },

        assessment: {
          global_coverage_pct: analysis.globalCoverage,
          missing_items_count: analysis.missingCount,
          candidates: analysis.candidates.map(c => ({
            id: c.id,
            coverage_pct: c.coverage,
            risk_level: c.risk
          })),
          defensibility: analysis.defensibility,
          explicit_hypotheses: analysis.hypotheses,
          known_risks: analysis.risks
        },

        integrity: {
          public_hash_sha256: analysis.public_hash,
          statement: "Hash proves integrity of the payload, not correctness of the decision."
        },

        disclaimer: "Deterministic sandbox. No AI. No storage. Not legal advice."
      };
    }

    function riskLevelFromCoverage(cov){
      if (cov >= 85) return "LOW";
      if (cov >= 65) return "MEDIUM";
      return "UNKNOWN";
    }
(function () {
  const canvas = document.getElementById("bg-field");
  const ctx = canvas.getContext("2d", { alpha: true });
  let width, height, particles = [];
  const COUNT = 220;

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    const ratio = window.devicePixelRatio || 1;
    canvas.width = width * ratio;
    canvas.height = height * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  }

  function createParticle() {
    return {
      x: (Math.random() * 2 - 1),
      y: (Math.random() * 2 - 1),
      z: Math.random() * 0.9 + 0.1,
      speed: Math.random() * 0.004 + 0.0015
    };
  }

  function init() {
    particles = [];
    for (let i = 0; i < COUNT; i++) particles.push(createParticle());
  }

  function project(p) {
    const f = 400;
    const s = f / (f * p.z);
    return {
      x: p.x * width * 0.5 * s + width / 2,
      y: p.y * height * 0.5 * s + height / 2
    };
  }

  function loop() {
    ctx.clearRect(0, 0, width, height);

    const grad = ctx.createRadialGradient(
      width * 0.5, height * 0.18, 0,
      width * 0.5, height * 0.18, width * 0.65
    );
    grad.addColorStop(0, "rgba(241,230,163,0.18)");
    grad.addColorStop(0.42, "rgba(241,230,163,0.04)");
    grad.addColorStop(1, "transparent");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, width, height);

    for (const p of particles) {
      p.z -= p.speed;
      if (p.z < 0.08) {
        Object.assign(p, createParticle());
        p.z = 1;
      }
      const { x, y } = project(p);
      const a = Math.min(1, (1.2 - p.z) * 1.1);
      ctx.fillStyle = `rgba(241,230,163,${0.55 * a})`;
      ctx.beginPath();
      ctx.arc(x, y, 1.6, 0, Math.PI * 2);
      ctx.fill();
    }
    requestAnimationFrame(loop);
  }

  window.addEventListener("resize", resize);
  resize(); init(); loop();
})();

/* =========================================================
Deterministic HR decision logic (no AI)
========================================================= */
const $ = (id) => document.getElementById(id);

const EXAMPLE = {
  decisionType: "internal_dg",
  decisionDate: "2026-01-28",
  orgLabel: "Company X — France scope",
  issuer: "CEO / Executive committee",
  sources: {
    lms: true,
    hris: true,
    perf: true,
    mobility: false,
    ops: true,
    s360: false
  },
  candA: "20y tenure. 3 roles including 2 leadership roles. Last 2 reviews: exceeds objectives. Documented team retention stable.",
  candB: "12y tenure. 1 leadership role. Mobility abroad not documented in HRIS. Last review: meets objectives. No attested ops KPIs available.",
  candC: "8y tenure. Strong ops delivery KPIs (attested). 1 leadership role. No documented 360 feedback.",
  missingData: "Leadership under crisis; international exposure; documented 360 feedback; comparable ops KPIs for all candidates.",
  constraints: "Urgency: business continuity. Sensitive social climate. Need quick appointment within 30 days."
};

const SOURCE_WEIGHTS = [
  { key: "lms",      label: "LMS",      w: 14 },
  { key: "hris",     label: "HRIS",     w: 18 },
  { key: "perf",     label: "PERF",     w: 22 },
  { key: "mobility", label: "MOBILITY", w: 16 },
  { key: "ops",      label: "OPS",      w: 20 },
  { key: "s360",     label: "360",      w: 10 }
];

const COVERAGE_KEYWORDS = {
  lms:      ["training","certif","certification","course","lms"],
  hris:     ["role","tenure","job","mobility","grade","promotion"],
  perf:     ["review","rating","objectives","meets","exceeds","performance"],
  mobility: ["international","abroad","cross","transversal","global","p&l"],
  ops:      ["kpi","results","delivery","turnover","retention","engagement","ops"],
  s360:     ["360","feedback","peer","manager feedback"]
};

function safeText(v){ return (v || "").toString().trim(); }
function nowISO(){ return new Date().toISOString(); }
function bool(id){ return !!$(id).checked; }
function normalizeLower(s){ return safeText(s).toLowerCase(); }

function selectedSources(){
  return {
    lms: bool("srcLMS"),
    hris: bool("srcHRIS"),
    perf: bool("srcPerf"),
    mobility: bool("srcMobility"),
    ops: bool("srcOps"),
    s360: bool("src360")
  };
}

function computeGlobalCoverage(sources){
  const total = SOURCE_WEIGHTS.reduce((a,x)=>a+x.w,0);
  const on = SOURCE_WEIGHTS.reduce((a,x)=> a + (sources[x.key] ? x.w : 0), 0);
  return Math.round(100 * (on / total));
}

function computeCandidateCoverage(candidateText, sources){
  const t = normalizeLower(candidateText);
  const totalOn = SOURCE_WEIGHTS.reduce((a,x)=> a + (sources[x.key] ? x.w : 0), 0);
  let covered = 0;

  for (const src of SOURCE_WEIGHTS){
    if (!sources[src.key]) continue; // not available at moment T
    const kws = COVERAGE_KEYWORDS[src.key] || [];
    const hit = kws.some(k => t.includes(k));
    // deterministic: if not mentioned, treat as not evidenced in the snapshot
    // partial: source exists but candidate snapshot doesn't reference it
    covered += hit ? src.w : Math.round(src.w * 0.55);
  }

  const pct = totalOn > 0 ? Math.round(100 * (covered / totalOn)) : 0;
  return Math.max(0, Math.min(100, pct));
}

function countMissingItems(missingText){
  const t = safeText(missingText);
  if (!t) return 0;
  const parts = t
    .split(/[\n,;]+/g)
    .map(x=>x.trim())
    .filter(Boolean);
  return Math.min(12, parts.length);
}

function defensibilityLevel(globalCoverage, missingCount, sources){
  const hasCore = sources.perf && sources.hris;
  if (globalCoverage >= 75 && missingCount <= 2 && hasCore) return "HIGH";
  if (globalCoverage >= 55 && missingCount <= 6) return "MEDIUM";
  return "LOW";
}

function risksFrom(missingText, globalCoverage){
  const risks = [];
  if (globalCoverage < 55) risks.push("Low evidential coverage at moment T");

  const m = normalizeLower(missingText);
  if (m.includes("crisis") || m.includes("crise")) risks.push("Crisis leadership not documented");
  if (m.includes("international") || m.includes("abroad") || m.includes("exposure")) risks.push("International exposure unclear");
  if (m.includes("360") || m.includes("feedback")) risks.push("Feedback/360 not attributable");
  if (m.includes("kpi") || m.includes("ops") || m.includes("turnover") || m.includes("engagement")) risks.push("Operational comparability incomplete");

  if (!risks.length) risks.push("Known gaps explicitly stated; residual uncertainty remains");
  return risks.slice(0, 6);
}

function hypothesesFrom(input, analysis){
  const h = [];
  const m = normalizeLower(input.missingData || "");
  const c = normalizeLower(input.constraints || "");

  // tie / closeness logic
  const covs = analysis.candidates.map(x => x.coverage).slice().sort((a,b)=>b-a);
  const gapTop = covs.length >= 2 ? (covs[0] - covs[1]) : 100;

  if (gapTop <= 5) h.push("Candidates are within a narrow coverage band; decision likely depends on qualitative criteria.");
  if (m.includes("crisis") || m.includes("crise")) h.push("If crisis leadership is decisive, require at least 1 documented crisis episode per candidate.");
  if (m.includes("international") || m.includes("abroad")) h.push("If international exposure is required, validate assignments via HRIS + references.");
  if (m.includes("360") || m.includes("feedback")) h.push("If leadership style matters, collect attributable 360 feedback with date + author role.");
  if (m.includes("kpi") || m.includes("ops")) h.push("If ops performance is central, align candidates on comparable KPIs, same period, same scope.");

  if (c.includes("30") || c.includes("urgent") || c.includes("urgence")) h.push("Under urgency, document why a lighter evidential bundle is acceptable (risk acceptance note).");
  if (c.includes("social") || c.includes("climate") || c.includes("climat")) h.push("If social climate is sensitive, add an impact note: stakeholder map + mitigation actions.");

  if (!h.length) h.push("Decision hinges on explicit criteria; document the weighting before appointment.");
  return h.slice(0, 6);
}

async function sha256Hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b=>b.toString(16).padStart(2,"0")).join("");
}

function stablePayload(input, analysis){
  const srcKeys = Object.keys(input.sources).sort();
  const sources = {};
  srcKeys.forEach(k => sources[k] = !!input.sources[k]);

  const candidates = [...analysis.candidates]
    .map(c => ({ id: c.id, coverage: c.coverage }))
    .sort((a,b)=> a.id.localeCompare(b.id));

  const risks = [...analysis.risks].slice().sort();

  return JSON.stringify({
    v: "0.1",
    decision_type: input.decisionType,
    decision_date: input.decisionDate,
    organisation: input.orgLabel,
    decision_owner: input.issuer,
    sources,
    candidates,
    global_coverage: analysis.globalCoverage,
    missing_count: analysis.missingCount,
    defensibility: analysis.defensibility,
    risks
  });
}

function buildDecisionBundle(input, analysis){
  const bundleId = "decision-" + analysis.public_hash.slice(0, 12);

  return {
    rpo_version: "0.1",
    bundle_id: bundleId,
    created_at: nowISO(),
    decision: {
      type: input.decisionType || "other",
      moment_t: input.decisionDate || "—",
      organisation: input.orgLabel || "—",
      owner: input.issuer || "—"
    },
    input_state: {
      sources_available: input.sources,
      candidates_snapshots: {
        A: input.candA || "",
        B: input.candB || "",
        C: input.candC || ""
      },
      known_missing_data: input.missingData || "",
      constraints: input.constraints || ""
    },
    assessment: {
      global_coverage_pct: analysis.globalCoverage,
      missing_items_count: analysis.missingCount,
      candidates: analysis.candidates.map(c => ({
        id: c.id,
        coverage_pct: c.coverage,
        risk_level: c.risk
      })),
      defensibility: analysis.defensibility,
      explicit_hypotheses: analysis.hypotheses,
      known_risks: analysis.risks
    },
    integrity: {
      public_hash_sha256: analysis.public_hash,
      statement: "Hash proves integrity of the payload, not correctness of the decision."
    },
    disclaimer: "Deterministic sandbox. No AI. No storage. Not legal advice."
  };
}

/* =========================================================
✅ LE POINT DE REPRISE DEMANDÉ : à partir de riskLevelFromCoverage
========================================================= */
function riskLevelFromCoverage(cov){
  if (cov >= 85) return "LOW";
  if (cov >= 65) return "MEDIUM";
  return "UNKNOWN";
}

/* =========================================================
UI + Orchestration
========================================================= */
let LAST = {
  input: null,
  analysis: null,
  payload: null,
  hash: null,
  bundle: null
};

function readInput(){
  const sources = selectedSources();
  return {
    decisionType: safeText($("decisionType").value),
    decisionDate: safeText($("decisionDate").value),
    orgLabel: safeText($("orgLabel").value),
    issuer: safeText($("issuer").value),
    candA: safeText($("candA").value),
    candB: safeText($("candB").value),
    candC: safeText($("candC").value),
    missingData: safeText($("missingData").value),
    constraints: safeText($("constraints").value),
    sources
  };
}

function setPill(level){
  const pill = $("statusPill");
  const txt = $("statusText");

  pill.classList.remove("ok","warn","bad","muted");
  if (level === "HIGH"){ pill.classList.add("ok"); txt.textContent = "DEFENSIBILITY: HIGH"; return; }
  if (level === "MEDIUM"){ pill.classList.add("warn"); txt.textContent = "DEFENSIBILITY: MEDIUM"; return; }
  pill.classList.add("bad"); txt.textContent = "DEFENSIBILITY: LOW";
}

function setBadge(el, label, kind){
  el.classList.remove("ok","warn","bad","muted");
  if (kind) el.classList.add(kind);
  el.textContent = label;
}

function setProgress(globalCoverage){
  const bar = $("barFill");
  const ready = $("readyLabel");
  const sync = $("syncLabel");

  bar.style.width = `${Math.max(2, Math.min(100, globalCoverage))}%`;
  ready.textContent = "READY";
  sync.textContent = "SYNC";
}

function renderBundle(bundle, analysis){
  $("mCoverage").textContent = `${analysis.globalCoverage}%`;
  $("mMissing").textContent = `${analysis.missingCount}`;
  $("mDef").textContent = analysis.defensibility;

  const cA = analysis.candidates.find(x=>x.id==="A");
  const cB = analysis.candidates.find(x=>x.id==="B");
  const cC = analysis.candidates.find(x=>x.id==="C");

  $("mA").textContent = `A: Coverage ${cA.coverage}% — Risk ${cA.risk}`;
  $("mB").textContent = `B: Coverage ${cB.coverage}% — Risk ${cB.risk}`;
  $("mC").textContent = `C: Coverage ${cC.coverage}% — Risk ${cC.risk}`;

  $("mHash").textContent = analysis.public_hash;

  // Steps (visual)
  setBadge($("s1"), "OK", "ok");
  setBadge($("s2"), "OK", "ok");
  setBadge($("s3"), "SEALED", "ok");

  $("vInput").textContent = "Input captured";
  $("vExtract").textContent = "Deterministic assessment";
  $("vSeal").textContent = "Public hash sealed";

  setPill(analysis.defensibility);
  setProgress(analysis.globalCoverage);

  // JSON pane
  $("jsonOut").value = JSON.stringify(bundle, null, 2);
}

function downloadJson(filename, text){
  const blob = new Blob([text], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function generate(){
  const input = readInput();
  const sources = input.sources;

  const globalCoverage = computeGlobalCoverage(sources);
  const missingCount = countMissingItems(input.missingData);

  const cA = computeCandidateCoverage(input.candA, sources);
  const cB = computeCandidateCoverage(input.candB, sources);
  const cC = computeCandidateCoverage(input.candC, sources);

  const analysis = {
    globalCoverage,
    missingCount,
    candidates: [
      { id:"A", coverage: cA, risk: riskLevelFromCoverage(cA) },
      { id:"B", coverage: cB, risk: riskLevelFromCoverage(cB) },
      { id:"C", coverage: cC, risk: riskLevelFromCoverage(cC) }
    ],
    defensibility: defensibilityLevel(globalCoverage, missingCount, sources),
    risks: risksFrom(input.missingData, globalCoverage),
    hypotheses: [] // filled below
  };

  analysis.hypotheses = hypothesesFrom(input, analysis);

  const payload = stablePayload(input, analysis);
  const hash = await sha256Hex(payload);
  analysis.public_hash = hash;

  const bundle = buildDecisionBundle(input, analysis);

  LAST = { input, analysis, payload, hash, bundle };
  renderBundle(bundle, analysis);
}

function resetAll(){
  $("decisionType").value = "";
  $("decisionDate").value = "";
  $("orgLabel").value = "";
  $("issuer").value = "";
  $("candA").value = "";
  $("candB").value = "";
  $("candC").value = "";
  $("missingData").value = "";
  $("constraints").value = "";

  $("srcLMS").checked = true;
  $("srcHRIS").checked = true;
  $("srcPerf").checked = true;
  $("srcMobility").checked = false;
  $("srcOps").checked = true;
  $("src360").checked = false;

  $("mCoverage").textContent = "—";
  $("mMissing").textContent = "—";
  $("mDef").textContent = "—";
  $("mA").textContent = "—";
  $("mB").textContent = "—";
  $("mC").textContent = "—";
  $("mHash").textContent = "—";
  $("jsonOut").value = "";

  setBadge($("s1"), "—", "muted");
  setBadge($("s2"), "—", "muted");
  setBadge($("s3"), "—", "muted");

  $("vInput").textContent = "Input";
  $("vExtract").textContent = "Extraction";
  $("vSeal").textContent = "Public hash";

  $("barFill").style.width = "0%";
  $("readyLabel").textContent = "READY";
  $("syncLabel").textContent = "SYNC";

  $("statusPill").classList.remove("ok","warn","bad");
  $("statusPill").classList.add("muted");
  $("statusText").textContent = "NO BUNDLE YET";

  // verify reset
  $("verifyPayload").value = "";
  $("verifyHash").value = "";
  setBadge($("verifyBadge"), "NO CHECK YET", "muted");
  $("verifyMsg").textContent = "—";

  LAST = { input:null, analysis:null, payload:null, hash:null, bundle:null };
}

function setActiveTab(tabId){
  const tabs = [
    { tab: $("tabBundle"), pane: $("paneBundle") },
    { tab: $("tabJson"), pane: $("paneJson") },
    { tab: $("tabVerify"), pane: $("paneVerify") }
  ];

  tabs.forEach(({tab,pane})=>{
    const active = (tab.id === tabId);
    tab.setAttribute("aria-selected", active ? "true" : "false");
    pane.classList.toggle("active", active);
  });
}

async function verifyNow(){
  const payload = safeText($("verifyPayload").value);
  const expected = normalizeLower($("verifyHash").value);

  if (!payload || !expected){
    setBadge($("verifyBadge"), "MISSING INPUT", "warn");
    $("verifyMsg").textContent = "Provide both payload and expected sha256.";
    return;
  }

  const got = await sha256Hex(payload);
  if (got === expected){
    setBadge($("verifyBadge"), "MATCH", "ok");
    $("verifyMsg").textContent = "Payload integrity verified.";
  } else {
    setBadge($("verifyBadge"), "MISMATCH", "bad");
    $("verifyMsg").textContent = `Computed sha256 differs. Got: ${got.slice(0,16)}…`;
  }
}

function loadExample(){
  $("decisionType").value = EXAMPLE.decisionType;
  $("decisionDate").value = EXAMPLE.decisionDate;
  $("orgLabel").value = EXAMPLE.orgLabel;
  $("issuer").value = EXAMPLE.issuer;

  $("srcLMS").checked = !!EXAMPLE.sources.lms;
  $("srcHRIS").checked = !!EXAMPLE.sources.hris;
  $("srcPerf").checked = !!EXAMPLE.sources.perf;
  $("srcMobility").checked = !!EXAMPLE.sources.mobility;
  $("srcOps").checked = !!EXAMPLE.sources.ops;
  $("src360").checked = !!EXAMPLE.sources.s360;

  $("candA").value = EXAMPLE.candA;
  $("candB").value = EXAMPLE.candB;
  $("candC").value = EXAMPLE.candC;
  $("missingData").value = EXAMPLE.missingData;
  $("constraints").value = EXAMPLE.constraints;
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  } catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }
}

/* =========================================================
Events
========================================================= */
$("generateBtn").addEventListener("click", async () => {
  await generate();
  // subtle UX: switch to bundle after generation
  setActiveTab("tabBundle");
});

$("resetBtn").addEventListener("click", resetAll);

$("loadExampleBtn").addEventListener("click", () => {
  loadExample();
  setActiveTab("tabBundle");
});

$("downloadJsonBtn").addEventListener("click", () => {
  if (!LAST.bundle) return;
  const name = `decision_bundle_${(LAST.hash || "hash").slice(0,12)}.json`;
  downloadJson(name, JSON.stringify(LAST.bundle, null, 2));
});

$("copyHashBtn").addEventListener("click", async () => {
  if (!LAST.hash) return;
  await copyToClipboard(LAST.hash);
});

$("copyJsonBtn").addEventListener("click", async () => {
  const val = safeText($("jsonOut").value);
  if (!val) return;
  await copyToClipboard(val);
});

// tabs
$("tabBundle").addEventListener("click", ()=>setActiveTab("tabBundle"));
$("tabJson").addEventListener("click", ()=>setActiveTab("tabJson"));
$("tabVerify").addEventListener("click", ()=>setActiveTab("tabVerify"));

// verify
$("verifyBtn").addEventListener("click", verifyNow);
$("useLastBtn").addEventListener("click", () => {
  if (!LAST.payload || !LAST.hash) return;
  $("verifyPayload").value = LAST.payload;
  $("verifyHash").value = LAST.hash;
  setActiveTab("tabVerify");
  setBadge($("verifyBadge"), "READY", "muted");
  $("verifyMsg").textContent = "Click Verify.";
});

// initial state
resetAll();
setActiveTab("tabBundle");
</script>

</body>
</html>
