<!doctype html>
<html lang="fr" data-page="sandbox">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof — Simulator (RPO v0.1)</title>

  <!-- Fonts (optionnel, mais cohérent avec la charte Orbitron/Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Keep your existing global CSS -->
  <link rel="stylesheet" href="./assets/site.css" />

  <style>
    /* =========================================================
      Simulator page — Wide + Airy + Audit-ready
      Keeps global OpenProof variables & tone
    ========================================================= */

    :root{
      --font-title: "Orbitron", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      --font-body: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;

      --panel2: rgba(255,255,255,0.055);
      --panel3: rgba(0,0,0,0.26);
      --stroke2: rgba(212,175,55,0.30);
      --stroke3: rgba(241,230,163,0.20);

      --goldGrad: linear-gradient(180deg, rgba(241,230,163,0.22), rgba(212,175,55,0.10));
      --btnGrad: linear-gradient(180deg, rgba(241,230,163,0.26), rgba(212,175,55,0.14));
      --shadow2: 0 20px 70px rgba(0,0,0,0.42);
    }

    body{
      font-family: var(--font-body);
    }

    /* ---------- Top Nav (structure stable) ---------- */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(4,4,14,0.92), rgba(11,15,20,0.78));
      border-bottom: 1px solid rgba(212,175,55,0.18);
    }

    .topbar-inner{
      width: min(1600px, 100%);
      margin: 0 auto;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 260px;
    }
    .brand-dot{
      width: 12px; height: 12px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(241,230,163,0.95), rgba(212,175,55,0.55));
      box-shadow: 0 0 26px rgba(212,175,55,0.35);
      border: 1px solid rgba(241,230,163,0.25);
    }
    .brand-txt{
      display:flex;
      flex-direction:column;
      line-height: 1.12;
    }
    .brand-txt .t1{
      font-family: var(--font-title);
      font-size: 12px;
      letter-spacing: 0.10em;
      opacity: 0.95;
      text-transform: uppercase;
    }
    .brand-txt .t2{
      font-size: 11.5px;
      color: rgba(247,243,232,0.70);
      letter-spacing: 0.03em;
    }

    .nav{
      display:flex;
      align-items:center;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .nav a{
      color: rgba(247,243,232,0.78);
      text-decoration: none;
      font-size: 13.5px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .nav a:hover{
      color: rgba(241,230,163,0.92);
      border-color: rgba(241,230,163,0.18);
      background: rgba(0,0,0,0.18);
    }
    .nav a.active{
      color: rgba(241,230,163,0.95);
      border-color: rgba(212,175,55,0.25);
      background: rgba(0,0,0,0.20);
    }

    .top-cta{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
      justify-content: flex-end;
    }

    .btnPill{
      appearance:none;
      border: 1px solid rgba(241,230,163,0.22);
      background: rgba(0,0,0,0.26);
      color: var(--ivory);
      padding: 11px 14px;
      border-radius: 999px;
      font-weight: 650;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 12px;
      cursor:pointer;
      text-decoration:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .btnPill:hover{
      transform: translateY(-1px);
      border-color: rgba(241,230,163,0.42);
      background: rgba(0,0,0,0.32);
    }
    .btnPill.primary{
      background: var(--btnGrad);
      border-color: rgba(212,175,55,0.42);
      color: rgba(4,4,14,0.96);
    }

    /* ---------- Page layout (WIDE) ---------- */
    main{
      width: 100%;
    }

    .wrapWide{
      width: min(1600px, 100%);
      margin: 0 auto;
      padding: 26px 24px 34px 24px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.55fr 0.75fr;
      gap: 18px;
      align-items: start;
    }

    @media (max-width: 1040px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel2);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      padding: 22px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
    }

    .hero{
      border: 1px solid rgba(212,175,55,0.20);
      background:
        radial-gradient(900px 420px at 20% 40%, rgba(212,175,55,0.14), transparent 55%),
        radial-gradient(800px 420px at 85% 15%, rgba(241,230,163,0.10), transparent 55%),
        rgba(255,255,255,0.05);
      box-shadow: var(--shadow2);
      padding: 26px;
    }

    .hero .kicker{
      font-family: var(--font-title);
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(241,230,163,0.85);
      margin-bottom: 8px;
    }

    .hero h1{
      font-family: var(--font-title);
      font-size: clamp(34px, 3.2vw, 56px);
      line-height: 1.03;
      margin: 0 0 10px 0;
      letter-spacing: 0.01em;
    }

    .hero p{
      margin: 0;
      color: rgba(179,164,139,0.98);
      font-size: 15.5px;
      line-height: 1.55;
      max-width: 980px;
    }

    .chips{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.20);
      background: rgba(0,0,0,0.22);
      color: rgba(241,230,163,0.92);
      font-size: 12.5px;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }

    .heroActions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(241,230,163,0.22);
      background: rgba(0,0,0,0.28);
      color: var(--ivory);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 650;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      min-height: 44px;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(241,230,163,0.44);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(241,230,163,0.28), rgba(212,175,55,0.16));
      border-color: rgba(212,175,55,0.48);
      color: rgba(4,4,14,0.96);
      font-family: var(--font-title);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .btn.ghost{
      background: rgba(0,0,0,0.22);
      font-family: var(--font-title);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
    }

    /* ---------- Forms ---------- */
    .sectionTitle{
      font-family: var(--font-title);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(241,230,163,0.85);
      margin: 0 0 12px 0;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 860px){
      .formGrid{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(247,243,232,0.72);
      margin-bottom: 6px;
      font-family: var(--font-title);
    }

    input[type="text"], input[type="date"], select, textarea{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(0,0,0,0.22);
      color: rgba(247,243,232,0.92);
      padding: 12px 12px;
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
      font-size: 14px;
      font-family: var(--font-body);
    }

    textarea{
      min-height: 118px;
      resize: vertical;
      line-height: 1.5;
    }

    .hint{
      margin-top: 8px;
      color: rgba(179,164,139,0.92);
      font-size: 13.5px;
      line-height: 1.5;
    }

    /* ---------- Systems selection ---------- */
    .systems{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 860px){
      .systems{ grid-template-columns: 1fr; }
    }
    .sysCard{
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(241,230,163,0.16);
      background: rgba(0,0,0,0.18);
    }
    .sysTop{
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }
    .sysTop input{
      margin-top: 2px;
      width: 16px; height: 16px;
      accent-color: rgba(212,175,55,0.85);
    }
    .sysTop .name{
      font-weight: 650;
      color: rgba(247,243,232,0.92);
      font-size: 14px;
      line-height: 1.25;
    }
    .sysTop .desc{
      margin-top: 6px;
      color: rgba(179,164,139,0.92);
      font-size: 13px;
      line-height: 1.45;
    }

    /* ---------- Sticky cockpit ---------- */
    .cockpit{
      position: sticky;
      top: 88px;
      border-color: rgba(212,175,55,0.22);
      background: linear-gradient(180deg, rgba(255,255,255,0.055), rgba(0,0,0,0.22));
      box-shadow: var(--shadow2);
    }
    @media (max-width: 1040px){
      .cockpit{ position: relative; top: auto; }
    }

    .cockpitHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .cockpitHeader .title{
      font-family: var(--font-title);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(241,230,163,0.90);
      margin: 0;
    }
    .pillMini{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(0,0,0,0.18);
      color: rgba(241,230,163,0.88);
      font-size: 12px;
      white-space: nowrap;
    }
    .rows{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(241,230,163,0.12);
      background: rgba(0,0,0,0.16);
    }
    .row .k{
      font-family: var(--font-title);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 11px;
      color: rgba(247,243,232,0.62);
    }
    .row .v{
      font-weight: 700;
      color: rgba(241,230,163,0.94);
      text-align: right;
    }
    .row .v.small{
      font-size: 12.5px;
      font-weight: 650;
      color: rgba(247,243,232,0.82);
    }

    /* ---------- Output panel ---------- */
    .outputHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tab{
      border: 1px solid rgba(241,230,163,0.18);
      background: rgba(0,0,0,0.18);
      color: rgba(241,230,163,0.85);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-family: var(--font-title);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor:pointer;
    }
    .tab.active{
      border-color: rgba(212,175,55,0.40);
      background: rgba(212,175,55,0.16);
      color: rgba(4,4,14,0.92);
    }

    .pane{ display:none; }
    .pane.active{ display:block; }

    pre{
      border-radius: 18px;
      border: 1px solid rgba(241,230,163,0.14);
      background: rgba(0,0,0,0.24);
      padding: 14px;
      overflow:auto;
      margin: 10px 0 0 0;
    }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12.8px;
      line-height: 1.45;
      color: rgba(247,243,232,0.86);
    }

    .escalation{
      margin-top: 12px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(212,175,55,0.22);
      background: rgba(0,0,0,0.18);
    }
    .escalation .line{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(241,230,163,0.16);
    }
    .escalation .line:last-child{ border-bottom: none; }
    .escalation .left{
      color: rgba(247,243,232,0.76);
      font-size: 13.5px;
    }
    .escalation .right{
      font-family: var(--font-title);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 11.5px;
      color: rgba(241,230,163,0.92);
      text-align: right;
      white-space: nowrap;
    }

    /* ---------- Bottom CTA ---------- */
    .bottomCta{
      margin-top: 18px;
      padding: 22px;
      border-radius: 22px;
      border: 1px solid rgba(212,175,55,0.22);
      background: linear-gradient(180deg, rgba(255,255,255,0.055), rgba(0,0,0,0.20));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .bottomCta h3{
      margin: 0 0 6px 0;
      font-family: var(--font-title);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 13px;
      color: rgba(241,230,163,0.92);
    }
    .bottomCta p{
      margin: 0;
      color: rgba(179,164,139,0.92);
      max-width: 900px;
      line-height: 1.55;
      font-size: 14.5px;
    }

    footer{
      width: min(1600px, 100%);
      margin: 0 auto;
      padding: 18px 24px 40px 24px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      color: rgba(247,243,232,0.55);
      font-size: 12.5px;
      border-top: 1px solid rgba(212,175,55,0.14);
      margin-top: 18px;
    }
    footer a{
      color: rgba(241,230,163,0.70);
      text-decoration:none;
    }
    footer a:hover{
      color: rgba(241,230,163,0.95);
    }
  </style>
</head>

<body>

  <!-- =========================
    NAV — keep structure & CTA
  ========================== -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-dot" aria-hidden="true"></div>
        <div class="brand-txt">
          <div class="t1">OPENPROOF .NET — RPO v0.1</div>
          <div class="t2">Moteur probatoire & gouvernance</div>
        </div>
      </div>

      <nav class="nav" aria-label="Navigation">
        <!-- Replace href with your real routes (KEEP THEM STABLE) -->
        <a href="./index.html">Maison</a>
        <a href="./simulator.html" class="active">Simulateur</a>
        <a href="./how.html">Comment ça marche</a>
        <a href="./spec.html">Spéc.</a>
        <a href="./tests.html">Tests</a>
        <a href="./examples.html">Exemples</a>
        <a href="./contexts.html">Contextes</a>
      </nav>

      <div class="top-cta">
        <!-- Keep your CTA label / link -->
        <a class="btnPill primary" href="./pilot.html">POSTE DE PILOTAGE</a>
      </div>
    </div>
  </header>

  <main>
    <div class="wrapWide">

      <!-- =========================
        HERO — context + actions
      ========================== -->
      <section class="card hero">
        <div class="kicker">Simulateur déterministe</div>
        <h1>Simulateur. Trois contextes. Pas d’IA. Pas d’interprétation.</h1>
        <p>
          Contexte de gouvernance : justification des décisions en cas d’audit. Focus sur le périmètre,
          la traçabilité, les définitions et la reconstitution au moment T. Le contexte modifie le lexique,
          la pondération et l’escalade institutionnelle, sans modifier la structure RPO scellée.
        </p>

        <div class="chips" role="list" aria-label="Chips">
          <span class="chip">Contexte</span>
          <select id="context-select" aria-label="Contexte">
            <option value="governance" selected>Gouvernance</option>
            <option value="justice">Procédures judiciaires</option>
            <option value="crisis">Crise institutionnelle</option>
          </select>

          <span class="chip">Moment T</span>
          <span class="chip" id="chip-moment">—</span>

          <span class="chip">Systèmes déclarés</span>
          <span class="chip" id="chip-systems">—</span>

          <span class="chip">Contrôles de qualité</span>
          <span class="chip" id="chip-quality">—</span>

          <span class="chip">Exposition</span>
          <span class="chip" id="chip-exposure">—</span>

          <span class="chip">hachage public</span>
          <span class="chip" id="chip-hash">—</span>
        </div>

        <div class="heroActions">
          <button class="btn primary" id="generate-btn">Générer un ensemble</button>
          <button class="btn ghost" id="load-example-btn">Exemple de chargement</button>
        </div>

        <p class="hint">
          RPO = noyau JSON scellé + vue imprimable lisible + hachage public.
          Le hachage garantit l’intégrité dans le temps, pas la « vérité ». La responsabilité reste humaine.
        </p>
      </section>

      <!-- =========================
        GRID — left flow + right cockpit sticky
      ========================== -->
      <section class="grid" style="margin-top: 18px;">

        <!-- ========== LEFT (MAIN) ========== -->
        <div>

          <!-- INPUTS -->
          <section class="card" id="inputs">
            <div class="sectionTitle">Entrée — périmètre de décision</div>

            <div class="formGrid">
              <div>
                <label for="scope">Portée de l’organisation</label>
                <input id="scope" type="text" value="Industrial group — multi-sites, multi-entities (EU + non-EU)" />
              </div>
              <div>
                <label for="authority">Autorité / décideur</label>
                <input id="authority" type="text" value="Group HR Authority" />
              </div>
              <div>
                <label for="momentT">Moment T</label>
                <input id="momentT" type="date" />
              </div>
              <div>
                <label for="decisionType">Type de décision</label>
                <select id="decisionType">
                  <option>Décision relative à la main-d’œuvre / aux RH</option>
                  <option>Décision disciplinaire / investigation interne</option>
                  <option>Décision de conformité (formation obligatoire / habilitations)</option>
                  <option>Décision de sécurité (accès / incidents / privilèges)</option>
                </select>
              </div>
            </div>

            <div style="margin-top: 12px;">
              <label for="decisionContext">Contexte de décision (contraintes, fenêtre d’audit)</label>
              <textarea id="decisionContext">Regulated environment. Internal audit trigger. Need reconstructible workforce / learning records.
Constraints: audit window 24 months, multi-entity definitions, potential institutional exposure.</textarea>
              <div class="hint">
                Restez factuel : le simulateur n’évalue pas la vérité. Il évalue le risque de reconstitution / contestation à l’instant T.
              </div>
            </div>

            <div style="margin-top: 16px;">
              <div class="sectionTitle">Systèmes déclarés (RH / Formation / Opérations / Sécurité)</div>

              <div class="systems" id="systems">
                <div class="sysCard">
                  <div class="sysTop">
                    <input type="checkbox" class="sys" data-key="HRIS" checked />
                    <div>
                      <div class="name">SIRH / Gestion du capital humain (GCH)</div>
                      <div class="desc">Données de référence : identité, contrats, structure, familles de métiers. Extraction de l’identifiant et du responsable attendus.</div>
                    </div>
                  </div>
                </div>

                <div class="sysCard">
                  <div class="sysTop">
                    <input type="checkbox" class="sys" data-key="LMS" checked />
                    <div>
                      <div class="name">LMS / TMS / LXP</div>
                      <div class="desc">Dossiers de formation, conformité obligatoire, preuves de réalisation. Utiles en cas d’audit ou de litige.</div>
                    </div>
                  </div>
                </div>

                <div class="sysCard">
                  <div class="sysTop">
                    <input type="checkbox" class="sys" data-key="OPS" checked />
                    <div>
                      <div class="name">Attestations Opérations / KPI</div>
                      <div class="desc">Indicateurs certifiés, traces opérationnelles, contraintes de production. Améliore la reconstitution.</div>
                    </div>
                  </div>
                </div>

                <div class="sysCard">
                  <div class="sysTop">
                    <input type="checkbox" class="sys" data-key="SEC" />
                    <div>
                      <div class="name">Journaux informatiques / de sécurité</div>
                      <div class="desc">Journaux d’accès, signaux des appareils, tickets, anomalies. Essentiels pour la gestion des crises institutionnelles.</div>
                    </div>
                  </div>
                </div>

                <div class="sysCard">
                  <div class="sysTop">
                    <input type="checkbox" class="sys" data-key="LEGAL" />
                    <div>
                      <div class="name">Aperçu juridique</div>
                      <div class="desc">Marqueurs d’instantanés opposables, chaîne de traçabilité, horodatages. Nécessaire lorsque des procédures sont prévues.</div>
                    </div>
                  </div>
                </div>

                <div class="sysCard">
                  <div class="sysTop">
                    <input type="checkbox" class="sys" data-key="EXTERNAL" />
                    <div>
                      <div class="name">Contexte externe</div>
                      <div class="desc">Contraintes réglementaires, exposition publique, déclencheurs d’audit. À utiliser uniquement comme contrainte.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="heroActions" style="margin-top: 14px;">
              <button class="btn primary" id="generate-btn-2" type="button">Générer</button>
              <button class="btn" id="reset-btn" type="button">Réinitialiser</button>
              <button class="btn" id="load-example-btn-2" type="button">Exemple de chargement</button>
            </div>
          </section>

          <!-- OUTPUT -->
          <section class="card" id="outputs" style="margin-top: 18px;">
            <div class="outputHead">
              <div class="sectionTitle">Résultat — rapport sur la justification de la décision</div>

              <div class="tabs" role="tablist" aria-label="Tabs output">
                <button class="tab active" data-tab="preview" type="button">Aperçu</button>
                <button class="tab" data-tab="json" type="button">JSON scellé</button>
                <button class="tab" data-tab="invariants" type="button">Preuve et invariants</button>
              </div>
            </div>

            <!-- Key facts summary -->
            <div class="rows" style="margin-top: 8px;">
              <div class="row">
                <div class="k">Couverture</div>
                <div class="v" id="out-coverage">—</div>
              </div>
              <div class="row">
                <div class="k">Sources manquantes</div>
                <div class="v" id="out-missing">—</div>
              </div>
              <div class="row">
                <div class="k">Défendabilité</div>
                <div class="v" id="out-def">—</div>
              </div>
              <div class="row">
                <div class="k">Exposition</div>
                <div class="v" id="out-exp">—</div>
              </div>
              <div class="row">
                <div class="k">Hachage public (noyau scellé)</div>
                <div class="v small" id="out-hash">—</div>
              </div>
            </div>

            <!-- NEW: Escalation path (mandatory) -->
            <div class="escalation" aria-label="Escalation path">
              <div class="sectionTitle" style="margin-bottom: 6px;">Escalation path (institutionnel)</div>

              <div class="line">
                <div class="left">Owner set</div>
                <div class="right" id="esc-owner">—</div>
              </div>
              <div class="line">
                <div class="left">Add IT / Security</div>
                <div class="right" id="esc-it">—</div>
              </div>
              <div class="line">
                <div class="left">Add Legal</div>
                <div class="right" id="esc-legal">—</div>
              </div>
              <div class="line">
                <div class="left">COMEX brief required</div>
                <div class="right" id="esc-comex">—</div>
              </div>

              <div class="hint" style="margin-top: 10px;">
                Cette route est déclenchée par les bandes (défendabilité / exposition). Elle ne prétend pas établir la vérité ; elle structure la réaction institutionnelle.
              </div>
            </div>

            <!-- Panes -->
            <div class="pane active" id="pane-preview">
              <pre><code id="result-tagline">Decision: —</code></pre>
              <div class="hint">
                Le rapport est déterministe : même entrée → même sortie. Le noyau scellé prouve l’intégrité dans le temps, pas la vérité.
              </div>
            </div>

            <div class="pane" id="pane-json">
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;">
                <button class="btn" id="copy-json-btn" type="button">Copier JSON</button>
                <button class="btn" id="download-json-btn" type="button">Télécharger JSON</button>
              </div>
              <pre><code id="rpo-json">{}</code></pre>
            </div>

            <div class="pane" id="pane-invariants">
              <pre><code id="invariants-block">—</code></pre>
              <div class="hint">
                Invariants : périmètre, systèmes déclarés, règles de scoring, moment T, hash. Le hash prouve l’intégrité, pas la “vérité”.
              </div>
            </div>
          </section>

          <!-- Bottom CTA -->
          <section class="bottomCta" style="margin-top: 18px;">
            <div>
              <h3>Prêt pour le cockpit du pilote ?</h3>
              <p>
                Passez d’un simulateur déterministe à un flux de travail ProofOps : connecteurs, workflows,
                journal scellé, traçabilité multi-acteurs, et rapports probatoires exploitables.
              </p>
            </div>
            <a class="btnPill primary" href="./pilot.html">POSTE DE PILOTAGE</a>
          </section>

        </div>

        <!-- ========== RIGHT (STICKY COCKPIT) ========== -->
        <aside class="card cockpit" aria-label="Simulateur de cockpit (en direct)">
          <div class="cockpitHeader">
            <p class="title">Simulateur de cockpit (en direct)</p>
            <span class="pillMini">Intégrité · Lisibilité · Vérifiabilité</span>
          </div>

          <div class="rows">
            <div class="row">
              <div class="k">Portée</div>
              <div class="v small" id="metric-scope">—</div>
            </div>
            <div class="row">
              <div class="k">Moment T</div>
              <div class="v" id="metric-moment">—</div>
            </div>
            <div class="row">
              <div class="k">Couverture</div>
              <div class="v" id="metric-coverage">—</div>
            </div>
            <div class="row">
              <div class="k">Défendabilité</div>
              <div class="v" id="metric-def">—</div>
            </div>
            <div class="row">
              <div class="k">Exposition</div>
              <div class="v" id="metric-exp">—</div>
            </div>
            <div class="row">
              <div class="k">Hacher</div>
              <div class="v small" id="hash-value">—</div>
            </div>
          </div>

          <div class="hint" style="margin-top: 12px;">
            Le panneau de droite est un cockpit de défense décisionnelle : il résume la reconstructibilité au moment T.
            Il ne prétend pas établir la vérité.
          </div>
        </aside>

      </section>
    </div>

    <footer>
      <div>© OpenProof — RPO v0.1. Créé par Gersende Ryard de Parcey.</div>
      <div>
        <a href="./spec.html">Spécifications</a> ·
        <a href="./simulator.html">Simulateur</a> ·
        <a href="./examples.html">Exemples</a>
      </div>
    </footer>
  </main>

  <!-- Keep your existing scripts -->
  <script src="./assets/site.js"></script>
  <script src="./assets/sandbox.js"></script>

  <script>
    (function(){
      "use strict";

      // ---------- Helpers ----------
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      async function sha256Hex(str){
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
      }

      // ---------- Context model (deterministic, no AI) ----------
      const CONTEXTS = {
        governance: {
          label: "Gouvernance",
          weights: { coverage: 0.55, quality: 0.25, constraints: 0.20 },
          lexicon: { expHigh: "HIGH", expMed: "MEDIUM", expLow: "LOW" }
        },
        justice: {
          label: "Procédures judiciaires",
          weights: { coverage: 0.45, quality: 0.25, constraints: 0.30 },
          lexicon: { expHigh: "HIGH", expMed: "MEDIUM", expLow: "LOW" }
        },
        crisis: {
          label: "Crise institutionnelle",
          weights: { coverage: 0.40, quality: 0.20, constraints: 0.40 },
          lexicon: { expHigh: "HIGH", expMed: "MEDIUM", expLow: "LOW" }
        }
      };

      // ---------- Systems (source-of-truth list) ----------
      const SYSTEMS = [
        { key:"HRIS", label:"HRIS", criticality: 1.0 },
        { key:"LMS", label:"LMS", criticality: 0.9 },
        { key:"OPS", label:"OPS", criticality: 0.7 },
        { key:"SEC", label:"SECURITY_LOGS", criticality: 0.9 },
        { key:"LEGAL", label:"LEGAL_SNAPSHOT", criticality: 0.85 },
        { key:"EXTERNAL", label:"EXTERNAL_CONSTRAINTS", criticality: 0.5 }
      ];

      // ---------- UI ----------
      const ctxSelect = $("#context-select");
      const momentT = $("#momentT");
      const scope = $("#scope");
      const authority = $("#authority");
      const decisionType = $("#decisionType");
      const decisionContext = $("#decisionContext");

      const genBtns = [$("#generate-btn"), $("#generate-btn-2")].filter(Boolean);
      const resetBtn = $("#reset-btn");
      const exampleBtns = [$("#load-example-btn"), $("#load-example-btn-2")].filter(Boolean);

      const chipMoment = $("#chip-moment");
      const chipSystems = $("#chip-systems");
      const chipQuality = $("#chip-quality");
      const chipExposure = $("#chip-exposure");
      const chipHash = $("#chip-hash");

      const metricScope = $("#metric-scope");
      const metricMoment = $("#metric-moment");
      const metricCoverage = $("#metric-coverage");
      const metricDef = $("#metric-def");
      const metricExp = $("#metric-exp");
      const hashValue = $("#hash-value");

      const outCoverage = $("#out-coverage");
      const outMissing = $("#out-missing");
      const outDef = $("#out-def");
      const outExp = $("#out-exp");
      const outHash = $("#out-hash");

      // Escalation output
      const escOwner = $("#esc-owner");
      const escIt = $("#esc-it");
      const escLegal = $("#esc-legal");
      const escComex = $("#esc-comex");

      // Output panes
      const tabs = $$(".tab");
      const panePreview = $("#pane-preview");
      const paneJson = $("#pane-json");
      const paneInv = $("#pane-invariants");
      const previewTag = $("#result-tagline");
      const jsonEl = $("#rpo-json");
      const invEl = $("#invariants-block");

      // ---------- Defaults ----------
      const today = new Date();
      const iso = today.toISOString().slice(0,10);
      momentT.value = iso;

      function selectedSystems(){
        const set = new Set($$(".sys").filter(x => x.checked).map(x => x.dataset.key));
        return SYSTEMS.filter(s => set.has(s.key));
      }

      function missingSystems(){
        const set = new Set($$(".sys").filter(x => x.checked).map(x => x.dataset.key));
        return SYSTEMS.filter(s => !set.has(s.key));
      }

      function computeQualitySignals(sel){
        // Deterministic "quality checks" proxy:
        // More sources -> better completeness; lack of HRIS/LMS -> higher definition drift risk.
        const hasHRIS = sel.some(s => s.key === "HRIS");
        const hasLMS = sel.some(s => s.key === "LMS");
        const hasSEC = sel.some(s => s.key === "SEC");

        const freshness = sel.length >= 4 ? "MEDIUM" : "LOW";
        const completeness = (hasHRIS && hasLMS) ? "MEDIUM" : "LOW";
        const definitionDrift = (hasHRIS ? "LOW" : "MEDIUM");
        const duplicates = sel.length >= 3 ? "LOW" : "MEDIUM";
        const risk = (hasSEC ? "MEDIUM" : "MEDIUM"); // stays MEDIUM by design

        return { freshness, completeness, definitionDrift, duplicates, risk };
      }

      function bandFrom(defScore, exposure){
        // Simple rules: defensibility score drives band, exposure can upgrade it.
        // Bands: LOW / MEDIUM / HIGH / CRITICAL
        let band = "LOW";
        if (defScore >= 70) band = "LOW";
        if (defScore < 70) band = "MEDIUM";
        if (defScore < 55) band = "HIGH";
        if (defScore < 40) band = "CRITICAL";

        if (exposure === "HIGH" && band === "MEDIUM") band = "HIGH";
        if (exposure === "HIGH" && band === "HIGH") band = "CRITICAL";
        return band;
      }

      function escalationFor(band){
        // The point: institutional routing (not truth).
        // Always deterministic.
        const base = {
          owner: "RH",
          addIT: "NO",
          addLegal: "NO",
          comex: "NO"
        };
        if (band === "LOW"){
          return { ...base, addIT:"NO", addLegal:"NO", comex:"NO" };
        }
        if (band === "MEDIUM"){
          return { ...base, addIT:"YES", addLegal:"NO", comex:"NO" };
        }
        if (band === "HIGH"){
          return { ...base, addIT:"YES", addLegal:"YES", comex:"RECOMMENDED" };
        }
        return { ...base, addIT:"YES", addLegal:"YES", comex:"REQUIRED" };
      }

      function exposureFrom(sel, ctxKey){
        // Deterministic exposure: fewer sources -> higher exposure,
        // Crisis context is stricter.
        const n = sel.length;
        if (ctxKey === "crisis"){
          if (n <= 2) return "HIGH";
          if (n === 3) return "HIGH";
          if (n === 4) return "MEDIUM";
          return "MEDIUM";
        }
        if (n <= 2) return "HIGH";
        if (n === 3) return "MEDIUM";
        if (n === 4) return "MEDIUM";
        return "LOW";
      }

      function computeDefensibility(sel, ctxKey, text){
        const ctx = CONTEXTS[ctxKey];

        // coverage score
        const coveragePct = Math.round((sel.length / SYSTEMS.length) * 100);
        const coverageScore = clamp(coveragePct, 0, 100);

        // quality score proxy
        const q = computeQualitySignals(sel);
        let qScore = 60;
        if (q.completeness === "LOW") qScore -= 15;
        if (q.definitionDrift === "MEDIUM") qScore -= 10;
        if (q.duplicates === "MEDIUM") qScore -= 8;
        qScore = clamp(qScore, 25, 85);

        // constraint score proxy (text length + presence of constraints tokens)
        const t = (text || "").toLowerCase();
        const tokens = ["audit", "window", "multi", "entity", "regulated", "exposure", "constraint", "24", "months"];
        let hits = tokens.reduce((a, k) => a + (t.includes(k) ? 1 : 0), 0);
        const len = (text || "").length;
        const lenScore = clamp(Math.round(len / 8), 0, 60);
        const cScore = clamp(30 + hits * 6 + Math.min(20, Math.round(lenScore/3)), 25, 85);

        // weighted final defensibility
        const def =
          ctx.weights.coverage * coverageScore +
          ctx.weights.quality * qScore +
          ctx.weights.constraints * cScore;

        return {
          coveragePct,
          coverageScore,
          qualitySignals: q,
          qualityScore: qScore,
          constraintScore: cScore,
          defensibility: Math.round(def)
        };
      }

      function setCockpit(data){
        metricScope.textContent = data.scope;
        metricMoment.textContent = data.moment;
        metricCoverage.textContent = `${data.coveragePct}%`;
        metricDef.textContent = `${data.defLabel} (${data.defensibility})`;
        metricExp.textContent = data.exposure;
        hashValue.textContent = data.hashShort;

        // hero chips
        chipMoment.textContent = data.moment || "—";
        chipSystems.textContent = `${data.selectedCount}/${SYSTEMS.length}`;
        chipQuality.textContent = `${data.qualitySignals.freshness} | ${data.qualitySignals.completeness}`;
        chipExposure.textContent = data.exposure;
        chipHash.textContent = data.hashShort;
      }

      function setOutputs(data){
        outCoverage.textContent = `${data.coveragePct}%`;
        outMissing.textContent = String(data.missingCount);
        outDef.textContent = `${data.defLabel} (${data.defensibility}/100)`;
        outExp.textContent = data.exposure;
        outHash.textContent = data.hash;

        // Escalation (NEW)
        escOwner.textContent = data.escalation.owner;
        escIt.textContent = data.escalation.addIT;
        escLegal.textContent = data.escalation.addLegal;
        escComex.textContent = data.escalation.comex;

        // Preview / JSON / invariants
        previewTag.textContent =
`Decision: ${data.decisionType}
Scope: ${data.scope}
Authority: ${data.authority}
Moment T: ${data.moment}
Declared sources: ${data.declaredSources.join(", ")}
Coverage: ${data.coveragePct}% | Missing: ${data.missingCount}
Defensibility: ${data.defensibility}/100 | Exposure: ${data.exposure}
Escalation band: ${data.band}`;

        jsonEl.textContent = JSON.stringify(data.bundle, null, 2);

        invEl.textContent =
`Invariants (audit-ready)
- Context: ${data.contextLabel} (${data.contextKey})
- Moment T: ${data.moment}
- Scope / Authority: ${data.scope} / ${data.authority}
- Declared sources: ${data.declaredSources.join(", ")}
- Coverage: ${data.coveragePct}% (selected ${data.selectedCount}/${SYSTEMS.length})
- Scoring: coverage-weight=${CONTEXTS[data.contextKey].weights.coverage}, quality-weight=${CONTEXTS[data.contextKey].weights.quality}, constraints-weight=${CONTEXTS[data.contextKey].weights.constraints}
- Quality checks: Freshness=${data.qualitySignals.freshness}, Completeness=${data.qualitySignals.completeness}, Definition drift=${data.qualitySignals.definitionDrift}, Duplicates=${data.qualitySignals.duplicates}, Risk=${data.qualitySignals.risk}
- Exposure: ${data.exposure} (deterministic rule)
- Escalation band: ${data.band}
- Hash: ${data.hash}
Note: the hash proves integrity over time, not "truth".`;
      }

      function setActiveTab(key){
        tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === key));
        panePreview.classList.toggle("active", key === "preview");
        paneJson.classList.toggle("active", key === "json");
        paneInv.classList.toggle("active", key === "invariants");
      }

      tabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.dataset.tab)));

      // ---------- Main generation ----------
      async function generate(){
        const contextKey = ctxSelect.value;
        const ctx = CONTEXTS[contextKey];

        const sel = selectedSystems();
        const miss = missingSystems();

        const def = computeDefensibility(sel, contextKey, decisionContext.value);
        const exposure = exposureFrom(sel, contextKey);
        const band = bandFrom(def.defensibility, exposure);
        const escalation = escalationFor(band);

        const moment = momentT.value || "—";
        const declaredSources = sel.map(s => s.label);

        // Deterministic bundle core (sealed content)
        const core = {
          rpo_version: "0.1",
          context: contextKey,
          moment_t: moment,
          scope: scope.value.trim(),
          authority: authority.value.trim(),
          decision_type: decisionType.value,
          constraints: decisionContext.value.trim(),
          declared_sources: declaredSources,
          missing_sources: miss.map(s => s.label),
          coverage_pct: def.coveragePct,
          defensibility_score: def.defensibility,
          exposure: exposure,
          escalation_band: band,
          escalation_path: escalation,
          quality_checks: def.qualitySignals,
          note: "Deterministic simulator. No AI. Hash proves integrity, not truth."
        };

        // Hash only the sealed core (stable serialization)
        const stable = JSON.stringify(core);
        const hash = await sha256Hex(stable);
        const hashShort = hash.slice(0, 10) + "…";

        const bundle = {
          sealed_core: core,
          seal: {
            algo: "SHA-256",
            hash,
            created_at_utc: new Date().toISOString()
          }
        };

        const defLabel = (def.defensibility >= 70) ? "HIGH" : (def.defensibility >= 55 ? "MEDIUM" : "LOW");

        const data = {
          contextKey,
          contextLabel: ctx.label,
          scope: core.scope,
          authority: core.authority,
          moment,
          decisionType: core.decision_type,
          declaredSources,
          selectedCount: sel.length,
          missingCount: miss.length,

          coveragePct: def.coveragePct,
          defensibility: def.defensibility,
          defLabel,
          exposure,
          band,
          escalation,

          qualitySignals: def.qualitySignals,
          hash,
          hashShort,

          bundle
        };

        setCockpit(data);
        setOutputs(data);
      }

      // ---------- Example + reset ----------
      function loadExample(){
        scope.value = "Industrial group — multi-sites, multi-entities (EU + non-EU)";
        authority.value = "Group HR Authority";
        decisionType.value = "Décision relative à la main-d’œuvre / aux RH";
        decisionContext.value =
`Regulated environment. Internal audit trigger. Need reconstructible workforce / learning records.
Constraints: audit window 24 months, multi-entity definitions, potential institutional exposure.`;

        // set a stricter example
        const set = new Set(["HRIS","LMS","OPS"]);
        $$(".sys").forEach(ch => ch.checked = set.has(ch.dataset.key));
      }

      function resetAll(){
        loadExample();
        // clear outputs (keep cockpit readable)
        $("#out-coverage").textContent = "—";
        $("#out-missing").textContent = "—";
        $("#out-def").textContent = "—";
        $("#out-exp").textContent = "—";
        $("#out-hash").textContent = "—";

        $("#esc-owner").textContent = "—";
        $("#esc-it").textContent = "—";
        $("#esc-legal").textContent = "—";
        $("#esc-comex").textContent = "—";

        $("#result-tagline").textContent = "Decision: —";
        $("#rpo-json").textContent = "{}";
        $("#invariants-block").textContent = "—";

        $("#metric-scope").textContent = "—";
        $("#metric-moment").textContent = "—";
        $("#metric-coverage").textContent = "—";
        $("#metric-def").textContent = "—";
        $("#metric-exp").textContent = "—";
        $("#hash-value").textContent = "—";

        chipMoment.textContent = "—";
        chipSystems.textContent = "—";
        chipQuality.textContent = "—";
        chipExposure.textContent = "—";
        chipHash.textContent = "—";
      }

      // Wire buttons
      genBtns.forEach(b => b.addEventListener("click", generate));
      if (resetBtn) resetBtn.addEventListener("click", resetAll);
      exampleBtns.forEach(b => b.addEventListener("click", () => { loadExample(); generate(); }));

      // Live update of chips
      function refreshChips(){
        chipMoment.textContent = momentT.value || "—";
        chipSystems.textContent = `${selectedSystems().length}/${SYSTEMS.length}`;
      }
      momentT.addEventListener("change", refreshChips);
      $$(".sys").forEach(ch => ch.addEventListener("change", refreshChips));

      // Boot
      loadExample();
      refreshChips();
      generate();
    })();
  </script>
</body>
</html>
