<!DOCTYPE html>
<html lang="fr" data-page="simulator">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof.net — RPO v0.1 | Simulateur</title>

  <!-- Global site styles -->
  <link rel="stylesheet" href="assets/site.css" />

  <!-- Page styles (lightweight) -->
  <style>
    :root{
      --bg0:#04040E;
      --bg1:#0b0f14;
      --gold0:#f1e6a3;
      --gold1:#d4af37;
      --gold2:#8f7633;
      --ink:#f7f3e8;
      --muted: rgba(247,243,232,.72);
      --panel: rgba(255,255,255,.04);
      --stroke: rgba(212,175,55,.22);
      --shadow: 0 18px 48px rgba(0,0,0,.52);
      --radius: 20px;
    }

    .wrap{ max-width: 1240px; margin: 0 auto; padding: 28px 18px 80px; }
    .hero{
      position: relative;
      padding: 28px 0 18px;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.3fr .9fr;
      gap: 22px;
      align-items: start;
    }
    @media (max-width: 980px){
      .heroGrid{ grid-template-columns: 1fr; }
    }
    .kicker{
      color: rgba(241,230,163,.82);
      letter-spacing:.22em;
      text-transform: uppercase;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .h1{
      font-family: Orbitron, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 700;
      line-height: 1.05;
      font-size: clamp(34px, 4.4vw, 64px);
      margin: 0 0 12px;
    }
    .lead{
      color: var(--muted);
      max-width: 58ch;
      font-size: 14.8px;
      line-height: 1.6;
      margin: 0 0 16px;
    }

    .panel{
      background: radial-gradient(1200px 400px at 18% -12%, rgba(212,175,55,.12), transparent 55%),
                  radial-gradient(900px 300px at 84% 0%, rgba(241,230,163,.08), transparent 55%),
                  var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .heroControls{ padding: 16px 16px 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .select{
      background: rgba(0,0,0,.32);
      border: 1px solid rgba(212,175,55,.25);
      color: var(--ink);
      border-radius: 999px;
      padding: 10px 12px;
      min-width: 240px;
      outline: none;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 12px; }
    .chip{
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(0,0,0,.22);
      color: rgba(247,243,232,.88);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      white-space: nowrap;
    }

    .btn{
      border-radius: 999px;
      padding: 12px 16px;
      border: 1px solid rgba(212,175,55,.35);
      cursor: pointer;
      font-weight: 650;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .btnPrimary{
      background: linear-gradient(90deg, rgba(241,230,163,.92), rgba(212,175,55,.92));
      color: #0b0f14;
      border-color: rgba(241,230,163,.65);
    }
    .btnGhost{
      background: rgba(0,0,0,.18);
      color: rgba(247,243,232,.88);
    }

    .cockpit{ padding: 16px; }
    .cockpitHead{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .cockpitTitle{
      font-family: Orbitron, system-ui, sans-serif;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(247,243,232,.78);
    }
    .metricGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .metric{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      color: rgba(247,243,232,.78);
      border-top: 1px dashed rgba(212,175,55,.18);
      padding-top: 8px;
    }
    .metric b{ color: rgba(241,230,163,.92); font-weight: 700; }
    .hash{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(212,175,55,.18);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11.5px;
      color: rgba(241,230,163,.78);
      word-break: break-all;
    }

    .sectionTitle{
      margin: 26px 0 10px;
      color: rgba(241,230,163,.78);
      text-transform: uppercase;
      letter-spacing: .18em;
      font-size: 12px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      align-items: start;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .simCard{ padding: 16px; }
    .simCard h3{
      margin: 0 0 10px;
      font-family: Orbitron, system-ui, sans-serif;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(247,243,232,.72);
    }
    .field{ margin-top: 10px; }
    .label{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .18em;
      color: rgba(241,230,163,.66);
      margin-bottom: 6px;
    }
    input[type="text"], input[type="date"], textarea{
      width:100%;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(212,175,55,.22);
      color: var(--ink);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      font-size: 13px;
    }
    textarea{ min-height: 96px; resize: vertical; line-height: 1.55; }

    .checkGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 680px){
      .checkGrid{ grid-template-columns: 1fr; }
    }
    .check{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(212,175,55,.16);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(247,243,232,.78);
      font-size: 12.8px;
      line-height: 1.4;
    }
    .check small{ display:block; color: rgba(247,243,232,.58); margin-top: 4px; }
    .check input{ margin-top: 2px; accent-color: var(--gold1); }

    .tabs{ display:flex; gap: 8px; flex-wrap:wrap; margin-top: 10px; }
    .tab{
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(0,0,0,.16);
      color: rgba(247,243,232,.82);
      cursor:pointer;
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .tab[aria-selected="true"]{
      border-color: rgba(241,230,163,.58);
      background: rgba(212,175,55,.14);
    }
    pre{
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(212,175,55,.18);
      border-radius: 14px;
      padding: 12px;
      overflow:auto;
      color: rgba(247,243,232,.84);
      font-size: 12px;
      line-height: 1.45;
      min-height: 160px;
      margin: 10px 0 0;
    }

    .actions{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 12px; }
    .actions .btn{ padding: 10px 12px; }

    /* Comparative */
    .cmp{ padding: 16px; }
    .cmpTop{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      align-items:end;
    }
    @media (max-width: 980px){
      .cmpTop{ grid-template-columns: 1fr; }
    }
    .rangeRow{ display:flex; gap: 10px; align-items:center; margin-top: 10px; }
    input[type="range"]{ width: 260px; }

    .cmpCards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .cmpCards{ grid-template-columns: 1fr; }
    }
    .cmp3{ grid-column: 1 / -1; }

    .delta{
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(212,175,55,.18);
      background: rgba(0,0,0,.14);
      color: rgba(247,243,232,.82);
      display:flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .delta b{ color: rgba(241,230,163,.92); }

    .cta{
      margin-top: 24px;
      padding: 18px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 14px;
      flex-wrap:wrap;
    }
    .cta p{ margin:0; color: rgba(247,243,232,.72); max-width: 78ch; }
  </style>
</head>

<body>
  <!-- Nav is assumed to be handled by assets/site.js if you have a shared header -->
  <main class="wrap">

    <!-- HERO + LIVE COCKPIT -->
    <section class="hero">
      <div class="heroGrid">

        <div>
          <div class="kicker">Simulateur déterministe</div>
          <h1 class="h1">SIMULATEUR.<br/>TROIS CONTEXTES. PAS D'IA.<br/>PAS D'INTERPRÉTATION.</h1>
          <p class="lead" id="contextIntro">
            Ce simulateur génère un paquet RPO (JSON scellé + vue lisible + hachage public) à partir d’un périmètre,
            de sources déclarées et de contrôles déterministes. Il n’établit pas la “vérité”. Il rend la décision reconstruisible.
          </p>

          <div class="panel heroControls">
            <div class="row">
              <select class="select" id="contextSelect" aria-label="Contexte">
                <option value="governance">Gouvernance</option>
                <option value="legal">Procédures judiciaires</option>
                <option value="crisis">Crise institutionnelle</option>
              </select>

              <button class="btn btnPrimary" id="btnGenerateTop">Générer un ensemble</button>
              <button class="btn btnGhost" id="btnLoadExampleTop">Exemple de chargement</button>
            </div>

            <div class="chips" id="contextChips"></div>

            <p class="lead" style="margin-top:12px;font-size:13px;">
              RPO = noyau JSON scellé + vue imprimable lisible + hachage public.
              Le hachage garantit l’intégrité dans le temps, et non la “vérité”.
              La vérification est publique. La responsabilité reste humaine.
            </p>
          </div>
        </div>

        <aside class="panel cockpit" aria-label="Cockpit live">
          <div class="cockpitHead">
            <div class="cockpitTitle">Simulateur de cockpit (en direct)</div>
            <div class="chip">Intégrité • Lisibilité • Vérifiabilité</div>
          </div>

          <div class="metricGrid">
            <div class="metric"><span>Périmètre</span><b id="cpScope">—</b></div>
            <div class="metric"><span>Moment T</span><b id="cpMoment">—</b></div>
            <div class="metric"><span>Complétude</span><b id="cpCoverage">—</b></div>
            <div class="metric"><span>Défendabilité</span><b id="cpDef">—</b></div>
            <div class="metric"><span>Exposition</span><b id="cpExposure">—</b></div>
          </div>

          <div class="hash">
            hachage : <span id="cpHash">—</span>
          </div>
        </aside>

      </div>
    </section>

    <!-- SIMULATOR (PROOF FIRST) -->
    <div class="sectionTitle">Simulateur — générateur de faisceaux déterministe</div>

    <section class="grid2">
      <!-- INPUT -->
      <div class="panel simCard">
        <h3>Input — périmètre</h3>

        <div class="field">
          <div class="label">Type de décision</div>
          <select id="decisionType" class="select" style="min-width:100%;border-radius:12px;">
            <option>Nomination / rôle sensible</option>
            <option>Sanction / mesure disciplinaire</option>
            <option>Mobilité / changement d’affectation</option>
            <option>Réorganisation / plan d’impact</option>
          </select>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field">
            <div class="label">Organisation / étendue</div>
            <input id="orgScope" type="text" value="Case perimeter — parties / entités / juridictions" />
          </div>
          <div class="field">
            <div class="label">Date de décision (Moment T)</div>
            <input id="momentT" type="date" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field">
            <div class="label">Authority / decision maker</div>
            <input id="owner" type="text" value="Global CHRO / Executive committee" />
          </div>
          <div class="field">
            <div class="label">Contexte de la décision (1 à 3 paragraphes)</div>
            <textarea id="contextText"></textarea>
          </div>
        </div>

        <div class="field">
          <div class="label">Sources déclarées (ce qui était réellement disponible)</div>
          <div class="checkGrid">
            <label class="check"><input id="srcLms" type="checkbox" checked />
              <div>
                LMS / fichiers de formation
                <small>Certifications, attestations, preuves documentées.</small>
              </div>
            </label>

            <label class="check"><input id="srcHris" type="checkbox" checked />
              <div>
                SIRH / parcours professionnel
                <small>Rôles, mobilité, changements, traces officielles.</small>
              </div>
            </label>

            <label class="check"><input id="srcPerf" type="checkbox" checked />
              <div>
                Évaluations de performance
                <small>Objectifs, revues, procédure formelle.</small>
              </div>
            </label>

            <label class="check"><input id="srcOps" type="checkbox" checked />
              <div>
                Résultats opérationnels
                <small>KPI attestés, livrables certifiés, mesures traçables.</small>
              </div>
            </label>

            <label class="check"><input id="src360" type="checkbox" />
              <div>
                Commentaires à 360 degrés
                <small>Uniquement si documenté et attribuable.</small>
              </div>
            </label>

            <label class="check"><input id="srcLegal" type="checkbox" checked />
              <div>
                Juridique / conformité
                <small>Contraintes, litiges, éléments opposés.</small>
              </div>
            </label>
          </div>
        </div>

        <div class="actions">
          <button class="btn btnPrimary" id="btnGenerate">Générer</button>
          <button class="btn btnGhost" id="btnLoadExample">Exemple de chargement</button>
          <button class="btn btnGhost" id="btnReset">Réinitialiser</button>
        </div>

        <p class="lead" style="margin-top:10px;font-size:12.5px;">
          Utilisation locale uniquement : aucune donnée n’est envoyée. Le paquet est généré dans votre navigateur.
          Règles déterministes uniquement.
        </p>
      </div>

      <!-- OUTPUT -->
      <div class="panel simCard">
        <h3>Output — evidentiary defensibility report</h3>

        <div class="metricGrid" style="margin-top:4px;">
          <div class="metric"><span>Couverture</span><b id="outCoverage">—</b></div>
          <div class="metric"><span>Manquant</span><b id="outMissing">—</b></div>
          <div class="metric"><span>Défendabilité</span><b id="outDef">—</b></div>
          <div class="metric"><span>Exposition</span><b id="outExposure">—</b></div>
          <div class="metric"><span>Joint</span><b id="outSeal">—</b></div>
        </div>

        <div class="tabs" role="tablist" aria-label="Sorties">
          <button class="tab" id="tabPreview" aria-selected="true" data-tab="preview">Aperçu</button>
          <button class="tab" id="tabJson" aria-selected="false" data-tab="json">JSON</button>
          <button class="tab" id="tabPdf" aria-selected="false" data-tab="pdf">PDF (impression)</button>
        </div>

        <pre id="outBox"></pre>

        <div class="actions">
          <button class="btn btnGhost" id="btnCopyHash">Copier le hachage</button>
          <button class="btn btnGhost" id="btnCopyJson">Copier le JSON</button>
          <button class="btn btnPrimary" id="btnDownloadJson">Télécharger JSON</button>
        </div>

        <div class="hash">
          hachage : <span id="outHash">—</span>
        </div>
      </div>
    </section>

    <!-- COMPARATIVE (PILOTAGE) -->
    <div class="sectionTitle">Cockpit comparatif — scénario de base vs scénario alternatif vs scénario de stress</div>

    <section class="panel cmp">
      <div class="cmpTop">
        <div class="field">
          <div class="label">Contexte de base</div>
          <select class="select" id="cmpBase" style="min-width:100%;border-radius:12px;">
            <option value="governance">Gouvernance</option>
            <option value="legal">Procédures judiciaires</option>
            <option value="crisis">Crise institutionnelle</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Contexte alternatif</div>
          <select class="select" id="cmpAlt" style="min-width:100%;border-radius:12px;">
            <option value="crisis">Crise institutionnelle</option>
            <option value="legal">Procédures judiciaires</option>
            <option value="governance">Gouvernance</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Scénario de stress (hypothétique)</div>
          <select class="select" id="cmpStress" style="min-width:100%;border-radius:12px;">
            <option value="media">Escalade médiatique</option>
            <option value="audit">Audit surprise</option>
            <option value="union">Mobilisation sociale</option>
          </select>
        </div>
      </div>

      <div class="rangeRow">
        <div class="label" style="margin:0;">Niveau de stress</div>
        <input id="cmpStressLvl" type="range" min="0" max="100" value="25" />
        <div class="chip"><span id="cmpStressLbl">25%</span></div>
      </div>

      <p class="lead" style="margin-top:10px;font-size:13px;">
        Analyse déterministe de scénarios hypothétiques : la pénalité pour les signaux faibles augmente avec la contrainte.
        Même entrée → même sortie. Le stress ne change pas les faits, il augmente l’exigence.
      </p>

      <div class="actions">
        <button class="btn btnPrimary" id="btnCompare">Comparaison des exécutions</button>
        <button class="btn btnGhost" id="btnAutoSync">Auto (synchronisation avec générer)</button>
      </div>

      <div class="cmpCards">
        <div class="panel simCard">
          <h3 id="cmpA_Title">Situation de référence — —</h3>
          <pre id="cmpA_Box"></pre>
        </div>

        <div class="panel simCard">
          <h3 id="cmpB_Title">Alternative — —</h3>
          <pre id="cmpB_Box"></pre>
        </div>

        <div class="panel simCard cmp3">
          <h3 id="cmpC_Title">Stress — —</h3>
          <pre id="cmpC_Box"></pre>
        </div>
      </div>

      <div class="delta" id="deltaBox">
        <div>
          <div style="font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:rgba(241,230,163,.7);">Delta et maillon faible</div>
          <div style="margin-top:6px;">
            <span id="deltaLeft">—</span>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:rgba(241,230,163,.7);">Action pilote</div>
          <div style="margin-top:6px;">
            <b id="deltaRight">—</b>
          </div>
        </div>
      </div>

      <p class="lead" style="margin-top:10px;font-size:12.7px;">
        La structure reste identique (RPO JSON/PDF/hash). Seuls le cadrage, les pondérations et le mappage des contraintes changent.
      </p>
    </section>

    <!-- CTA -->
    <section class="panel cta">
      <div>
        <div class="sectionTitle" style="margin:0 0 8px;">Prêt pour le cockpit du pilote ?</div>
        <p>
          Passez d’un simulateur déterministe à un vrai flux de travail ProofOps : connecteurs, extraits traçables,
          agrégats scellés et défensibilité décisionnelle reproductible.
        </p>
      </div>
      <a class="btn btnPrimary" href="https://www.truthx.co/truthx-pilote-form" target="_blank" rel="noopener noreferrer">Poste de pilotage</a>
    </section>
  </main>

  <!-- Global site scripts -->
  <script src="assets/site.js"></script>

  <!-- Sandbox API (context injection + safe UI apply) -->
  <script src="assets/sandbox.js"></script>

  <!-- Page logic -->
  <script>
    "use strict";

    const $ = (id) => document.getElementById(id);

    // -----------------------------
    // Contexts (single source)
    // -----------------------------
    const CONTEXTS = {
      governance: {
        key: "governance",
        label: "Gouvernance",
        intro: "Contexte de gouvernance : justification des décisions en cas d’audit. Focus sur le périmètre, la traçabilité, les définitions et la reconstitution au moment T.",
        chips: ["Moment T", "Declared systems", "Lineage", "Quality checks", "Audit exposure", "Public hash"],
        exposureLabel: "Audit exposure",
        exposureBand: (score) => score >= 75 ? "LOW" : score >= 55 ? "MEDIUM" : "HIGH",
        stressPenaltyBias: 0.25
      },
      legal: {
        key: "legal",
        label: "Procédures judiciaires",
        intro: "Contexte des procédures judiciaires : recevabilité des preuves en cas de litige. Analyse de la chaîne de possession, de l’attribution, des contradictions et de la reconstitution possible.",
        chips: ["Moment T", "Declared sources", "Chain-of-custody", "Attribution", "Contradictions", "Litigation exposure", "Public hash"],
        exposureLabel: "Litigation exposure",
        exposureBand: (score) => score >= 78 ? "LOW" : score >= 58 ? "MEDIUM" : "HIGH",
        stressPenaltyBias: 0.35
      },
      crisis: {
        key: "crisis",
        label: "Crise institutionnelle",
        intro: "Contexte de crise institutionnelle : reconstructibilité sous pression, consignation des incertitudes, contradictions, risque d’escalade et stabilisation du récit, en préservant l’intégrité de la chaîne probatoire.",
        chips: ["Moment T", "Declared sources", "Uncertainty logging", "Contradictions", "Escalation risk", "Institutional exposure", "Public hash"],
        exposureLabel: "Institutional exposure",
        exposureBand: (score) => score >= 72 ? "LOW" : score >= 52 ? "MEDIUM" : "HIGH",
        stressPenaltyBias: 0.45
      }
    };

    // -----------------------------
    // Deterministic scoring (simple + coherent)
    // -----------------------------
    const SOURCE_KEYS = ["srcLms","srcHris","srcPerf","srcOps","src360","srcLegal"];

    function getInputs(){
      return {
        decisionType: $("decisionType").value,
        orgScope: $("orgScope").value.trim(),
        owner: $("owner").value.trim(),
        momentT: $("momentT").value || "",
        contextText: $("contextText").value.trim(),
        sources: SOURCE_KEYS.reduce((acc,k)=> (acc[k]=!!$(k).checked, acc), {})
      };
    }

    function computeCoverage(inputs){
      const total = SOURCE_KEYS.length;
      const declared = SOURCE_KEYS.filter(k => inputs.sources[k]).length;
      const coverage = total === 0 ? 0 : Math.round((declared/total)*100);
      const missing = total - declared;
      return { coverage, missing, declared, total };
    }

    // Defensibility score = baseline from coverage + deterministic penalties
    function computeDefensibility(ctx, inputs, stressPct=0){
      const { coverage, missing } = computeCoverage(inputs);

      // Base score anchored to coverage (so it stays stable across UI)
      let score = Math.round( (coverage * 0.72) + 28 );

      // Deterministic penalties (no "AI")
      // 1) Missing sources hurts (context-weighted)
      score -= Math.round(missing * 6);

      // 2) If no momentT -> heavy penalty (reconstructibility)
      if (!inputs.momentT) score -= 18;

      // 3) If orgScope looks multi-entity -> definition drift risk penalty
      const multi = /multi|entit|juridic|parties|sites|multi-?sites/i.test(inputs.orgScope);
      if (multi) score -= 8;

      // 4) Stress increases penalty for weak signals, does NOT alter facts
      const stressBias = ctx.stressPenaltyBias || 0.3;
      score -= Math.round((stressPct/100) * 40 * stressBias);

      score = Math.max(0, Math.min(100, score));

      const band =
        score >= 85 ? "HIGH" :
        score >= 60 ? "MEDIUM" : "LOW";

      return { score, band };
    }

    function computeExposure(ctx, def){
      // Exposure is inversely related to defensibility; band function is context-specific.
      const band = ctx.exposureBand(def.score);
      return { label: ctx.exposureLabel, band };
    }

    // -----------------------------
    // Hashing (SHA-256)
    // -----------------------------
    async function sha256(text){
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest("SHA-256", enc.encode(text));
      const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
      return hex;
    }

    // -----------------------------
    // RPO bundle (minimal v0.1 style)
    // -----------------------------
    async function buildBundle(ctxKey, inputs, stressPct=0){
      const ctx = CONTEXTS[ctxKey] || CONTEXTS.governance;

      const cov = computeCoverage(inputs);
      const def = computeDefensibility(ctx, inputs, stressPct);
      const exposure = computeExposure(ctx, def);

      const core = {
        rpo_version: "0.1",
        context: ctx.key,
        moment_t: inputs.momentT || null,
        decision: {
          type: inputs.decisionType,
          scope: inputs.orgScope,
          authority: inputs.owner
        },
        declared_sources: Object.entries(inputs.sources)
          .filter(([,v])=>v)
          .map(([k])=>k.replace("src","").toLowerCase()),
        completeness: {
          coverage_pct: cov.coverage,
          missing_count: cov.missing
        },
        defensibility: {
          score: def.score,
          band: def.band
        },
        exposure: {
          label: exposure.label,
          band: exposure.band
        },
        deterministic_checks: {
          timestamp_rigor: inputs.momentT ? "MEDIUM" : "LOW",
          completeness: cov.coverage >= 80 ? "HIGH" : cov.coverage >= 55 ? "MEDIUM" : "LOW",
          contradiction_risk_proxy: cov.missing >= 2 ? "MEDIUM" : "LOW",
          duplicate_risk_proxy: /duplicate|doublon/i.test(inputs.contextText) ? "MEDIUM" : "LOW"
        },
        lineage_hint: {
          system: "HRIS",
          example: "workday",
          extract_id: `hris-${inputs.orgScope.toLowerCase().replace(/[^a-z0-9]+/g,"-").slice(0,42)}-v01`
        },
        notes: inputs.contextText || null,
        stress: stressPct ? { scenario: $("cmpStress")?.value || "none", level_pct: stressPct } : null
      };

      const coreText = JSON.stringify(core);
      const hash = await sha256(coreText);

      const bundle = {
        core,
        public_hash: hash,
        sealed: "SHA-256 sealed (core)"
      };

      return { ctx, cov, def, exposure, hash, bundle };
    }

    // -----------------------------
    // Rendering (single source of truth)
    // -----------------------------
    function renderCockpit(result){
      $("cpScope").textContent = result.bundle.core.decision.scope || "—";
      $("cpMoment").textContent = result.bundle.core.moment_t || "—";
      $("cpCoverage").textContent = `${result.cov.coverage}%`;
      $("cpDef").textContent = `${result.def.band} (${result.def.score})`;
      $("cpExposure").textContent = `${result.exposure.band}`;
      $("cpHash").textContent = result.hash;
    }

    function renderOutput(result, tab="preview"){
      $("outCoverage").textContent = `${result.cov.coverage}%`;
      $("outMissing").textContent = String(result.cov.missing);
      $("outDef").textContent = `${result.def.band} (${result.def.score}/100)`;
      $("outExposure").textContent = `${result.exposure.band}`;
      $("outSeal").textContent = result.bundle.sealed;
      $("outHash").textContent = result.hash;

      const core = result.bundle.core;
      if (tab === "json"){
        $("outBox").textContent = JSON.stringify(result.bundle, null, 2);
        return;
      }
      if (tab === "pdf"){
        $("outBox").textContent =
`[PDF impression] (placeholder)
Ce simulateur produit une vue lisible “imprimable”.
En production: génération PDF à partir du core JSON + scellé + hash public.`;
        return;
      }

      $("outBox").textContent =
`Decision: ${core.decision.type}
Perimeter: ${core.decision.scope}
Authority: ${core.decision.authority}
Moment T: ${core.moment_t ?? "—"}
Declared sources: ${core.declared_sources.join(", ") || "—"}

Evidentiary completeness: ${core.completeness.coverage_pct}% | Missing: ${core.completeness.missing_count}
Defensibility: ${core.defensibility.band} (${core.defensibility.score}/100)
${core.exposure.label}: ${core.exposure.band}

Lineage (example):
- ${core.lineage_hint.system}: ${core.lineage_hint.example} | extract_id: ${core.lineage_hint.extract_id}

Deterministic checks:
- Timestamp rigor: ${core.deterministic_checks.timestamp_rigor}
- Completeness: ${core.deterministic_checks.completeness}
- Contradiction risk proxy: ${core.deterministic_checks.contradiction_risk_proxy}
- Duplicate risk proxy: ${core.deterministic_checks.duplicate_risk_proxy}`;
    }

    function setTab(tab){
      for (const b of [$("tabPreview"),$("tabJson"),$("tabPdf")]){
        b.setAttribute("aria-selected", b.dataset.tab === tab ? "true" : "false");
      }
      window.__outTab = tab;
    }

    // -----------------------------
    // Context apply (and Sandbox injection)
    // -----------------------------
    function applyContext(key){
      const ctx = CONTEXTS[key] || CONTEXTS.governance;

      $("contextIntro").textContent = ctx.intro;
      $("contextChips").innerHTML = "";
      ctx.chips.forEach(c=>{
        const el = document.createElement("span");
        el.className = "chip";
        el.textContent = c;
        $("contextChips").appendChild(el);
      });

      // Provide context to Sandbox layer (if you use it elsewhere)
      window.__RPO_CONTEXT__ = { key: ctx.key, ui: { intro: ctx.intro, chips: ctx.chips } };
      if (window.Sandbox && typeof window.Sandbox.setContext === "function"){
        window.Sandbox.setContext(window.__RPO_CONTEXT__);
      }
    }

    // -----------------------------
    // Comparative rendering
    // -----------------------------
    function cmpText(result, titlePrefix){
      const core = result.bundle.core;
      return (
`${titlePrefix}
Couverture: ${result.cov.coverage}% 
Défendabilité: ${result.def.band} (${result.def.score}/100)
Exposition: ${result.exposure.band}
Joint: ${result.hash}

— Indicateur de risque de contradiction : ${core.deterministic_checks.contradiction_risk_proxy}
— Proxy de risque de doublon : ${core.deterministic_checks.duplicate_risk_proxy}

Meilleurs bloqueurs :
— Definition drift risk (portée multi-entités)

Prochaines actions :
— Freeze definitions (single dictionary) at Moment T

Joint:
— Hachage du noyau scellé (SHA-256) :
${result.hash}

Interprétation:
— L'intégrité est prouvée par le hachage au fil du temps ; la “vérité” reste une détermination humaine/judiciaire.`
      );
    }

    function renderDelta(base, alt, stress, stressPct){
      const dDefAlt = alt.def.score - base.def.score;
      const dDefStress = stress.def.score - base.def.score;

      const weakLink =
        (stress.def.score < alt.def.score && stress.def.score < base.def.score)
          ? "Stress → horodatage & gel des définitions deviennent le point de levier."
          : (alt.def.score < base.def.score)
            ? "Contexte alternatif → risque de contradictions à consigner explicitement."
            : "Base stable → vérifier la cohérence de définition inter-entités.";

      const action =
        stressPct >= 35
          ? "Capture d’instantanés + horodatage rigoureux de Freeze Moment T — avant escalade."
          : "Renforcer les sources attribuables + sceller le dictionnaire de définitions.";

      $("deltaLeft").textContent =
`Δ Défendabilité (alt): ${dDefAlt >= 0 ? "+" : ""}${dDefAlt} | Δ Défendabilité (stress): ${dDefStress >= 0 ? "+" : ""}${dDefStress} | Stress: ${stressPct}% — ${weakLink}`;

      $("deltaRight").textContent = action;
    }

    // -----------------------------
    // Actions
    // -----------------------------
    async function runGenerate(){
      const ctxKey = $("contextSelect").value;
      const inputs = getInputs();
      const result = await buildBundle(ctxKey, inputs, 0);

      window.__lastResult = result;
      renderCockpit(result);
      renderOutput(result, window.__outTab || "preview");

      // Optional auto compare
      if (window.__autoCompare){
        await runCompare();
      }
    }

    async function runCompare(){
      const inputs = getInputs();
      const baseKey = $("cmpBase").value;
      const altKey = $("cmpAlt").value;
      const stressPct = parseInt($("cmpStressLvl").value, 10) || 0;

      const base = await buildBundle(baseKey, inputs, 0);
      const alt = await buildBundle(altKey, inputs, 0);

      // Stress scenario uses base context but higher penalty (keeps facts identical)
      const stress = await buildBundle(baseKey, inputs, stressPct);

      $("cmpA_Title").textContent = `Situation de référence — ${CONTEXTS[baseKey].label}`;
      $("cmpB_Title").textContent = `Alternative — ${CONTEXTS[altKey].label}`;
      $("cmpC_Title").textContent = `Stress — ${$("cmpStress").value} (${stressPct}%)`;

      $("cmpA_Box").textContent = cmpText(base, "");
      $("cmpB_Box").textContent = cmpText(alt, "");
      $("cmpC_Box").textContent = cmpText(stress, "");

      renderDelta(base, alt, stress, stressPct);
    }

    function loadExample(){
      $("momentT").value = "2026-02-10";
      $("contextText").value =
`Active or expected litigation. Evidence must be attributable, timestamped, and reconstructible.
Focus: chain-of-custody, contradictions, and court-grade defensibility.`;
      $("orgScope").value = "Case perimeter — parties / entités / juridictions";
      $("owner").value = "Global CHRO / Executive committee";
      $("decisionType").value = "Nomination / rôle sensible";
      $("src360").checked = false;
    }

    function resetAll(){
      $("momentT").value = "";
      $("contextText").value = "";
      $("orgScope").value = "";
      $("owner").value = "";
      SOURCE_KEYS.forEach(k => $(k).checked = (k !== "src360"));
      window.__lastResult = null;

      $("cpScope").textContent = "—";
      $("cpMoment").textContent = "—";
      $("cpCoverage").textContent = "—";
      $("cpDef").textContent = "—";
      $("cpExposure").textContent = "—";
      $("cpHash").textContent = "—";

      $("outCoverage").textContent = "—";
      $("outMissing").textContent = "—";
      $("outDef").textContent = "—";
      $("outExposure").textContent = "—";
      $("outSeal").textContent = "—";
      $("outHash").textContent = "—";
      $("outBox").textContent = "";
    }

    async function copyText(txt){
      try{ await navigator.clipboard.writeText(txt); }catch(e){}
    }

    function downloadJson(obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rpo_bundle.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -----------------------------
    // Wire UI (IMPORTANT: single listener)
    // -----------------------------
    function wire(){
      // default date placeholder if empty
      if (!$("momentT").value){
        const d = new Date();
        const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
        $("momentT").value = iso;
      }

      // Context dropdown — ONE handler only
      $("contextSelect").addEventListener("change", (e)=>{
        const key = e.target.value;
        applyContext(key);

        // Keep comparative baseline aligned
        const cmp = $("cmpBase");
        if (cmp) cmp.value = key;
      });

      $("btnGenerateTop").addEventListener("click", runGenerate);
      $("btnLoadExampleTop").addEventListener("click", ()=>{ loadExample(); runGenerate(); });

      $("btnGenerate").addEventListener("click", runGenerate);
      $("btnLoadExample").addEventListener("click", ()=>{ loadExample(); runGenerate(); });
      $("btnReset").addEventListener("click", resetAll);

      // Tabs
      for (const t of [$("tabPreview"),$("tabJson"),$("tabPdf")]){
        t.addEventListener("click", ()=>{
          setTab(t.dataset.tab);
          if (window.__lastResult) renderOutput(window.__lastResult, window.__outTab);
        });
      }
      setTab("preview");

      // Copy / download
      $("btnCopyHash").addEventListener("click", ()=> copyText($("outHash").textContent || ""));
      $("btnCopyJson").addEventListener("click", ()=> window.__lastResult ? copyText(JSON.stringify(window.__lastResult.bundle, null, 2)) : null);
      $("btnDownloadJson").addEventListener("click", ()=> window.__lastResult ? downloadJson(window.__lastResult.bundle) : null);

      // Comparative
      $("cmpStressLvl").addEventListener("input", ()=>{
        $("cmpStressLbl").textContent = `${$("cmpStressLvl").value}%`;
      });

      $("btnCompare").addEventListener("click", runCompare);
      $("btnAutoSync").addEventListener("click", ()=>{
        window.__autoCompare = !window.__autoCompare;
        $("btnAutoSync").classList.toggle("btnPrimary", window.__autoCompare);
        $("btnAutoSync").classList.toggle("btnGhost", !window.__autoCompare);
      });

      // Init context
      const startKey = $("contextSelect").value || "governance";
      applyContext(startKey);
      $("cmpBase").value = startKey;

      // First render
      runGenerate();
    }

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", wire, { once:true });
    } else {
      wire();
    }
  </script>
</body>
</html>



