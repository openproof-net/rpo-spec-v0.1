<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OpenProof — Psycho-forensic Demo | Narrative pattern decoder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO -->
  <meta name="description"
        content="OpenProof psycho-forensic demo: paste a short narrative and see how structural patterns of coercive control and narrative mechanisms are highlighted, on top of a minimal RPO logic." />
  <link rel="canonical" href="https://rpo.openproof.net/demo-psycho.html" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="OpenProof — Psycho-forensic Demo" />
  <meta property="og:description"
        content="Narrative pattern decoder: from raw story to structural signals of coercive control, risk, and narrative phenotype." />
  <meta property="og:url" content="https://rpo.openproof.net/demo-psycho.html" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #04040e;
      --bg-elevated: #0b0f14;
      --panel: #f8f2e6;
      --panel-soft: #fbf6ee;
      --panel-border: #d4af37;
      --text-main: #f7f3e8;
      --text-muted: #d1c8b3;
      --ink: #7a6432;
      --accent-gold: #f1e6a3;
      --accent-gold-strong: #d4af37;
      --pill-bg: rgba(244, 221, 158, 0.08);
      --danger: #ff5c7a;
      --warn: #ffb347;
      --safe: #60d394;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
      --radius-xl: 22px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top left, #182032 0, #04040e 50%, #020309 100%);
      color: var(--text-main);
    }

    a {
      color: var(--accent-gold);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Top nav */
    .top-nav {
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(22px);
      background: linear-gradient(to right, rgba(4,4,14,0.96), rgba(4,4,14,0.88));
      border-bottom: 1px solid rgba(212,175,55,0.18);
    }

    .top-nav-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #f6f0da, #cda94b 45%, #60441a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 8px 18px rgba(0,0,0,0.65);
      font-size: 18px;
      color: #3b2a0d;
      font-family: 'Orbitron', system-ui;
    }

    .brand-text-main {
      font-family: 'Orbitron', system-ui;
      letter-spacing: 0.12em;
      font-size: 11px;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 13px;
    }

    .nav-links a {
      color: var(--text-muted);
      text-decoration: none;
      position: relative;
      padding-bottom: 2px;
    }

    .nav-links a:hover {
      color: var(--accent-gold);
    }

    .nav-links a.nav-active {
      color: var(--accent-gold);
    }

    .nav-links a.nav-active::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 100%;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, #d4af37, #f1e6a3);
    }

    .nav-cta {
      padding: 7px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(241, 230, 163, 0.6);
      background: radial-gradient(circle at 0 0, rgba(241,230,163,0.2), rgba(4,4,14,0.9));
      font-size: 12px;
      color: var(--accent-gold);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .nav-cta span {
      font-family: 'Orbitron', system-ui;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
    }

    /* Layout */
    .page {
      max-width: 1120px;
      margin: 32px auto 64px;
      padding: 0 22px 40px;
    }

    .hero {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 30px;
      margin-bottom: 38px;
      align-items: center;
    }

    .hero-title-kicker {
      font-family: 'Orbitron', system-ui;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .hero-title {
      font-family: 'Orbitron', system-ui;
      font-size: 30px;
      line-height: 1.18;
      margin: 0 0 14px;
      color: #f6f1d9;
    }

    .hero-title span {
      color: var(--accent-gold);
    }

    .hero-sub {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 520px;
    }

    .hero-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }

    .chip {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(241,230,163,0.35);
      background: var(--pill-bg);
      color: var(--accent-gold);
    }

    .hero-panel {
      background: radial-gradient(circle at 0 0, rgba(241,230,163,0.15), rgba(11,15,20,0.98));
      border-radius: var(--radius-xl);
      border: 1px solid rgba(212,175,55,0.5);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 20px;
      font-size: 13px;
      color: var(--text-main);
    }

    .hero-panel h3 {
      margin: 0 0 10px;
      font-family: 'Orbitron', system-ui;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 11px;
      color: var(--accent-gold);
    }

    .hero-panel ul {
      margin: 8px 0 10px 18px;
      padding: 0;
    }

    .hero-panel li {
      margin-bottom: 4px;
    }

    .hero-panel small {
      display: block;
      margin-top: 8px;
      color: var(--text-muted);
      font-size: 11px;
    }

    /* Main panels */
    .section-title {
      font-family: 'Orbitron', system-ui;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 26px;
      align-items: flex-start;
    }

    .panel {
      background: radial-gradient(circle at top left, #fbf6ee, #f2e6d2);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(212,175,55,0.7);
      box-shadow: var(--shadow-soft);
      padding: 20px 22px 22px;
      color: #3e3115;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-family: 'Orbitron', system-ui;
      letter-spacing: 0.16em;
      font-size: 13px;
      text-transform: uppercase;
      color: #7a6432;
    }

    .panel p {
      margin: 6px 0 10px;
      font-size: 13px;
      color: #6f5a32;
    }

    .field-label {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #a2864c;
      margin-bottom: 4px;
    }

    input[type="text"], textarea, select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(188,160,92,0.6);
      padding: 9px 10px;
      font-family: inherit;
      font-size: 13px;
      background: rgba(255,255,255,0.76);
      color: #3b2d10;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      line-height: 1.4;
    }

    input:focus, textarea:focus, select:focus {
      border-color: #d4af37;
      box-shadow: 0 0 0 1px rgba(212,175,55,0.55);
      background: #ffffff;
    }

    .field-tip {
      font-size: 11px;
      color: #9a8350;
      margin-top: 4px;
    }

    .form-row {
      margin-bottom: 12px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-main {
      border-radius: var(--radius-pill);
      padding: 9px 18px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      background: radial-gradient(circle at 0 0, #f8eab8, #d4af37);
      color: #3b2d10;
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-main span {
      font-family: 'Orbitron', system-ui;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
    }

    .btn-ghost {
      border-radius: var(--radius-pill);
      padding: 8px 16px;
      border: 1px solid rgba(139,112,63,0.7);
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      color: #7a6432;
    }

    .btn-main:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    /* Result side */
    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 12px;
    }

    .badge-score {
      border-radius: var(--radius-pill);
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid rgba(0,0,0,0.09);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-score strong {
      font-family: 'Orbitron', system-ui;
      font-size: 12px;
    }

    .badge-score[data-risk="low"] {
      background: rgba(96, 211, 148, 0.2);
      border-color: rgba(96, 211, 148, 0.55);
      color: #225638;
    }

    .badge-score[data-risk="medium"] {
      background: rgba(255, 179, 71, 0.2);
      border-color: rgba(255, 179, 71, 0.65);
      color: #7a4a16;
    }

    .badge-score[data-risk="high"] {
      background: rgba(255, 92, 122, 0.18);
      border-color: rgba(255, 92, 122, 0.7);
      color: #812335;
    }

    .two-col {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 14px;
      margin-top: 10px;
    }

    .subpanel {
      background: var(--panel-soft);
      border-radius: 16px;
      border: 1px dashed rgba(122,100,50,0.4);
      padding: 10px 12px 12px;
      font-size: 12px;
      color: #5f4720;
    }

    .subpanel h3 {
      margin: 0 0 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-family: 'Orbitron', system-ui;
      color: #90723a;
    }

    .subpanel ul {
      margin: 4px 0 0 16px;
      padding: 0;
    }

    .subpanel li {
      margin-bottom: 3px;
    }

    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 12px;
    }

    .matrix-table th,
    .matrix-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(122,100,50,0.15);
      text-align: left;
    }

    .matrix-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9a8044;
    }

    .level {
      font-weight: 600;
    }

    .level-low {
      color: #3c6f4a;
    }

    .level-medium {
      color: #a46a1c;
    }

    .level-high {
      color: #a8263f;
    }

    .mono-block {
      margin-top: 10px;
      padding: 8px 10px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      max-height: 180px;
      overflow: auto;
      border: 1px solid rgba(15,23,42,0.9);
    }

    .mono-block strong {
      color: #facc15;
    }

    .footer-banner {
      margin-top: 26px;
      background: radial-gradient(circle at 0 0, rgba(241,230,163,0.14), rgba(11,15,20,0.98));
      border-radius: var(--radius-xl);
      border: 1px solid rgba(212,175,55,0.55);
      padding: 16px 18px;
      font-size: 13px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: var(--text-main);
    }

    .footer-banner p {
      margin: 0;
      max-width: 620px;
      font-size: 13px;
    }

    .footer-banner small {
      color: var(--text-muted);
      font-size: 11px;
      display: block;
      margin-top: 4px;
    }

    .footer-cta {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(241,230,163,0.8);
      padding: 9px 16px;
      font-size: 12px;
      background: radial-gradient(circle at 0 0, #f9efc9, #d4af37);
      color: #3b2d10;
      text-decoration: none;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .footer-cta span {
      font-family: 'Orbitron', system-ui;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 9px;
    }

    .disclaimer {
      margin-top: 10px;
      font-size: 11px;
      color: #a3a3a3;
      text-align: right;
    }

    @media (max-width: 900px) {
      .hero {
        grid-template-columns: minmax(0, 1fr);
      }
      .grid-main {
        grid-template-columns: minmax(0, 1fr);
      }
      .two-col {
        grid-template-columns: minmax(0, 1fr);
      }
      .top-nav-inner {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
<header class="top-nav">
  <div class="top-nav-inner">
    <div class="brand">
      <div class="brand-logo">Ø</div>
      <div>
        <div class="brand-text-main">OPENPROOF — RPO v0.1</div>
        <div class="brand-text-sub">Signed JSON • Human-readable PDF • Public hash</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="overview.html">Overview</a>
      <a href="index.html">Specification</a>
      <a href="examples.html">Examples</a>
      <a href="tests.html">Tests</a>
      <a href="playground.html">Playground</a>
      <a href="demo-psycho.html" class="nav-active">Psycho-forensic demo</a>
      <a href="https://github.com/openproof-net/rpo-spec-v0.1" class="nav-cta" target="_blank" rel="noopener noreferrer">
        <span>View on GitHub</span>
      </a>
    </nav>
  </div>
</header>

<main class="page">
  <section class="hero">
    <div>
      <div class="hero-title-kicker">RPO demo layer · narrative mechanics</div>
      <h1 class="hero-title">
        Try the <span>psycho-forensic demo</span> — from raw story to narrative patterns
      </h1>
      <p class="hero-sub">
        Paste a short narrative involving potential coercion (domestic, workplace, online). This demo detects structural
        mechanisms of control, estimates a rough coercive control score, and exposes the narrative phenotype. Everything
        runs locally in your browser, without any AI model.
      </p>
      <div class="hero-chips">
        <div class="chip">Pattern-based</div>
        <div class="chip">Non-AI demo</div>
        <div class="chip">Coercive control focus</div>
        <div class="chip">RPO-compatible narrative layer</div>
      </div>
    </div>

    <aside class="hero-panel">
      <h3>What this demo illustrates</h3>
      <p>
        This page simulates the <em>psycho-forensic layer</em> that can sit on top of the RPO standard:
      </p>
      <ul>
        <li>Detecting <strong>mechanisms of control</strong> (lock-in, threats, surveillance).</li>
        <li>Mapping them into a <strong>coercive control matrix</strong>.</li>
        <li>Estimating an <strong>emprise score</strong> and risk level.</li>
        <li>Highlighting <strong>signals to monitor</strong> and the narrative phenotype.</li>
      </ul>
      <small>
        It does <strong>not</strong> replace legal, clinical, or police assessment. It is a structural decoder,
        not a diagnostic tool.
      </small>
    </aside>
  </section>

  <section>
    <div class="section-title">Play with a narrative</div>
    <div class="grid-main">
      <!-- INPUT PANEL -->
      <div class="panel">
        <h2>1. Input narrative</h2>
        <p>
          Paste a short narrative (1–3 paragraphs). Names can be anonymised. The goal is to observe the
          <strong>structure of control</strong>, not to judge the case.
        </p>

        <div class="form-row">
          <div class="field-label">Context</div>
          <select id="contextSelect">
            <option value="unspecified">Unspecified / generic</option>
            <option value="domestic">Intimate / domestic relationship</option>
            <option value="workplace">Workplace / managerial</option>
            <option value="institutional">Institutional / administrative</option>
            <option value="online">Online / digital</option>
          </select>
        </div>

        <div class="form-row">
          <div class="field-label">Narrative (free text)</div>
          <textarea id="narrativeInput" placeholder="Describe what happened, in your own words.
Who did what, when, where, and how did it make you or others feel?"></textarea>
          <div class="field-tip">
            Tip: include at least one concrete action, a time marker, and any threats, justifications or
            constraints you remember.
          </div>
        </div>

        <div class="btn-row">
          <button class="btn-main" id="analyzeBtn">
            <span>Analyze narrative</span> →
          </button>
          <button class="btn-ghost" id="resetBtn">Reset</button>
        </div>
      </div>

      <!-- RESULT PANEL -->
      <div class="panel">
        <h2>2. Psycho-forensic overlay</h2>
        <p id="statusText">
          Paste a narrative on the left and click <strong>Analyze</strong> to reveal the structural patterns of control.
        </p>

        <div class="badge-row" id="badgesRow" style="display:none;">
          <div class="badge-score" id="scoreBadge" data-risk="medium">
            <strong id="scoreValue">0%</strong>
            <span>coercive control score</span>
          </div>
          <div class="badge-score" id="riskBadge" data-risk="medium">
            <strong id="riskLabel">–</strong>
            <span>risk level</span>
          </div>
        </div>

        <div class="two-col">
          <div class="subpanel">
            <h3>Mechanisms detected</h3>
            <ul id="mechanismsList">
              <li>No narrative analysed yet.</li>
            </ul>
          </div>

          <div class="subpanel">
            <h3>Coercive control matrix</h3>
            <table class="matrix-table" id="matrixTable">
              <thead>
              <tr>
                <th>Axis</th>
                <th>Level</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td>Isolation / confinement</td>
                <td class="level level-low">None yet</td>
              </tr>
              <tr>
                <td>Surveillance &amp; suspicion</td>
                <td class="level level-low">None yet</td>
              </tr>
              <tr>
                <td>Control of communications</td>
                <td class="level level-low">None yet</td>
              </tr>
              <tr>
                <td>Threats &amp; sanctions</td>
                <td class="level level-low">None yet</td>
              </tr>
              <tr>
                <td>Economic / resource control</td>
                <td class="level level-low">None yet</td>
              </tr>
              <tr>
                <td>Normalisation &amp; gaslighting</td>
                <td class="level level-low">None yet</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="two-col" style="margin-top:14px;">
          <div class="subpanel">
            <h3>Signals to monitor</h3>
            <ul id="signalsList">
              <li>Signals will appear once a narrative has been analysed.</li>
            </ul>
          </div>

          <div class="subpanel">
            <h3>Narrative phenotype</h3>
            <ul id="phenotypeList">
              <li>Sentence count, density of anchors, and tone will be summarised here.</li>
            </ul>
          </div>
        </div>

        <div class="mono-block" id="debugBlock" style="display:none;">
          <strong>Debug view</strong> — internal demo scores:
          <div id="debugContent"></div>
        </div>
      </div>
    </div>

    <div class="footer-banner">
      <div>
        <p>
          Here you see the <strong>open psycho-forensic demo</strong>: a deterministic narrative decoder built on top
          of the RPO logic. For a scientific CNRS × TruthX pilot with advanced psycho-forensic modules and real cases,
          you can apply to the restricted programme.
        </p>
        <small>
          The demo does not decide truth or falsity and does not replace legal or clinical assessment. It only exposes
          structural patterns that may need attention.
        </small>
      </div>
      <a class="footer-cta" href="https://www.truthx.co/truthx-pilote-form" target="_blank" rel="noopener noreferrer">
        <span>Apply for the CNRS pilot</span> ↗
      </a>
    </div>

    <div class="disclaimer">
      Demo logic is heuristic and intentionally conservative. It is meant for experimentation, not diagnosis.
    </div>
  </section>
</main>

<script>
  function analyzeNarrative(text, context) {
    const lower = text.toLowerCase();

    // Simple keyword-based pattern matching
    const patterns = {
      isolation: /(locked|shut in|kept me in|blocked the door|confined|couldn['’]t leave|trapped)/,
      surveillance: /(checking my|went through my|read my messages|monitoring|spy|tracking|accusing me of hiding|snooping)/,
      comms: /(took my phone|no one needed to hear|blocked me|removed me from|forbade me to call|no need to talk)/,
      threats: /(threaten(ed)?|or else|if you don['’]t|take the keys|kick(ed)? out|lose your job|take the car|you will regret)/,
      economic: /(card|bank|money|account|allowance|paycheck|blocked access|withheld|took my salary)/,
      norm: /(normal for couples|everyone does this|you are overreacting|it[’']s nothing|you are crazy|gaslighting)/,
      sleep: /(woke me up at|middle of the night|kept me awake)/,
    };

    const mechanisms = [];
    const matrix = {
      isolation: 0,
      surveillance: 0,
      comms: 0,
      threats: 0,
      economic: 0,
      norm: 0
    };

    if (patterns.isolation.test(lower)) {
      mechanisms.push("Confinement / isolation (locked in, blocked from leaving).");
      matrix.isolation = 2;
    }
    if (patterns.surveillance.test(lower)) {
      mechanisms.push("Surveillance & suspicion (monitoring phone, messages, conversations).");
      matrix.surveillance = 2;
    }
    if (patterns.comms.test(lower)) {
      mechanisms.push("Control of communications (phone confiscation, blocking access to others).");
      matrix.comms = 2;
    }
    if (patterns.threats.test(lower)) {
      mechanisms.push("Threats & sanctions (conditions, ultimatums, withdrawal of resources).");
      matrix.threats = 2;
    }
    if (patterns.economic.test(lower)) {
      mechanisms.push("Economic / resource control (money, cards, access to essentials).");
      matrix.economic = 2;
    }
    if (patterns.norm.test(lower)) {
      mechanisms.push("Normalisation & gaslighting (“it’s normal”, minimising, making you doubt your perception).");
      matrix.norm = 2;
    }

    // Simple narrative stats
    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
    const wordCount = text.split(/\s+/).filter(w => w.trim().length > 0).length;
    const hasTimeMarkers = /(monday|tuesday|wednesday|thursday|friday|saturday|sunday|am|pm|morning|evening|night|week|day|month|year|\d{1,2}\s?(am|pm))/i.test(text);
    const hasDateMarkers = /\b\d{1,2}\s?(january|february|march|april|may|june|july|august|september|october|november|december)\b/i.test(text);
    const hasPlaceMarkers = /(kitchen|bedroom|office|living room|car|home|flat|house|school|work|police|station)/i.test(text);
    const firstPerson = /\bi\b/.test(lower);

    // Emprise score: very simple aggregation
    const axesTriggered = Object.values(matrix).filter(v => v > 0).length;
    let score = 10 * axesTriggered;

    if (hasTimeMarkers) score += 8;
    if (hasDateMarkers) score += 7;
    if (hasPlaceMarkers) score += 5;
    if (sentences >= 3) score += 8;

    if (context === "domestic") score += 5;
    if (context === "workplace") score += 3;

    score = Math.max(0, Math.min(96, score));
    let riskLabel = "Moderate";
    let riskLevel = "medium";

    if (score >= 70) {
      riskLabel = "High";
      riskLevel = "high";
    } else if (score <= 40) {
      riskLabel = "Low";
      riskLevel = "low";
    }

    // Signals to monitor
    const signals = [];
    if (matrix.isolation) signals.push("Pattern of isolation or confinement. Monitor how often physical freedom is restricted.");
    if (matrix.surveillance) signals.push("Intrusive surveillance of communications or movements. Check if this becomes routine.");
    if (matrix.comms) signals.push("Control over who you can talk to or when. Loss of contact with friends / family is a red flag.");
    if (matrix.threats) signals.push("Use of threats or conditions to obtain obedience. Note escalation in the nature of threats.");
    if (matrix.economic) signals.push("Control of money, accounts or essential resources. Track who decides what can be spent and how.");
    if (matrix.norm) signals.push("Repeated use of “it’s normal / you’re crazy” to justify control. Watch self-doubt growing over time.");

    if (signals.length === 0) {
      signals.push("No strong coercive pattern detected by this demo. If something still feels unsafe, professional advice is recommended.");
    }

    // Phenotype description
    const phenotype = [];
    phenotype.push(`Approx. ${sentences} sentence(s), ~${wordCount} word(s).`);
    if (hasDateMarkers || hasTimeMarkers) phenotype.push("Concrete temporal anchors present (dates / time of day).");
    else phenotype.push("Few explicit time markers — events may feel blurred in memory.");
    if (hasPlaceMarkers) phenotype.push("Spatial anchors present (places, rooms, or locations).");
    if (firstPerson) phenotype.push("First-person narrative — the speaker is directly involved in the events.");
    phenotype.push("This description is heuristic, not clinical: it helps structure the story, not judge it.");

    return {
      mechanisms,
      matrix,
      score,
      riskLabel,
      riskLevel,
      signals,
      phenotype,
      debug: {
        sentences,
        wordCount,
        hasTimeMarkers,
        hasDateMarkers,
        hasPlaceMarkers,
        context
      }
    };
  }

  const narrativeInput = document.getElementById('narrativeInput');
  const contextSelect = document.getElementById('contextSelect');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const resetBtn = document.getElementById('resetBtn');

  const statusText = document.getElementById('statusText');
  const badgesRow = document.getElementById('badgesRow');
  const scoreBadge = document.getElementById('scoreBadge');
  const scoreValue = document.getElementById('scoreValue');
  const riskBadge = document.getElementById('riskBadge');
  const riskLabel = document.getElementById('riskLabel');

  const mechanismsList = document.getElementById('mechanismsList');
  const matrixTable = document.getElementById('matrixTable').querySelector('tbody');
  const signalsList = document.getElementById('signalsList');
  const phenotypeList = document.getElementById('phenotypeList');
  const debugBlock = document.getElementById('debugBlock');
  const debugContent = document.getElementById('debugContent');

  function clearResults() {
    badgesRow.style.display = 'none';
    mechanismsList.innerHTML = '<li>No narrative analysed yet.</li>';
    signalsList.innerHTML = '<li>Signals will appear once a narrative has been analysed.</li>';
    phenotypeList.innerHTML = '<li>Sentence count, density of anchors, and tone will be summarised here.</li>';
    matrixTable.innerHTML = `
      <tr><td>Isolation / confinement</td><td class="level level-low">None yet</td></tr>
      <tr><td>Surveillance &amp; suspicion</td><td class="level level-low">None yet</td></tr>
      <tr><td>Control of communications</td><td class="level level-low">None yet</td></tr>
      <tr><td>Threats &amp; sanctions</td><td class="level level-low">None yet</td></tr>
      <tr><td>Economic / resource control</td><td class="level level-low">None yet</td></tr>
      <tr><td>Normalisation &amp; gaslighting</td><td class="level level-low">None yet</td></tr>
    `;
    debugBlock.style.display = 'none';
    debugContent.textContent = '';
    statusText.textContent = 'Paste a narrative on the left and click “Analyze” to reveal the structural patterns of control.';
  }

  function levelLabel(value) {
    if (value >= 2) return { text: 'High', cls: 'level-high' };
    if (value === 1) return { text: 'Medium', cls: 'level-medium' };
    return { text: 'Low / none', cls: 'level-low' };
  }

  analyzeBtn.addEventListener('click', () => {
    const text = narrativeInput.value.trim();
    if (!text) {
      alert('Please paste a narrative first.');
      return;
    }
    analyzeBtn.disabled = true;
    analyzeBtn.querySelector('span').textContent = 'Analyzing…';

    const result = analyzeNarrative(text, contextSelect.value);

    // Score & risk
    scoreValue.textContent = `${result.score}%`;
    riskLabel.textContent = result.riskLabel;

    scoreBadge.dataset.risk = result.riskLevel;
    riskBadge.dataset.risk = result.riskLevel;

    badgesRow.style.display = 'flex';

    // Mechanisms
    mechanismsList.innerHTML = '';
    if (result.mechanisms.length === 0) {
      mechanismsList.innerHTML = '<li>No major coercive mechanism detected by this demo. This does not mean there is no issue.</li>';
    } else {
      result.mechanisms.forEach(m => {
        const li = document.createElement('li');
        li.textContent = m;
        mechanismsList.appendChild(li);
      });
    }

    // Matrix
    matrixTable.innerHTML = '';
    const rows = [
      ['Isolation / confinement', result.matrix.isolation],
      ['Surveillance & suspicion', result.matrix.surveillance],
      ['Control of communications', result.matrix.comms],
      ['Threats & sanctions', result.matrix.threats],
      ['Economic / resource control', result.matrix.economic],
      ['Normalisation & gaslighting', result.matrix.norm],
    ];
    rows.forEach(([label, value]) => {
      const tr = document.createElement('tr');
      const tdLabel = document.createElement('td');
      const tdValue = document.createElement('td');
      tdLabel.textContent = label;
      const lvl = levelLabel(value);
      tdValue.textContent = lvl.text;
      tdValue.className = `level ${lvl.cls}`;
      tr.appendChild(tdLabel);
      tr.appendChild(tdValue);
      matrixTable.appendChild(tr);
    });

    // Signals
    signalsList.innerHTML = '';
    result.signals.forEach(s => {
      const li = document.createElement('li');
      li.textContent = s;
      signalsList.appendChild(li);
    });

    // Phenotype
    phenotypeList.innerHTML = '';
    result.phenotype.forEach(p => {
      const li = document.createElement('li');
      li.textContent = p;
      phenotypeList.appendChild(li);
    });

    // Debug
    debugBlock.style.display = 'block';
    debugContent.textContent = JSON.stringify(result.debug, null, 2);

    statusText.textContent = 'This narrative has been structurally decoded. Scores are heuristic and meant for demonstration only.';

    analyzeBtn.disabled = false;
    analyzeBtn.querySelector('span').textContent = 'Analyze narrative';
  });

  resetBtn.addEventListener('click', () => {
    narrativeInput.value = '';
    contextSelect.value = 'unspecified';
    clearResults();
  });

  clearResults();
</script>
</body>
</html>
