<!DOCTYPE html>
<html lang="fr" data-page="demo-psycho-forensic">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenProof — Démo psycho-médico-légale | Mécanismes narratifs</title>

  <!-- SEO minimal -->
  <meta name="description"
        content="Démonstration psycho-médico-légale : du récit brut aux schémas de contrôle. Détection déterministe des mécanismes de contrôle coercitif et score d’emprise, sans IA." />
  <link rel="canonical" href="https://rpo.openproof.net/demo-psycho.html" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg-deep: #04040e;
      --bg-elevated: #0b0f14;
      --panel-bg: #fbf6ea;
      --panel-border: #d4af37;
      --panel-shadow: 0 18px 45px rgba(0,0,0,0.65);

      --text-main: #f7f3e8;
      --text-soft: #c9c3b2;
      --text-ink: #3c2f18;

      --accent-gold: #d4af37;
      --accent-gold-soft: #f3e2aa;
      --accent-pill-bg: rgba(212,175,55,0.12);

      --danger: #ff6b6b;
      --warning: #ffb347;
      --safe: #55c37e;

      --font-title: "Orbitron", system-ui, sans-serif;
      --font-body: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;

      --radius-panel: 22px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #111827 0, var(--bg-deep) 55%);
      color: var(--text-main);
      font-family: var(--font-body);
    }

    body {
      min-height: 100vh;
    }

    a {
      color: var(--accent-gold-soft);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* Layout */
    .nav-shell {
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(to bottom,
      rgba(4,4,14,0.95),
      rgba(4,4,14,0.90),
      rgba(4,4,14,0.80));
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(212,175,55,0.18);
    }

    .nav-inner {
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand-lockup {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-medallion {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fdf7df, #e3c771 45%, #8d6b17 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.55), 0 18px 40px rgba(0,0,0,0.7);
    }

    .brand-medallion span {
      font-family: var(--font-title);
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #3f2c09;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text-main {
      font-family: var(--font-title);
      letter-spacing: 0.16em;
      font-size: 13px;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 13px;
    }

    .nav-link {
      color: var(--text-soft);
      text-decoration: none;
      position: relative;
      padding-bottom: 3px;
    }

    .nav-link.active {
      color: var(--accent-gold-soft);
    }
    .nav-link.active::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: 0;
      height: 2px;
      width: 26px;
      border-radius: 999px;
      background: linear-gradient(to right, var(--accent-gold), var(--accent-gold-soft));
    }

    .nav-cta {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.7);
      background: radial-gradient(circle at top, rgba(255,255,255,0.12), rgba(11,15,20,0.95));
      font-size: 12px;
      text-decoration: none;
      color: var(--accent-gold-soft);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .nav-cta span.icon {
      font-size: 13px;
    }

    .page-shell {
      max-width: 1180px;
      margin: 0 auto;
      padding: 26px 18px 60px;
    }

    /* Hero */
    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.6fr);
      gap: 26px;
      align-items: stretch;
      margin-bottom: 40px;
    }

    .hero-main-title {
      font-family: var(--font-title);
      font-size: clamp(28px, 3.1vw, 34px);
      letter-spacing: 0.10em;
      text-transform: uppercase;
      margin-bottom: 14px;
    }

    .hero-main-title span.highlight {
      color: var(--accent-gold-soft);
    }

    .hero-subline {
      font-size: 15px;
      max-width: 520px;
      color: var(--text-soft);
      line-height: 1.6;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 18px 0 12px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.4);
      background: var(--accent-pill-bg);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    .hero-footnote {
      font-size: 12px;
      color: var(--text-soft);
      max-width: 540px;
      line-height: 1.6;
    }

    .hero-panel {
      background: radial-gradient(circle at top left, rgba(255,255,255,0.08), rgba(11,15,20,0.98));
      border-radius: var(--radius-panel);
      border: 1px solid rgba(212,175,55,0.4);
      box-shadow: var(--panel-shadow);
      padding: 18px 20px 20px;
      color: var(--text-main);
    }

    .hero-panel-title {
      font-family: var(--font-title);
      font-size: 13px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hero-panel-tag {
      font-size: 10px;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(212,175,55,0.35);
      letter-spacing: 0.1em;
      color: var(--accent-gold-soft);
    }

    .hero-panel p {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.6;
      margin: 0 0 10px;
    }

    .hero-panel ul {
      padding-left: 18px;
      margin: 8px 0 0;
      color: var(--text-soft);
      font-size: 13px;
    }

    .section-title {
      font-family: var(--font-title);
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 14px;
    }

    /* Panels main */
    .play-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 22px;
      margin-bottom: 26px;
    }

    .panel {
      background: var(--panel-bg);
      border-radius: var(--radius-panel);
      border: 1px solid rgba(212,175,55,0.9);
      box-shadow: var(--panel-shadow);
      padding: 18px 20px 20px;
      color: var(--text-ink);
      position: relative;
    }

    .panel h2 {
      margin: 0 0 10px;
      font-family: var(--font-title);
      font-size: 15px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #816026;
    }

    .panel-sub {
      font-size: 13px;
      color: #7c6b4b;
      margin-bottom: 14px;
      line-height: 1.6;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 5px;
      color: #5e4a23;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    select, textarea, input[type="text"] {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      padding: 9px 11px;
      font-size: 13px;
      font-family: var(--font-body);
      background: rgba(255,255,255,0.9);
      color: #222;
      outline: none;
    }
    select:focus, textarea:focus, input[type="text"]:focus {
      border-color: rgba(212,175,55,0.8);
      box-shadow: 0 0 0 1px rgba(212,175,55,0.4);
    }

    textarea {
      min-height: 150px;
      resize: vertical;
      line-height: 1.5;
    }

    .input-tip {
      font-size: 11px;
      color: #948361;
      margin-top: 6px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      font-family: var(--font-body);
      padding: 8px 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.07s ease, box-shadow 0.07s ease, background 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at top, #f9e6a6, #d4af37);
      color: #3b2903;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(0,0,0,0.32);
    }

    .btn-secondary {
      background: #f5eddb;
      color: #604b22;
      border: 1px solid rgba(0,0,0,0.12);
    }
    .btn-secondary:hover {
      background: #f0e3cc;
    }

    .btn-ghost {
      background: transparent;
      color: #7a6330;
      border: 1px dashed rgba(122,99,48,0.65);
    }
    .btn-ghost:hover {
      background: rgba(251,245,229,0.8);
    }

    .btn .icon {
      font-size: 14px;
    }

    /* Results */
    .score-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .score-pill {
      flex: 1 1 140px;
      background: #f7efdd;
      border-radius: 14px;
      padding: 8px 10px 9px;
      border: 1px solid rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .score-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #7b6432;
    }

    .score-value {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .score-value span.unit {
      font-size: 12px;
      color: #8b7a55;
    }

    .score-tag {
      font-size: 11px;
      font-weight: 500;
    }

    .score-tag.safe { color: var(--safe); }
    .score-tag.warn { color: var(--warning); }
    .score-tag.danger { color: var(--danger); }

    .mechanisms-list {
      font-size: 13px;
      margin: 8px 0 12px;
      padding-left: 18px;
    }

    .mechanisms-list li {
      margin-bottom: 3px;
    }

    .matrix-grid {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #faf1dd;
      overflow: hidden;
    }

    .matrix-row {
      display: grid;
      grid-template-columns: 1.8fr 1fr;
      font-size: 12px;
      padding: 7px 10px;
      border-top: 1px solid rgba(0,0,0,0.05);
      align-items: center;
    }
    .matrix-row:first-child {
      border-top: none;
    }

    .matrix-axis {
      color: #5c4620;
    }

    .matrix-level {
      justify-self: end;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fdf7ea;
    }
    .matrix-level.none {
      color: #7d7d7d;
    }
    .matrix-level.low {
      color: #a97620;
    }
    .matrix-level.high {
      color: #b52121;
    }

    .signals-list, .phenotype-block {
      font-size: 13px;
      color: #6a5531;
      margin-top: 10px;
      line-height: 1.55;
    }

    .signals-list ul {
      margin: 4px 0 0 16px;
      padding: 0;
    }

    .highlighted-text {
      margin-top: 12px;
      font-size: 13px;
      line-height: 1.6;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f9f0de;
      max-height: 180px;
      overflow-y: auto;
      border: 1px dashed rgba(0,0,0,0.12);
    }

    .highlighted-text mark {
      background: #ffe9a5;
      border-radius: 4px;
      padding: 0 1px;
      box-shadow: 0 0 0 1px rgba(212,175,55,0.3);
    }

    /* Bottom CTA */
    .bottom-cta {
      margin-top: 26px;
      background: radial-gradient(circle at top left,
        rgba(253,246,227,0.06),
        rgba(12,12,18,0.96));
      border-radius: 20px;
      border: 1px solid rgba(212,175,55,0.45);
      padding: 18px 20px 16px;
      color: var(--text-main);
      display: grid;
      grid-template-columns: minmax(0, 2.4fr) minmax(0, 1.4fr);
      gap: 14px;
      align-items: center;
    }

    .bottom-cta-title {
      font-family: var(--font-title);
      font-size: 14px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .bottom-cta-text {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.6;
    }

    .bottom-cta button,
    .bottom-cta a.btn-primary-link {
      text-decoration: none;
    }

    .btn-primary-link {
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at top, #f9e6a6, #d4af37);
      color: #3b2903;
      padding: 9px 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 12px 32px rgba(0,0,0,0.45);
    }

    .btn-primary-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 36px rgba(0,0,0,0.5);
    }

    .cta-disclaimer {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .demo-disclaimer {
      margin-top: 12px;
      font-size: 11px;
      color: #8f7f65;
      text-align: right;
    }

    @media (max-width: 900px) {
      .hero-grid,
      .play-grid,
      .bottom-cta {
        grid-template-columns: minmax(0, 1fr);
      }

      .bottom-cta {
        text-align: left;
      }
    }
  </style>
</head>
<body>

<header class="nav-shell">
  <div class="nav-inner">
    <div class="brand-lockup">
      <div class="brand-medallion">
        <span>RPO</span>
      </div>
      <div class="brand-text">
        <div class="brand-text-main">OPENPROOF — RPO v0.1</div>
        <div class="brand-text-sub">JSON signé · PDF lisible par l’humain · Hachage public</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">Aperçu</a>
      <a href="specification.html" class="nav-link">Spécification</a>
      <a href="examples.html" class="nav-link">Exemples</a>
      <a href="tests.html" class="nav-link">Tests</a>
      <a href="playground.html" class="nav-link">Aire de jeux</a>
      <a href="demo-psycho.html" class="nav-link active">Démonstration psycho-légale</a>
      <a href="https://github.com/openproof-net/rpo-spec-v0.1"
         class="nav-cta" target="_blank" rel="noopener noreferrer">
        <span class="icon">↗</span><span>Voir sur GitHub</span>
      </a>
    </nav>
  </div>
</header>

<main class="page-shell">
  <!-- HERO -->
  <section class="hero-grid">
    <div>
      <div class="section-title">Couche de démonstration RPO · Mécanismes narratifs</div>
      <h1 class="hero-main-title">
        Essayez la démo <span class="highlight">psycho-médico-légale</span> — du récit brut aux schémas narratifs
      </h1>
      <p class="hero-subline">
        Saisissez un court récit évoquant une situation de contrôle potentiel
        (domestique, professionnel ou en ligne). Cette démonstration détecte les
        mécanismes structurels de contrôle, estime un score approximatif d’emprise
        et révèle le <strong>phénotype narratif</strong>. Tout s’exécute localement
        dans votre navigateur, sans aucun modèle d’IA.
      </p>
      <div class="chip-row">
        <div class="chip">Basé sur des modèles</div>
        <div class="chip">Détermination sans IA</div>
        <div class="chip">Contrôle coercitif</div>
        <div class="chip">Couche narrative compatible RPO</div>
      </div>
      <p class="hero-footnote">
        Dans le pilote scientifique CNRS × TruthX, cette couche sera alimentée par des
        modules psycho-forensiques avancés capables d’intégrer directement des jeux de
        messages, des rapports et des transcriptions. Ici, vous voyez une
        <strong>démo simplifiée et transparente</strong> qui met déjà en évidence des
        schémas structurés de contrôle.
      </p>
    </div>

    <aside class="hero-panel">
      <div class="hero-panel-title">
        Ce que cette démo illustre
        <span class="hero-panel-tag">Version de démonstration</span>
      </div>
      <p>
        Cette page simule la couche psycho-médico-légale qui peut se
        superposer à la norme RPO&nbsp;:
      </p>
      <ul>
        <li>Détection de mécanismes de contrôle (verrouillage, menaces, surveillance, normalisation).</li>
        <li>Inscription dans une mini-matrice de contrôle coercitif.</li>
        <li>Estimation d’un score d’emprise et d’un niveau de risque.</li>
        <li>Mise en évidence de <strong>signaux faibles</strong> et d’un phénotype narratif.</li>
      </ul>
      <p style="margin-top:10px;">
        Ce n’est pas une évaluation juridique, clinique ou policière. Il s’agit d’un
        <strong>décodage narratif structuré</strong>, construit pour la recherche et la
        pédagogie autour du contrôle coercitif.
      </p>
    </aside>
  </section>

  <!-- PLAYGROUND -->
  <section>
    <div class="section-title">Jouez avec un récit</div>
    <div class="play-grid">
      <!-- INPUT PANEL -->
      <div class="panel">
        <h2>1. Récit d’entrée</h2>
        <p class="panel-sub">
          Rédigez un court récit (1 à 3 paragraphes). Les noms peuvent être anonymisés.
          L’objectif est d’observer la structure de contrôle, et non de porter un jugement
          sur l’affaire.
        </p>

        <div style="margin-bottom:10px;">
          <label for="contextSelect">Contexte</label>
          <select id="contextSelect">
            <option value="generic">Non spécifié / générique</option>
            <option value="intimate">Relation intime / domestique</option>
            <option value="work">Lieu de travail / gestion</option>
            <option value="institutional" selected>Institutionnel / administratif</option>
            <option value="online">En ligne / numérique</option>
          </select>
        </div>

        <div>
          <label for="narrativeInput">Récit (texte libre)</label>
          <textarea id="narrativeInput" placeholder="Décrivez ce qui s’est passé, avec vos propres mots. Qui a fait quoi, quand, où et comment cela vous a-t-il affecté, vous ou les autres ?"></textarea>
          <p class="input-tip">
            Conseil&nbsp;: incluez au moins une action concrète, un repère temporel et toutes les menaces,
            justifications ou contraintes dont vous vous souvenez.
          </p>
        </div>

        <div class="button-row">
          <button class="btn btn-primary" id="analyzeBtn">
            <span class="icon">➜</span>Analyser le récit
          </button>
          <button class="btn btn-secondary" id="resetBtn">
            Réinitialiser
          </button>
          <button class="btn btn-ghost" id="exampleBtn">
            <span class="icon">★</span>Charger un exemple
          </button>
        </div>
      </div>

      <!-- RESULT PANEL -->
      <div class="panel">
        <h2>2. Superposition psycho-médico-légale</h2>
        <p class="panel-sub">
          Collez un texte narratif à gauche et cliquez sur «&nbsp;Analyser&nbsp;» pour
          révéler les schémas structurés de contrôle.
        </p>

        <!-- Scores -->
        <div class="score-row">
          <div class="score-pill">
            <div class="score-label">Score d’emprise (approx.)</div>
            <div class="score-value" id="holdScoreValue">
              0<span class="unit">/100</span>
            </div>
            <div class="score-tag safe" id="holdScoreTag">Aucun signal structuré détecté</div>
          </div>
          <div class="score-pill">
            <div class="score-label">Risque immédiat (narratif)</div>
            <div class="score-value" id="riskScoreValue">
              0<span class="unit">/100</span>
            </div>
            <div class="score-tag safe" id="riskScoreTag">Pas de menace explicite dans le récit</div>
          </div>
        </div>

        <!-- Mechanisms -->
        <div>
          <label>Mécanismes détectés</label>
          <ul class="mechanisms-list" id="mechanismsList">
            <li>Aucun mécanisme détecté pour l’instant.</li>
          </ul>
        </div>

        <!-- Matrix -->
        <div>
          <label>Matrice de contrôle coercitif</label>
          <div class="matrix-grid" id="matrixGrid">
            <!-- rows generated by JS -->
          </div>
        </div>

        <!-- Signals -->
        <div class="signals-list" id="signalsBlock">
          <strong>Signaux à surveiller</strong><br/>
          Aucuns signaux faibles tant qu’aucun récit n’a été analysé.
        </div>

        <!-- Phenotype -->
        <div class="phenotype-block" id="phenotypeBlock">
          <strong>Phénotype narratif</strong><br/>
          Le profil narratif sera résumé ici après l’analyse (ex.&nbsp;: contrôle coercitif
          domestique, management intimidant, harcèlement institutionnel, etc.).
        </div>

        <!-- Highlighted narrative -->
        <div class="highlighted-text" id="highlightedNarrative" aria-label="Texte analysé avec surlignage">
          Le récit surligné apparaîtra ici, avec les passages sensibles mis en évidence.
        </div>
      </div>
    </div>

    <p class="demo-disclaimer">
      Cette logique de démonstration est heuristique et volontairement conservative.
      Elle met simplement en lumière des schémas de contrôle possibles à partir du texte fourni.
    </p>
  </section>

  <!-- CTA BOTTOM -->
  <section class="bottom-cta">
    <div>
      <div class="bottom-cta-title">Vous êtes face à un cas réel&nbsp;?</div>
      <p class="bottom-cta-text">
        Cette page montre un <strong>décodage narratif démonstratif</strong>. Dans la version
        scientifique / CNRS, la couche psycho-forensique est couplée à la norme RPO, à des
        graphes temporels et à une lecture juridique structurée. Si vous souhaitez tester ces
        modules avancés sur des cas réels, vous pouvez demander l’accès au
        <strong>projet pilote CNRS × TruthX</strong>.
      </p>
    </div>
    <div>
      <a class="btn-primary-link"
         href="https://www.truthx.co/truthx-pilote-form"
         target="_blank"
         rel="noopener noreferrer">
        <span class="icon">⚖︎</span>
        <span>Postuler pour le projet pilote CNRS</span>
      </a>
      <div class="cta-disclaimer">
        Cette démonstration n’est pas un avis juridique ni un diagnostic clinique.
        Elle ne remplace pas un accompagnement spécialisé.
      </div>
    </div>
  </section>
</main>

<script>
  // --- Axes et motifs déterministes ----------------------------------------

  const AXES = [
    {
      id: "isolation",
      label: "Isolement / confinement",
      patterns: [
        "locked me in", "locked me into", "m'a enfermé", "m’a enfermé",
        "barred the door", "blocked the door", "m'empêchait de sortir", "m’empechait de sortir",
        "confined me", "kept me in the room", "no one needed to hear from me tonight"
      ]
    },
    {
      id: "surveillance",
      label: "Surveillance et suspicion",
      patterns: [
        "checking my phone", "checked my phone", "surveillait mon téléphone",
        "watching my messages", "accusing me of hiding conversations",
        "demanded passwords", "wanted my passwords", "demandait mes codes",
        "monitoring", "track my location", "me suivait partout"
      ]
    },
    {
      id: "communications",
      label: "Contrôle des communications",
      patterns: [
        "took my phone", "took my phone away", "a pris mon téléphone",
        "deleted messages", "deleted my messages", "forbade me to call",
        "m'interdisait d'appeler", "m interdisait d appeler",
        "no one needed to hear from me", "blocked my contacts"
      ]
    },
    {
      id: "threats",
      label: "Menaces et sanctions",
      patterns: [
        "threatened to", "threatened me", "a menacé de",
        "would take the car keys", "take the car keys",
        "raise his voice", "shouted at me", "criait sur moi",
        "punish me", "me punirait", "you will pay for this",
        "hit me", "pushed me", "slapped me", "m'a frappé", "m’a frappe"
      ]
    },
    {
      id: "economic",
      label: "Contrôle économique / des ressources",
      patterns: [
        "all my bank notifications", "my bank notifications",
        "access to my account", "blocked my account",
        "contrôle de l'argent", "contrôle de mes finances",
        "took my salary", "kept my card", "kept my bank card"
      ]
    },
    {
      id: "normalisation",
      label: "Normalisation et pression mentale",
      patterns: [
        "normal for couples", "normal for a couple",
        "everyone does that", "tous les couples font ça", "c'est normal",
        "i was overreacting", "you are too sensitive", "trop sensible",
        "i was crazy", "i was imagining things", "gaslighting"
      ]
    }
  ];

  const ACUTE_KEYWORDS = [
    "locked", "enfermé", "threatened", "menacé", "hit", "frappé",
    "no one needed to hear from me", "take the car keys", "keys if i",
    "you will pay for this"
  ];

  // Initialisation de la matrice visuelle
  const matrixGrid = document.getElementById("matrixGrid");

  function initMatrix() {
    matrixGrid.innerHTML = "";
    AXES.forEach(axis => {
      const row = document.createElement("div");
      row.className = "matrix-row";
      row.dataset.axisId = axis.id;

      const axisDiv = document.createElement("div");
      axisDiv.className = "matrix-axis";
      axisDiv.textContent = axis.label;

      const levelDiv = document.createElement("div");
      levelDiv.className = "matrix-level none";
      levelDiv.textContent = "Aucun pour l’instant";

      row.appendChild(axisDiv);
      row.appendChild(levelDiv);
      matrixGrid.appendChild(row);
    });
  }

  initMatrix();

  // --- Analyse -------------------------------------------------------------

  const narrativeInput = document.getElementById("narrativeInput");
  const contextSelect = document.getElementById("contextSelect");
  const mechanismsList = document.getElementById("mechanismsList");
  const holdScoreValue = document.getElementById("holdScoreValue");
  const holdScoreTag = document.getElementById("holdScoreTag");
  const riskScoreValue = document.getElementById("riskScoreValue");
  const riskScoreTag = document.getElementById("riskScoreTag");
  const signalsBlock = document.getElementById("signalsBlock");
  const phenotypeBlock = document.getElementById("phenotypeBlock");
  const highlightedNarrative = document.getElementById("highlightedNarrative");

  document.getElementById("analyzeBtn").addEventListener("click", () => {
    const text = (narrativeInput.value || "").trim();
    if (!text) {
      alert("Veuillez saisir un court récit avant de lancer l’analyse.");
      return;
    }
    runAnalysis(text, contextSelect.value);
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    narrativeInput.value = "";
    contextSelect.value = "generic";
    initMatrix();
    mechanismsList.innerHTML = "<li>Aucun mécanisme détecté pour l’instant.</li>";
    holdScoreValue.innerHTML = "0<span class='unit'>/100</span>";
    holdScoreTag.textContent = "Aucun signal structuré détecté";
    holdScoreTag.className = "score-tag safe";

    riskScoreValue.innerHTML = "0<span class='unit'>/100</span>";
    riskScoreTag.textContent = "Pas de menace explicite dans le récit";
    riskScoreTag.className = "score-tag safe";

    signalsBlock.innerHTML =
      "<strong>Signaux à surveiller</strong><br/>" +
      "Aucuns signaux faibles tant qu’aucun récit n’a été analysé.";
    phenotypeBlock.innerHTML =
      "<strong>Phénotype narratif</strong><br/>" +
      "Le profil narratif sera résumé ici après l’analyse.";
    highlightedNarrative.textContent =
      "Le récit surligné apparaîtra ici, avec les passages sensibles mis en évidence.";
  });

  document.getElementById("exampleBtn").addEventListener("click", () => {
    // Exemple conjugal – structure type contrôle coercitif
    const example = "On Saturday 12 February, around 9 pm, he locked me in the living room for almost two hours after I refused to cancel a dinner with my sister. He stood in front of the door, took my phone and said that no one needed to hear from me tonight. Two days later, on Monday, he woke me up at 5:30 am accusing me of hiding conversations from him because I didn’t leave my phone charging in the kitchen as he demanded. Last week, he also threatened to take the car keys if I didn’t give him all my bank notifications, saying it was normal for couples to share everything.";
    narrativeInput.value = example;
    contextSelect.value = "intimate";
    runAnalysis(example, "intimate");
  });

  function runAnalysis(text, context) {
    const lower = text.toLowerCase();

    const hitsByAxis = {};
    const matchedSegments = [];

    AXES.forEach(axis => {
      hitsByAxis[axis.id] = 0;
      axis.patterns.forEach(pattern => {
        const p = pattern.toLowerCase();
        let index = lower.indexOf(p);
        while (index !== -1) {
          hitsByAxis[axis.id]++;
          matchedSegments.push({ start: index, end: index + p.length });
          index = lower.indexOf(p, index + p.length);
        }
      });
    });

    // Fusion crude des segments pour le surlignage
    const merged = mergeSegments(matchedSegments);
    const highlighted = buildHighlightedText(text, merged);
    highlightedNarrative.innerHTML = highlighted;

    // Liste des mécanismes détectés
    const activeAxes = Object.entries(hitsByAxis).filter(([_, count]) => count > 0);
    if (activeAxes.length === 0) {
      mechanismsList.innerHTML =
        "<li>Aucun motif de contrôle explicite détecté. " +
        "Cela ne signifie pas qu’il n’y a pas d’emprise, seulement que ce court extrait ne la rend pas visible.</li>";
    } else {
      mechanismsList.innerHTML = "";
      activeAxes.forEach(([axisId, count]) => {
        const axis = AXES.find(a => a.id === axisId);
        const li = document.createElement("li");
        li.textContent = `${axis.label} · ${count} indice(s) lexical(aux)`;
        mechanismsList.appendChild(li);
      });
    }

    // Mise à jour de la matrice (aucun / présent / fort)
    updateMatrix(hitsByAxis);

    // Scores d’emprise et de risque
    const totalAxes = AXES.length;
    const nbAxesActive = activeAxes.length;
    const totalHits = Object.values(hitsByAxis).reduce((a, b) => a + b, 0);

    // Score d’emprise: base sur nombre d’axes + volume d’indices
    let holdScore = Math.round((nbAxesActive / totalAxes) * 60 + Math.min(totalHits * 6, 40));
    holdScore = clamp(holdScore, 0, 100);

    // Ajustement léger selon le contexte
    if (context === "intimate" || context === "work") {
      holdScore = Math.min(100, Math.round(holdScore * 1.1));
    }

    // Score de risque immédiat: basé sur menaces / enfermement / violence
    let acuteHits = 0;
    const lowerNoAccents = lower; // simplification

    ACUTE_KEYWORDS.forEach(keyword => {
      const k = keyword.toLowerCase();
      let idx = lowerNoAccents.indexOf(k);
      while (idx !== -1) {
        acuteHits++;
        idx = lowerNoAccents.indexOf(k, idx + k.length);
      }
    });

    let riskScore = Math.round(acuteHits * 18);
    if (hitsByAxis["threats"] >= 2 || hitsByAxis["isolation"] >= 2) {
      riskScore += 20;
    }
    riskScore = clamp(riskScore, 0, 100);

    // Mise à jour UI scores
    holdScoreValue.innerHTML = `${holdScore}<span class="unit">/100</span>`;
    riskScoreValue.innerHTML = `${riskScore}<span class="unit">/100</span>`;

    if (holdScore < 30) {
      holdScoreTag.textContent = "Structure d’emprise peu marquée dans cet extrait isolé.";
      holdScoreTag.className = "score-tag safe";
    } else if (holdScore < 65) {
      holdScoreTag.textContent = "Plusieurs axes de contrôle apparaissent ; à surveiller dans la durée.";
      holdScoreTag.className = "score-tag warn";
    } else {
      holdScoreTag.textContent = "Structure d’emprise forte : plusieurs axes convergent dans ce récit.";
      holdScoreTag.className = "score-tag danger";
    }

    if (riskScore < 20) {
      riskScoreTag.textContent = "Pas de menace explicite dans ce court extrait.";
      riskScoreTag.className = "score-tag safe";
    } else if (riskScore < 60) {
      riskScoreTag.textContent = "Présence de menaces ou de contraintes ; risque à contextualiser.";
      riskScoreTag.className = "score-tag warn";
    } else {
      riskScoreTag.textContent = "Signaux de risque aigu (menaces, enfermement, sanctions). Nécessite une vigilance immédiate.";
      riskScoreTag.className = "score-tag danger";
    }

    // Signaux faibles
    const weakSignals = Object.entries(hitsByAxis)
      .filter(([_, count]) => count === 1)
      .map(([axisId]) => AXES.find(a => a.id === axisId).label);

    if (weakSignals.length === 0 && activeAxes.length === 0) {
      signalsBlock.innerHTML =
        "<strong>Signaux à surveiller</strong><br/>" +
        "Aucun signal lexical particulier n’a été relevé dans ce court extrait.";
    } else {
      let html = "<strong>Signaux à surveiller</strong><br/>";
      if (weakSignals.length > 0) {
        html += "Axes apparaissant une seule fois (à suivre dans le temps)&nbsp;:";
        html += "<ul>";
        weakSignals.forEach(label => {
          html += `<li>${label}</li>`;
        });
        html += "</ul>";
      } else {
        html += "Les axes détectés se répètent déjà : le contrôle semble structuré plutôt que ponctuel.";
      }
      signalsBlock.innerHTML = html;
    }

    // Phénotype narratif
    phenotypeBlock.innerHTML = `<strong>Phénotype narratif</strong><br/>${buildPhenotype(hitsByAxis, context)}`;
  }

  function updateMatrix(hitsByAxis) {
    Array.from(matrixGrid.children).forEach(row => {
      const axisId = row.dataset.axisId;
      const levelDiv = row.querySelector(".matrix-level");
      const hits = hitsByAxis[axisId] || 0;

      if (hits === 0) {
        levelDiv.textContent = "Aucun pour l’instant";
        levelDiv.className = "matrix-level none";
      } else if (hits === 1) {
        levelDiv.textContent = "Présent, 1 indice";
        levelDiv.className = "matrix-level low";
      } else {
        levelDiv.textContent = `Fort, ${hits} indices`;
        levelDiv.className = "matrix-level high";
      }
    });
  }

  function buildPhenotype(hitsByAxis, context) {
    const intlAxes = {
      isolation: hitsByAxis["isolation"] || 0,
      surveillance: hitsByAxis["surveillance"] || 0,
      communications: hitsByAxis["communications"] || 0,
      threats: hitsByAxis["threats"] || 0,
      economic: hitsByAxis["economic"] || 0,
      normalisation: hitsByAxis["normalisation"] || 0
    };

    const active = Object.values(intlAxes).some(v => v > 0);
    if (!active) {
      return "Aucun profil net ne se dégage sur la base de cet extrait isolé. Un récit plus long ou des pièces complémentaires seraient nécessaires.";
    }

    const strongAxes = Object.entries(intlAxes)
      .filter(([_, v]) => v >= 2)
      .map(([id]) => id);

    const hasCoreCoercive =
      intlAxes.isolation > 0 &&
      (intlAxes.surveillance > 0 || intlAxes.communications > 0) &&
      intlAxes.threats > 0;

    if (hasCoreCoercive && context === "intimate") {
      return "Le récit correspond à un schéma typique de contrôle coercitif en contexte intime : " +
        "épisodes d’isolement, surveillance des communications, menaces ou sanctions répétées. " +
        "Dans une évaluation complète, ce type de profil justifierait une attention prioritaire.";
    }

    if (context === "work" && (intlAxes.threats > 0 || intlAxes.normalisation > 0)) {
      return "Le profil évoque un management coercitif : usage de menaces, pression normative " +
        "et possible disqualification progressive. Dans un cadre RH, ce type de dynamique peut " +
        "alimenter des situations de harcèlement moral ou institutionnel.";
    }

    if (context === "institutional" && intlAxes.normalisation > 0) {
      return "Le récit laisse apparaître une forme de contrôle institutionnel : " +
        "normalisation de pratiques contestables, renversement de la responsabilité " +
        "et dilution des menaces dans des procédures apparemment neutres.";
    }

    if (intlAxes.economic > 0 && context === "intimate") {
      return "Le contrôle économique est au cœur de ce récit, combiné à d’autres signaux " +
        "d’emprise. Ce type de profil est fréquent dans les situations d’emprise domestique " +
        "où la dépendance financière renforce le verrouillage psychologique.";
    }

    if (strongAxes.length >= 3) {
      return "Plusieurs axes de contrôle apparaissent simultanément, ce qui suggère " +
        "une structure d’emprise multi-dimensionnelle plutôt qu’un conflit isolé.";
    }

    return "Des éléments de contrôle apparaissent mais le profil reste partiel. " +
      "La dynamique pourrait être précisée par des récits supplémentaires " +
      "ou d’autres types de pièces (messages, emails, décisions formelles).";
  }

  function mergeSegments(segments) {
    if (!segments.length) return [];
    const sorted = segments.sort((a, b) => a.start - b.start);
    const merged = [sorted[0]];

    for (let i = 1; i < sorted.length; i++) {
      const last = merged[merged.length - 1];
      const current = sorted[i];
      if (current.start <= last.end) {
        last.end = Math.max(last.end, current.end);
      } else {
        merged.push({ start: current.start, end: current.end });
      }
    }
    return merged;
  }

  function buildHighlightedText(text, segments) {
    if (!segments.length) return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    let result = "";
    let cursor = 0;

    segments.forEach(seg => {
      const safeStart = Math.max(0, Math.min(seg.start, text.length));
      const safeEnd = Math.max(0, Math.min(seg.end, text.length));
      if (safeStart > cursor) {
        result += escapeHtml(text.slice(cursor, safeStart));
      }
      result += "<mark>" + escapeHtml(text.slice(safeStart, safeEnd)) + "</mark>";
      cursor = safeEnd;
    });

    if (cursor < text.length) {
      result += escapeHtml(text.slice(cursor));
    }
    return result;
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
  }
</script>

</body>
</html>

